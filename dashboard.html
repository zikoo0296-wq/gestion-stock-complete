<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Pro - Gestion Compl√®te</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal img {
            max-width: 100%;
            border-radius: 10px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        #imageZoomModal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        #imageZoomModal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
        }

        .image-caption {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ Stock Pro</h1>
            <p>Gestion Compl√®te de Stock</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('products')">üì¶ Produits</button>
            <button class="tab" onclick="switchTab('movements')">üîÑ Mouvements</button>
            <button class="tab" onclick="switchTab('history')">üìú Historique</button>
            <button class="tab" onclick="switchTab('pdv')">üè™ Points de Vente</button>
            <button class="tab" onclick="switchTab('transfer')">üöö Transferts</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2>üìä Tableau de Bord</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Produits</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Stock Total</h3>
                    <div class="value" id="totalStock">0</div>
                </div>
                <div class="stat-card">
                    <h3>Mouvements</h3>
                    <div class="value" id="totalMovements">0</div>
                </div>
                <div class="stat-card">
                    <h3>Points de Vente</h3>
                    <div class="value" id="totalPdv">2</div>
                </div>
            </div>
        </div>

        <!-- Produits -->
        <div id="products" class="tab-content">
            <h2>üì¶ Gestion des Produits</h2>
            
            <div class="search-box">
                <input type="text" id="searchProduct" placeholder="üîç Rechercher un produit..." oninput="searchProducts()">
            </div>

            <button class="btn btn-primary" onclick="showAddProductForm()">‚ûï Nouveau Produit</button>
            <button class="btn btn-success" onclick="exportToExcel()">üì• Exporter Excel</button>
            <button class="btn btn-info" onclick="document.getElementById('importFile').click()">üì§ Importer Excel</button>
            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none" onchange="importFromExcel(event)">

            <div id="productFormDiv" style="display:none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3 id="formTitle">‚ûï Ajouter un Produit</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>R√©f√©rence *</label>
                        <input type="text" id="productRef" class="form-input" placeholder="REF001">
                    </div>
                    <div class="form-group">
                        <label>Nom R√©el *</label>
                        <input type="text" id="productName" class="form-input" placeholder="Nom du produit">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>D√©signation *</label>
                        <input type="text" id="productDesignation" class="form-input" placeholder="Description">
                    </div>
                    <div class="form-group">
                        <label>R√©p√©tition</label>
                        <input type="text" id="productRepetition" class="form-input" placeholder="R√©p√©tition">
                    </div>
                </div>
                <div class="form-group">
                    <label>URL Image (Google Drive)</label>
                    <input type="text" id="productImage" class="form-input" placeholder="https://drive.google.com/uc?export=view&id=...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantit√© Totale</label>
                        <input type="number" id="productQty" class="form-input" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Al Baraka</label>
                        <input type="number" id="productBaraka" class="form-input" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Alghafla</label>
                        <input type="number" id="productGhafla" class="form-input" value="0" min="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveProduct()">üíæ Enregistrer</button>
                <button class="btn btn-danger" onclick="cancelProductForm()">‚ùå Annuler</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>R√©f√©rence</th>
                        <th>Nom R√©el</th>
                        <th>D√©signation</th>
                        <th>R√©p√©tition</th>
                        <th>Image</th>
                        <th>QTY Total</th>
                        <th>Al Baraka</th>
                        <th>Alghafla</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productList"></tbody>
            </table>
        </div>

        <!-- Mouvements -->
        <div id="movements" class="tab-content">
            <h2>üîÑ Enregistrer un Mouvement</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Type de Mouvement *</label>
                        <select id="movementType" class="form-select">
                            <option value="Entr√©e">üì• Entr√©e (Ajout de stock)</option>
                            <option value="Sortie">üì§ Sortie (Retrait de stock)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Point de Vente *</label>
                        <select id="movementPdv" class="form-select">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Al Baraka">Al Baraka</option>
                            <option value="Alghafla">Alghafla</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mode de Paiement *</label>
                        <select id="movementPayment" class="form-select">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Esp√®ce">üíµ Esp√®ce</option>
                            <option value="Virement">üè¶ Virement</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Produit *</label>
                    <select id="movementProduct" class="form-select">
                        <option value="">-- S√©lectionner un produit --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantit√© *</label>
                    <input type="number" id="movementQty" class="form-input" min="1" placeholder="Quantit√©">
                </div>

                <div class="form-group">
                    <label>Remarque</label>
                    <textarea id="movementNote" class="form-input" rows="3" placeholder="Remarque optionnelle..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="saveMovement()">üíæ Enregistrer le Mouvement</button>
            </div>
        </div>

        <!-- Historique -->
        <div id="history" class="tab-content">
            <h2>üìú Historique des Mouvements</h2>
            
            <div class="filter-section">
                <div class="filter-row">
                    <div class="form-group">
                        <label>üîç Recherche</label>
                        <input type="text" id="histSearch" class="form-input" placeholder="Produit, PDV..." oninput="filtHist()">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Date</label>
                        <input type="date" id="histDate" class="form-input" onchange="filtHist()">
                    </div>
                    <div class="form-group">
                        <label>üìÜ Mois</label>
                        <input type="month" id="histMonth" class="form-input" onchange="filtHist()">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Ann√©e</label>
                        <input type="number" id="histYear" class="form-input" placeholder="2024" onchange="filtHist()">
                    </div>
                </div>
                <button class="btn btn-warning" onclick="clearHistFilters()">üîÑ R√©initialiser les filtres</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Produit</th>
                        <th>Quantit√©</th>
                        <th>Point de Vente</th>
                        <th>Mode Paiement</th>
                        <th>Remarque</th>
                    </tr>
                </thead>
                <tbody id="historyList"></tbody>
            </table>
        </div>

        <!-- Points de Vente -->
        <div id="pdv" class="tab-content">
            <h2>üè™ Points de Vente</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>Point de Vente</th>
                        <th>Stock Total</th>
                        <th>Nombre de Produits</th>
                    </tr>
                </thead>
                <tbody id="pdvList"></tbody>
            </table>
        </div>

        <!-- Transferts -->
        <div id="transfer" class="tab-content">
            <h2>üöö Transfert entre Points de Vente</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Source *</label>
                        <select id="transferSource" class="form-select">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Al Baraka">Al Baraka</option>
                            <option value="Alghafla">Alghafla</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Destination *</label>
                        <select id="transferDest" class="form-select">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Al Baraka">Al Baraka</option>
                            <option value="Alghafla">Alghafla</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Produit *</label>
                    <select id="transferProduct" class="form-select">
                        <option value="">-- S√©lectionner un produit --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantit√© *</label>
                    <input type="number" id="transferQty" class="form-input" min="1" placeholder="Quantit√© √† transf√©rer">
                </div>

                <button class="btn btn-primary" onclick="saveTransfer()">üöö Effectuer le Transfert</button>
            </div>
        </div>
    </div>

    <!-- Modal Zoom Image -->
    <div id="imageZoomModal" onclick="closeImageZoom()">
        <span class="close-modal" style="position: absolute; top: 20px; right: 40px; font-size: 40px; color: white; cursor: pointer;">&times;</span>
        <img id="zoomedImage" alt="Image agrandie">
        <div class="image-caption" id="imageCaption"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let products = [];
        let movements = [];
        let searchTerm = '';
        let editingProductId = null;
        const pdvs = [
            { name: 'Al Baraka', id: 'albaraka' },
            { name: 'Alghafla', id: 'alghafla' }
        ];

        // Chargement initial
        window.onload = function() {
            loadData();
            updateDashboard();
            renderProducts();
            renderHistory();
            renderPdv();
            updateMovementProductSelect();
            updateTransferProductSelect();
        };

        function loadData() {
            const saved = localStorage.getItem('stockProData');
            if (saved) {
                const data = JSON.parse(saved);
                products = data.products || [];
                movements = data.movements || [];
            }
        }

        function saveData() {
            localStorage.setItem('stockProData', JSON.stringify({
                products,
                movements
            }));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'products') renderProducts();
            if (tabName === 'history') renderHistory();
            if (tabName === 'pdv') renderPdv();
        }

        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalStock').textContent = products.reduce((sum, p) => sum + p.quantity, 0);
            document.getElementById('totalMovements').textContent = movements.length;
        }

        function showAddProductForm() {
            document.getElementById('productFormDiv').style.display = 'block';
            document.getElementById('formTitle').textContent = '‚ûï Ajouter un Produit';
            editingProductId = null;
            clearProductForm();
        }

        function cancelProductForm() {
            document.getElementById('productFormDiv').style.display = 'none';
            clearProductForm();
            editingProductId = null;
        }

        function clearProductForm() {
            document.getElementById('productRef').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productDesignation').value = '';
            document.getElementById('productRepetition').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('productQty').value = 0;
            document.getElementById('productBaraka').value = 0;
            document.getElementById('productGhafla').value = 0;
        }

        function saveProduct() {
            const ref = document.getElementById('productRef').value.trim();
            const name = document.getElementById('productName').value.trim();
            const designation = document.getElementById('productDesignation').value.trim();
            const repetition = document.getElementById('productRepetition').value.trim();
            const imageUrl = document.getElementById('productImage').value.trim();
            const qty = parseInt(document.getElementById('productQty').value) || 0;
            const baraka = parseInt(document.getElementById('productBaraka').value) || 0;
            const ghafla = parseInt(document.getElementById('productGhafla').value) || 0;

            if (!ref || !name || !designation) {
                alert('‚ùå Veuillez remplir les champs obligatoires (R√©f√©rence, Nom, D√©signation)');
                return;
            }

            const product = {
                id: editingProductId || Date.now(),
                reference: ref,
                realName: name,
                designation: designation,
                repetition: repetition,
                imageUrl: imageUrl,
                quantity: qty,
                pdvStock: {
                    albaraka: baraka,
                    alghafla: ghafla
                }
            };

            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                products[index] = product;
            } else {
                products.push(product);
            }

            saveData();
            renderProducts();
            updateMovementProductSelect();
            updateTransferProductSelect();
            updateDashboard();
            cancelProductForm();
            alert('‚úÖ Produit enregistr√© avec succ√®s !');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Modifier le Produit';
            document.getElementById('productRef').value = product.reference;
            document.getElementById('productName').value = product.realName;
            document.getElementById('productDesignation').value = product.designation;
            document.getElementById('productRepetition').value = product.repetition || '';
            document.getElementById('productImage').value = product.imageUrl || '';
            document.getElementById('productQty').value = product.quantity;
            document.getElementById('productBaraka').value = product.pdvStock?.albaraka || 0;
            document.getElementById('productGhafla').value = product.pdvStock?.alghafla || 0;
            document.getElementById('productFormDiv').style.display = 'block';
            document.getElementById('productFormDiv').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteProduct(id) {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce produit ?')) return;
            
            products = products.filter(p => p.id !== id);
            saveData();
            renderProducts();
            updateMovementProductSelect();
            updateTransferProductSelect();
            updateDashboard();
            alert('‚úÖ Produit supprim√© avec succ√®s !');
        }

        function searchProducts() {
            searchTerm = document.getElementById('searchProduct').value;
            renderProducts();
        }

        function renderProducts() {
            const tbody = document.getElementById('productList');
            if (!tbody) return;
            
            const filtered = products.filter(p => {
                const search = searchTerm.toLowerCase();
                return p.realName.toLowerCase().includes(search) || 
                       p.reference.toLowerCase().includes(search) ||
                       p.designation.toLowerCase().includes(search);
            });

            tbody.innerHTML = filtered.map(p => {
                const imageUrl = p.imageUrl || '';
                const safeName = p.realName.replace(/'/g, "\\'");
                const safeUrl = imageUrl.replace(/'/g, "\\'");
                
                return `
                <tr>
                    <td>${p.reference}</td>
                    <td>${p.realName}</td>
                    <td>${p.designation}</td>
                    <td>${p.repetition || '-'}</td>
                    <td>
                        ${imageUrl ? `<img src="${imageUrl}" alt="${safeName}" style="width: 50px; height: 50px; object-fit: cover; cursor: pointer; border-radius: 4px;" onclick="showImageZoom('${safeUrl}', '${safeName}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span style="color: #e74c3c; display: none;">‚ùå Erreur</span>` : '<span style="color: #95a5a6;">Pas d\'image</span>'}
                    </td>
                    <td><strong>${p.quantity}</strong></td>
                    <td>${p.pdvStock?.albaraka || 0}</td>
                    <td>${p.pdvStock?.alghafla || 0}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editProduct(${p.id})" style="padding: 8px 12px; margin: 2px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="padding: 8px 12px; margin: 2px;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function showImageZoom(imageUrl, productName) {
            if (!imageUrl) return;
            
            const modal = document.getElementById('imageZoomModal');
            const img = document.getElementById('zoomedImage');
            const caption = document.getElementById('imageCaption');
            
            img.src = imageUrl;
            img.onerror = function() {
                caption.textContent = productName + ' - ‚ùå Impossible de charger l\'image';
                img.style.display = 'none';
            };
            img.onload = function() {
                img.style.display = 'block';
            };
            
            caption.textContent = productName;
            modal.style.display = 'flex';
        }

        function closeImageZoom() {
            document.getElementById('imageZoomModal').style.display = 'none';
        }

        function updateMovementProductSelect() {
            const select = document.getElementById('movementProduct');
            select.innerHTML = '<option value="">-- S√©lectionner un produit --</option>' +
                products.map(p => `<option value="${p.id}">${p.realName} (R√©f: ${p.reference})</option>`).join('');
        }

        function updateTransferProductSelect() {
            const select = document.getElementById('transferProduct');
            select.innerHTML = '<option value="">-- S√©lectionner un produit --</option>' +
                products.map(p => `<option value="${p.id}">${p.realName} (R√©f: ${p.reference})</option>`).join('');
        }

        function saveMovement() {
            const type = document.getElementById('movementType').value;
            const pdv = document.getElementById('movementPdv').value;
            const payment = document.getElementById('movementPayment').value;
            const productId = parseInt(document.getElementById('movementProduct').value);
            const qty = parseInt(document.getElementById('movementQty').value);
            const note = document.getElementById('movementNote').value.trim();

            if (!pdv || !payment || !productId || !qty) {
                alert('‚ùå Veuillez remplir tous les champs obligatoires');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('‚ùå Produit introuvable');
                return;
            }

            const pdvKey = pdv === 'Al Baraka' ? 'albaraka' : 'alghafla';
            const currentPdvStock = product.pdvStock?.[pdvKey] || 0;

            if (type === 'Sortie' && currentPdvStock < qty) {
                alert(`‚ùå Stock insuffisant dans ${pdv}. Stock disponible: ${currentPdvStock}`);
                return;
            }

            if (type === 'Entr√©e') {
                product.quantity += qty;
                if (!product.pdvStock) product.pdvStock = { albaraka: 0, alghafla: 0 };
                product.pdvStock[pdvKey] += qty;
            } else {
                product.quantity -= qty;
                product.pdvStock[pdvKey] -= qty;
            }

            const movement = {
                id: Date.now(),
                date: new Date().toISOString(),
                type: type,
                productId: productId,
                productName: product.realName,
                productRef: product.reference,
                quantity: qty,
                pdv: pdv,
                payment: payment,
                note: note
            };

            movements.push(movement);
            saveData();
            renderProducts();
            renderHistory();
            updateDashboard();

            document.getElementById('movementQty').value = '';
            document.getElementById('movementNote').value = '';
            alert(`‚úÖ ${type} de ${qty} unit√©(s) enregistr√©e avec succ√®s pour ${pdv} !`);
        }

        function renderHistory() {
            filtHist();
        }

        function filtHist() {
            const tbody = document.getElementById('historyList');
            if (!tbody) return;

            const search = document.getElementById('histSearch').value.toLowerCase();
            const date = document.getElementById('histDate').value;
            const month = document.getElementById('histMonth').value;
            const year = document.getElementById('histYear').value;

            let filtered = [...movements];

            if (search) {
                filtered = filtered.filter(m => 
                    m.productName.toLowerCase().includes(search) ||
                    m.productRef.toLowerCase().includes(search) ||
                    m.pdv.toLowerCase().includes(search) ||
                    m.type.toLowerCase().includes(search)
                );
            }

            if (date) {
                filtered = filtered.filter(m => m.date.startsWith(date));
            }

            if (month) {
                filtered = filtered.filter(m => m.date.startsWith(month));
            }

            if (year) {
                filtered = filtered.filter(m => m.date.startsWith(year));
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = filtered.map(m => `
                <tr>
                    <td>${new Date(m.date).toLocaleString('fr-FR')}</td>
                    <td><span style="background: ${m.type === 'Entr√©e' ? '#28a745' : '#dc3545'}; color: white; padding: 5px 10px; border-radius: 5px;">${m.type}</span></td>
                    <td>${m.productName} (${m.productRef})</td>
                    <td><strong>${m.quantity}</strong></td>
                    <td>${m.pdv}</td>
                    <td>${m.payment}</td>
                    <td>${m.note || '-'}</td>
                </tr>
            `).join('');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Aucun mouvement trouv√©</td></tr>';
            }
        }

        function clearHistFilters() {
            document.getElementById('histSearch').value = '';
            document.getElementById('histDate').value = '';
            document.getElementById('histMonth').value = '';
            document.getElementById('histYear').value = '';
            filtHist();
        }

        function renderPdv() {
            const tbody = document.getElementById('pdvList');
            if (!tbody) return;
            
            tbody.innerHTML = pdvs.map(pdv => {
                const pdvStock = products.reduce((sum, p) => {
                    return sum + (p.pdvStock?.[pdv.id] || 0);
                }, 0);
                
                const pdvProducts = products.filter(p => (p.pdvStock?.[pdv.id] || 0) > 0).length;
                
                return `
                <tr>
                    <td><strong>${pdv.name}</strong></td>
                    <td>${pdvStock}</td>
                    <td>${pdvProducts}</td>
                </tr>`;
            }).join('');
        }

        function saveTransfer() {
            const source = document.getElementById('transferSource').value;
            const dest = document.getElementById('transferDest').value;
            const productId = parseInt(document.getElementById('transferProduct').value);
            const qty = parseInt(document.getElementById('transferQty').value);

            if (!source || !dest || !productId || !qty) {
                alert('‚ùå Veuillez remplir tous les champs');
                return;
            }

            if (source === dest) {
                alert('‚ùå La source et la destination doivent √™tre diff√©rentes');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('‚ùå Produit introuvable');
                return;
            }

            const sourceKey = source === 'Al Baraka' ? 'albaraka' : 'alghafla';
            const destKey = dest === 'Al Baraka' ? 'albaraka' : 'alghafla';

            if (!product.pdvStock) product.pdvStock = { albaraka: 0, alghafla: 0 };

            const sourceStock = product.pdvStock[sourceKey] || 0;
            if (sourceStock < qty) {
                alert(`‚ùå Stock insuffisant dans ${source}. Stock disponible: ${sourceStock}`);
                return;
            }

            product.pdvStock[sourceKey] -= qty;
            product.pdvStock[destKey] += qty;

            const movement = {
                id: Date.now(),
                date: new Date().toISOString(),
                type: 'Transfert',
                productId: productId,
                productName: product.realName,
                productRef: product.reference,
                quantity: qty,
                pdv: `${source} ‚Üí ${dest}`,
                payment: '-',
                note: `Transfert de ${source} vers ${dest}`
            };

            movements.push(movement);
            saveData();
            renderProducts();
            renderHistory();
            renderPdv();

            document.getElementById('transferQty').value = '';
            alert(`‚úÖ Transfert de ${qty} unit√©(s) de ${source} vers ${dest} effectu√© avec succ√®s !\n\n‚ö†Ô∏è Note: Le stock total reste inchang√©.`);
        }

        function exportToExcel() {
            const ws_data = [
                ['REFERENCE', 'NOM REEL', 'DESIGNATION', 'REPETITION', 'QTY', 'AL BARAKA', 'ALGHAFLA', 'IMAGE URL']
            ];

            products.forEach(p => {
                ws_data.push([
                    p.reference,
                    p.realName,
                    p.designation,
                    p.repetition || '',
                    p.quantity,
                    p.pdvStock?.albaraka || 0,
                    p.pdvStock?.alghafla || 0,
                    p.imageUrl || ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Stock_Export_${date}.xlsx`);
            alert('‚úÖ Export Excel r√©ussi !');
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (rows.length < 2) {
                        alert('‚ùå Le fichier Excel est vide');
                        return;
                    }

                    let imported = 0;
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row[0] || !row[1] || !row[2]) continue;

                        const product = {
                            id: Date.now() + i,
                            reference: String(row[0]).trim(),
                            realName: String(row[1]).trim(),
                            designation: String(row[2]).trim(),
                            repetition: row[3] ? String(row[3]).trim() : '',
                            quantity: parseInt(row[4]) || 0,
                            pdvStock: {
                                albaraka: parseInt(row[5]) || 0,
                                alghafla: parseInt(row[6]) || 0
                            },
                            imageUrl: row[7] ? String(row[7]).trim() : ''
                        };

                        products.push(product);
                        imported++;
                    }

                    saveData();
                    renderProducts();
                    updateMovementProductSelect();
                    updateTransferProductSelect();
                    updateDashboard();
                    alert(`‚úÖ Import r√©ussi ! ${imported} produit(s) import√©(s)`);
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }
    </script>
</body>
</html>
