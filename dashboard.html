<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Stock Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f9fafb; }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            overflow-y: auto;
            z-index: 1000;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 2rem; }
        .logo-text { font-size: 1.5rem; font-weight: bold; }
        .user-profile {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .user-name { font-weight: 600; }
        .user-email { font-size: 0.85rem; opacity: 0.8; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid white;
        }
        .nav-icon { font-size: 1.2rem; }
        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-title { font-size: 2rem; font-weight: bold; color: var(--dark); }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-edit { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; margin-right: 5px; }
        .btn-delete { background: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .stat-label { font-size: 0.9rem; color: var(--gray); margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .stat-card.blue .stat-value { color: #3b82f6; }
        .stat-card.green .stat-value { color: var(--success); }
        .stat-card.red .stat-value { color: var(--danger); }
        .stat-card.orange .stat-value { color: var(--warning); }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title { font-size: 1.2rem; font-weight: 600; color: var(--dark); }
        .card-body { padding: 20px; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 6px; color: var(--dark); }
        .form-input, .form-select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: var(--light);
        }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        tr:hover { background: #f9fafb; }
        .search-input {
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 15px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        .img-zoom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: zoom-out;
            animation: fadeIn 0.2s;
        }
        .img-zoom img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .section { display: none; }
        .section.active { display: block; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üì¶</div>
                <div class="logo-text">Stock Pro</div>
            </div>
        </div>
        <div class="user-profile">
            <div class="user-avatar">üë§</div>
            <div>
                <div class="user-name" id="user-name">Utilisateur</div>
                <div class="user-email" id="user-email">user@example.com</div>
            </div>
        </div>
        <nav>
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showSection('products')">
                <span class="nav-icon">üì¶</span>
                <span>Produits</span>
            </div>
            <div class="nav-item" onclick="showSection('movements')">
                <span class="nav-icon">üîÑ</span>
                <span>Mouvements</span>
            </div>
            <div class="nav-item" onclick="showSection('transfer')">
                <span class="nav-icon">üöö</span>
                <span>Transferts</span>
            </div>
            <div class="nav-item" onclick="showSection('pdv')">
                <span class="nav-icon">üè™</span>
                <span>Points de Vente</span>
            </div>
            <div class="nav-item" onclick="showSection('history')">
                <span class="nav-icon">üìú</span>
                <span>Historique</span>
            </div>
            <div class="nav-item" onclick="logout()">
                <span class="nav-icon">üö™</span>
                <span>D√©connexion</span>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="top-bar">
                <h1 class="page-title">üìä Dashboard</h1>
            </div>
            <div id="dash-content"></div>
        </div>

        <!-- PRODUITS -->
        <div id="products" class="section">
            <div class="top-bar">
                <h1 class="page-title">üì¶ Gestion des Produits</h1>
                <div>
                    <button class="btn btn-success" onclick="openModal('productModal')">‚ûï Nouveau Produit</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì• Importer Excel</button>
                    <button class="btn btn-primary" onclick="exportToExcel()">üì§ Exporter Excel</button>
                </div>
            </div>
            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none;" onchange="handleImport(event)">
            <div class="card">
                <div class="card-body">
                    <input type="text" id="prod-search" class="search-input" placeholder="üîç Rechercher par nom, r√©f√©rence...">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Nom</th>
                                    <th>R√©f√©rence</th>
                                    <th>Stock Total</th>
                                    <th>R√©p√©tition</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="prod-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOUVEMENTS -->
        <div id="movements" class="section">
            <div class="top-bar">
                <h1 class="page-title">üîÑ Gestion des Mouvements</h1>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Nouveau Mouvement</h3>
                </div>
                <div class="card-body">
                    <form onsubmit="addMovement(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Type *</label>
                                <select id="mov-type" class="form-select" required onchange="togglePdvSelect()">
                                    <option value="">S√©lectionner...</option>
                                    <option value="in">Entr√©e (+)</option>
                                    <option value="out">Sortie (-)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Produit *</label>
                                <select id="mov-product" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Point de Vente *</label>
                                <select id="mov-pdv" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantit√© *</label>
                                <input type="number" id="mov-quantity" class="form-input" min="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mode de Paiement *</label>
                                <select id="mov-payment" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Esp√®ce">Esp√®ce</option>
                                    <option value="Virement">Virement</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Raison</label>
                                <input type="text" id="mov-reason" class="form-input" placeholder="Facultatif">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <input type="text" id="mov-note" class="form-input" placeholder="Facultatif">
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top:15px;">‚úÖ Enregistrer</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- TRANSFERTS -->
        <div id="transfer" class="section">
            <div class="top-bar">
                <h1 class="page-title">üöö Transferts entre PDV</h1>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Nouveau Transfert</h3>
                </div>
                <div class="card-body">
                    <form onsubmit="addTransfer(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Produit *</label>
                                <select id="trans-product" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">De (Source) *</label>
                                <select id="trans-from" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vers (Destination) *</label>
                                <select id="trans-to" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantit√© *</label>
                                <input type="number" id="trans-quantity" class="form-input" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <input type="text" id="trans-note" class="form-input" placeholder="Facultatif">
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top:15px;">üöö Transf√©rer</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- POINTS DE VENTE -->
        <div id="pdv" class="section">
            <div class="top-bar">
                <h1 class="page-title">üè™ Points de Vente</h1>
                <button class="btn btn-success" onclick="openModal('pdvModal')">‚ûï Nouveau PDV</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Emplacement</th>
                                    <th>Stock Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pdvList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORIQUE -->
        <div id="history" class="section">
            <div class="top-bar">
                <h1 class="page-title">üìú Historique des Mouvements</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="form-grid">
                        <input type="text" id="hs" class="form-input" placeholder="üîç Rechercher...">
                        <input type="date" id="hd" class="form-input" placeholder="Date">
                        <select id="hm" class="form-select">
                            <option value="">Tous les mois</option>
                            <option value="0">Janvier</option>
                            <option value="1">F√©vrier</option>
                            <option value="2">Mars</option>
                            <option value="3">Avril</option>
                            <option value="4">Mai</option>
                            <option value="5">Juin</option>
                            <option value="6">Juillet</option>
                            <option value="7">Ao√ªt</option>
                            <option value="8">Septembre</option>
                            <option value="9">Octobre</option>
                            <option value="10">Novembre</option>
                            <option value="11">D√©cembre</option>
                        </select>
                        <select id="hy" class="form-select">
                            <option value="">Toutes les ann√©es</option>
                        </select>
                        <button class="btn btn-primary" onclick="rstHist()">üîÑ R√©initialiser</button>
                    </div>
                    <div class="table-container" style="margin-top:20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Raison</th>
                                    <th>Produit</th>
                                    <th>Quantit√©</th>
                                    <th>PDV/Paiement</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody id="hist-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUIT -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter un Produit</h2>
                <button class="close-btn" onclick="closeModal('productModal')">‚úñ</button>
            </div>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label class="form-label">Nom du Produit *</label>
                    <input type="text" id="p-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">R√©f√©rence *</label>
                    <input type="text" id="p-ref" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">R√©p√©tition</label>
                    <input type="text" id="p-rep" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">URL Image Google Drive</label>
                    <input type="url" id="p-img" class="form-input" placeholder="https://drive.google.com/...">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top:15px;">üíæ Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- MODAL PDV -->
    <div id="pdvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter un Point de Vente</h2>
                <button class="close-btn" onclick="closeModal('pdvModal')">‚úñ</button>
            </div>
            <form onsubmit="savePdv(event)">
                <input type="hidden" id="pdv-edit-id">
                <div class="form-group">
                    <label class="form-label">Nom du PDV *</label>
                    <input type="text" id="pdv-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Emplacement</label>
                    <input type="text" id="pdv-location" class="form-input">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top:15px;">üíæ Enregistrer</button>
            </form>
        </div>
    </div>

    <script>
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let pdvs = JSON.parse(localStorage.getItem('pdvs')) || [
            {id: 'al-baraka', name: 'Al Baraka', location: 'Centre-ville'},
            {id: 'alghafla', name: 'Alghafla', location: 'Zone industrielle'}
        ];
        let movements = JSON.parse(localStorage.getItem('movements')) || [];

        // V√©rifier authentification (optionnel pour d√©mo)
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) {
            document.getElementById('user-name').textContent = user.fullName || user.email || 'Utilisateur';
            document.getElementById('user-email').textContent = user.email || 'user@example.com';
        }

        function save() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('pdvs', JSON.stringify(pdvs));
            localStorage.setItem('movements', JSON.stringify(movements));
        }

        function showSection(sec) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sec).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (sec === 'dashboard') renderDash();
            if (sec === 'products') renderProds();
            if (sec === 'movements') { renderMovForm(); }
            if (sec === 'transfer') { renderTransForm(); }
            if (sec === 'pdv') renderPdv();
            if (sec === 'history') renderHist();
        }

        function renderDash() {
            const total = products.length;
            const stock = products.reduce((sum, p) => sum + (p.quantity || 0), 0);
            const low = products.filter(p => (p.quantity || 0) < 10).length;
            const value = 0; // Pas de prix dans cette version

            document.getElementById('dash-content').innerHTML = `
                <input type="text" id="dash-search" class="search-input" placeholder="üîç Rechercher..." style="width:100%;">
                <div class="stats-grid">
                    <div class="stat-card blue"><div class="stat-label">Total Produits</div><div class="stat-value">${total}</div></div>
                    <div class="stat-card green"><div class="stat-label">Stock Total</div><div class="stat-value">${stock}</div></div>
                    <div class="stat-card red"><div class="stat-label">Alertes Stock</div><div class="stat-value">${low}</div></div>
                    <div class="stat-card orange"><div class="stat-label">Points de Vente</div><div class="stat-value">${pdvs.length}</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üö® Alertes Stock (< 10 unit√©s)</h3></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Produit</th><th>R√©f√©rence</th><th>Stock</th></tr></thead>
                            <tbody id="dash-body">${renderAlerts(products.filter(p => (p.quantity || 0) < 10))}</tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('dash-search').oninput = function() {
                const s = this.value.toLowerCase();
                const f = products.filter(p => (p.quantity || 0) < 10 && (p.name.toLowerCase().includes(s) || p.reference.toLowerCase().includes(s)));
                document.getElementById('dash-body').innerHTML = renderAlerts(f);
            };
        }

        function renderAlerts(list) {
            if (list.length === 0) return '<tr><td colspan="3" style="text-align:center;">Aucune alerte</td></tr>';
            return list.map(p => `<tr><td><strong>${p.name}</strong></td><td>${p.reference}</td><td><span class="badge badge-danger">${p.quantity || 0}</span></td></tr>`).join('');
        }

        function renderProds() {
            const tbody = document.getElementById('prod-body');
            if (!tbody) return;
            tbody.innerHTML = products.map(p => {
                const img = p.imageUrl ? `<img src="${p.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="zoomImg('${p.imageUrl}')">` : 'üì¶';
                return `<tr>
                    <td>${img}</td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.reference}</td>
                    <td><span class="badge badge-success">${p.quantity || 0}</span></td>
                    <td>${p.repetition || '-'}</td>
                    <td>
                        <button onclick="editProduct('${p.id}')" class="btn-edit">‚úèÔ∏è</button>
                        <button onclick="deleteProduct('${p.id}')" class="btn-delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('prod-search').oninput = function() {
                const s = this.value.toLowerCase();
                const filtered = products.filter(p => p.name.toLowerCase().includes(s) || p.reference.toLowerCase().includes(s));
                tbody.innerHTML = filtered.map(p => {
                    const img = p.imageUrl ? `<img src="${p.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;" onclick="zoomImg('${p.imageUrl}')">` : 'üì¶';
                    return `<tr><td>${img}</td><td><strong>${p.name}</strong></td><td>${p.reference}</td><td><span class="badge badge-success">${p.quantity || 0}</span></td><td>${p.repetition || '-'}</td><td><button onclick="editProduct('${p.id}')" class="btn-edit">‚úèÔ∏è</button><button onclick="deleteProduct('${p.id}')" class="btn-delete">üóëÔ∏è</button></td></tr>`;
                }).join('');
            };
        }

        function zoomImg(url) {
            if (!url) return;
            const overlay = document.createElement('div');
            overlay.className = 'img-zoom';
            overlay.innerHTML = `<img src="${url}" alt="Zoom">`;
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'productModal') {
                document.getElementById('edit-id').value = '';
                document.getElementById('p-name').value = '';
                document.getElementById('p-ref').value = '';
                document.getElementById('p-rep').value = '';
                document.getElementById('p-img').value = '';
            }
            if (id === 'pdvModal') {
                document.getElementById('pdv-edit-id').value = '';
                document.getElementById('pdv-name').value = '';
                document.getElementById('pdv-location').value = '';
            }
        }

        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value || Date.now().toString();
            const name = document.getElementById('p-name').value.trim();
            const reference = document.getElementById('p-ref').value.trim();
            const repetition = document.getElementById('p-rep').value.trim();
            const imageUrl = document.getElementById('p-img').value.trim();

            const existing = products.find(p => p.id === id);
            if (existing) {
                existing.name = name;
                existing.reference = reference;
                existing.repetition = repetition;
                existing.imageUrl = imageUrl;
            } else {
                products.push({
                    id,
                    name,
                    reference,
                    repetition,
                    imageUrl,
                    quantity: 0,
                    pdvStock: {}
                });
            }

            save();
            closeModal('productModal');
            renderProds();
            alert('‚úÖ Produit enregistr√© avec succ√®s !');
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-ref').value = p.reference;
            document.getElementById('p-rep').value = p.repetition || '';
            document.getElementById('p-img').value = p.imageUrl || '';
            openModal('productModal');
        }

        function deleteProduct(id) {
            if (!confirm('Supprimer ce produit ?')) return;
            products = products.filter(p => p.id !== id);
            save();
            renderProds();
        }

        function renderMovForm() {
            const prodSelect = document.getElementById('mov-product');
            const pdvSelect = document.getElementById('mov-pdv');
            prodSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            pdvSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                pdvs.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        }

        function togglePdvSelect() {
            const type = document.getElementById('mov-type').value;
            const pdvGroup = document.getElementById('mov-pdv').closest('.form-group');
            pdvGroup.style.display = type ? 'flex' : 'none';
        }

        function addMovement(e) {
            e.preventDefault();
            const type = document.getElementById('mov-type').value;
            const productId = document.getElementById('mov-product').value;
            const pdvId = document.getElementById('mov-pdv').value;
            const quantity = parseInt(document.getElementById('mov-quantity').value);
            const payment = document.getElementById('mov-payment').value;
            const reason = document.getElementById('mov-reason').value.trim();
            const note = document.getElementById('mov-note').value.trim();

            const product = products.find(p => p.id === productId);
            const pdv = pdvs.find(v => v.id === pdvId);
            
            if (!product || !pdv) {
                alert('‚ùå Produit ou PDV invalide');
                return;
            }

            // Initialiser pdvStock si n√©cessaire
            if (!product.pdvStock) product.pdvStock = {};
            if (!product.pdvStock[pdvId]) product.pdvStock[pdvId] = 0;

            // Appliquer le mouvement
            if (type === 'in') {
                product.pdvStock[pdvId] += quantity;
                product.quantity = (product.quantity || 0) + quantity;
            } else if (type === 'out') {
                if (product.pdvStock[pdvId] < quantity) {
                    alert('‚ùå Stock insuffisant dans ce PDV');
                    return;
                }
                product.pdvStock[pdvId] -= quantity;
                product.quantity = (product.quantity || 0) - quantity;
            }

            movements.push({
                id: Date.now().toString(),
                type,
                product: product.name,
                productId,
                pdv: pdv.name,
                pdvId,
                quantity,
                payment,
                reason,
                note,
                date: new Date().toISOString()
            });

            save();
            e.target.reset();
            alert(`‚úÖ Mouvement enregistr√© ! Stock ${pdv.name}: ${product.pdvStock[pdvId]}`);
        }

        function renderTransForm() {
            const prodSelect = document.getElementById('trans-product');
            const fromSelect = document.getElementById('trans-from');
            const toSelect = document.getElementById('trans-to');
            
            prodSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            fromSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                pdvs.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            toSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                pdvs.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        }

        function addTransfer(e) {
            e.preventDefault();
            const productId = document.getElementById('trans-product').value;
            const fromId = document.getElementById('trans-from').value;
            const toId = document.getElementById('trans-to').value;
            const quantity = parseInt(document.getElementById('trans-quantity').value);
            const note = document.getElementById('trans-note').value.trim();

            if (fromId === toId) {
                alert('‚ùå Source et destination doivent √™tre diff√©rentes');
                return;
            }

            const product = products.find(p => p.id === productId);
            const fromPdv = pdvs.find(v => v.id === fromId);
            const toPdv = pdvs.find(v => v.id === toId);

            if (!product || !fromPdv || !toPdv) {
                alert('‚ùå S√©lection invalide');
                return;
            }

            if (!product.pdvStock) product.pdvStock = {};
            if (!product.pdvStock[fromId]) product.pdvStock[fromId] = 0;
            if (!product.pdvStock[toId]) product.pdvStock[toId] = 0;

            if (product.pdvStock[fromId] < quantity) {
                alert('‚ùå Stock insuffisant dans le PDV source');
                return;
            }

            product.pdvStock[fromId] -= quantity;
            product.pdvStock[toId] += quantity;

            movements.push({
                id: Date.now().toString(),
                type: 'transfer',
                product: product.name,
                productId,
                from: fromPdv.name,
                to: toPdv.name,
                fromId,
                toId,
                quantity,
                note,
                date: new Date().toISOString()
            });

            save();
            e.target.reset();
            alert(`‚úÖ Transfert r√©ussi ! ${fromPdv.name} ‚Üí ${toPdv.name}`);
        }

        function renderPdv() {
            const tbody = document.getElementById('pdvList');
            if (!tbody) return;
            tbody.innerHTML = pdvs.map(p => {
                const pdvStock = products.reduce((sum, prod) => {
                    return sum + (prod.pdvStock?.[p.id] || 0);
                }, 0);
                return `<tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.location || '-'}</td>
                    <td><span style="background:#3b82f6;color:white;padding:4px 12px;border-radius:12px;font-weight:bold;">${pdvStock}</span></td>
                    <td>
                        <button onclick="editPdv('${p.id}')" class="btn-edit">‚úèÔ∏è</button>
                        <button onclick="delPdv('${p.id}')" class="btn-delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function savePdv(e) {
            e.preventDefault();
            const id = document.getElementById('pdv-edit-id').value || Date.now().toString();
            const name = document.getElementById('pdv-name').value.trim();
            const location = document.getElementById('pdv-location').value.trim();

            const existing = pdvs.find(p => p.id === id);
            if (existing) {
                existing.name = name;
                existing.location = location;
            } else {
                pdvs.push({ id, name, location });
            }

            save();
            closeModal('pdvModal');
            renderPdv();
            alert('‚úÖ PDV enregistr√© !');
        }

        function editPdv(id) {
            const p = pdvs.find(x => x.id === id);
            if (!p) return;
            document.getElementById('pdv-edit-id').value = p.id;
            document.getElementById('pdv-name').value = p.name;
            document.getElementById('pdv-location').value = p.location || '';
            openModal('pdvModal');
        }

        function delPdv(id) {
            if (!confirm('Supprimer ce PDV ?')) return;
            pdvs = pdvs.filter(p => p.id !== id);
            save();
            renderPdv();
        }

        function renderHist() {
            const years = getYrs();
            document.getElementById('hy').innerHTML = '<option value="">Toutes les ann√©es</option>' + 
                years.map(y => `<option value="${y}">${y}</option>`).join('');
            filtHist();
            
            ['hs', 'hd', 'hm', 'hy'].forEach(id => {
                document.getElementById(id).addEventListener('input', filtHist);
            });
        }

        function filtHist() {
            const s = document.getElementById('hs').value.toLowerCase();
            const d = document.getElementById('hd').value;
            const m = document.getElementById('hm').value;
            const y = document.getElementById('hy').value;
            
            const sorted = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const filtered = sorted.filter(mov => {
                const date = new Date(mov.date);
                const matchSearch = !s || mov.product.toLowerCase().includes(s) || 
                    (mov.reason && mov.reason.toLowerCase().includes(s)) ||
                    (mov.note && mov.note.toLowerCase().includes(s));
                const matchDate = !d || date.toISOString().split('T')[0] === d;
                const matchMonth = !m || date.getMonth() === parseInt(m);
                const matchYear = !y || date.getFullYear() === parseInt(y);
                return matchSearch && matchDate && matchMonth && matchYear;
            });

            document.getElementById('hist-body').innerHTML = renderHistTable(filtered);
        }

        function renderHistTable(list) {
            if (!list || list.length === 0) return '<tr><td colspan="7" style="text-align:center;">Aucun mouvement</td></tr>';
            return list.map(m => {
                const ic = m.type === 'in' ? '‚ûï' : m.type === 'transfer' ? 'üîÑ' : '‚ûñ';
                const cl = m.type === 'in' ? '#10b981' : m.type === 'transfer' ? '#f59e0b' : '#ef4444';
                const tp = m.type === 'in' ? 'Entr√©e' : m.type === 'transfer' ? 'Transfert' : 'Sortie';
                const detail = m.type === 'transfer' ? `${m.from} ‚Üí ${m.to}` : m.pdv || '-';
                return `<tr>
                    <td>${new Date(m.date).toLocaleString('fr-FR')}</td>
                    <td><span style="color:${cl};font-weight:bold;">${ic} ${tp}</span></td>
                    <td>${m.reason || '-'}</td>
                    <td><strong>${m.product}</strong></td>
                    <td><strong style="color:${cl};">${m.quantity}</strong></td>
                    <td>${detail}</td>
                    <td>${m.note || '-'}</td>
                </tr>`;
            }).join('');
        }

        function getYrs() {
            const y = new Set();
            movements.forEach(m => y.add(new Date(m.date).getFullYear()));
            return Array.from(y).sort((a, b) => b - a);
        }

        function rstHist() {
            document.getElementById('hs').value = '';
            document.getElementById('hd').value = '';
            document.getElementById('hm').value = '';
            document.getElementById('hy').value = '';
            filtHist();
        }

        function exportToExcel() {
            const data = products.map(p => ({
                'Nom': p.name,
                'R√©f√©rence': p.reference,
                'R√©p√©tition': p.repetition || '',
                'Quantit√©': p.quantity || 0,
                'Image URL': p.imageUrl || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `stock_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);

                    let imported = 0;
                    rows.forEach(r => {
                        const name = (r['Nom'] || r['nom'] || r['NAME'] || '').toString().trim();
                        const ref = (r['R√©f√©rence'] || r['Reference'] || r['r√©f√©rence'] || r['reference'] || r['REF'] || '').toString().trim();
                        
                        if (!name || !ref) return;

                        const existing = products.find(p => p.reference === ref);
                        if (existing) {
                            existing.name = name;
                            existing.repetition = (r['R√©p√©tition'] || r['Repetition'] || '').toString().trim();
                            existing.imageUrl = (r['Image URL'] || r['ImageURL'] || '').toString().trim();
                        } else {
                            products.push({
                                id: Date.now().toString() + Math.random(),
                                name,
                                reference: ref,
                                repetition: (r['R√©p√©tition'] || r['Repetition'] || '').toString().trim(),
                                imageUrl: (r['Image URL'] || r['ImageURL'] || '').toString().trim(),
                                quantity: parseInt(r['Quantit√©'] || r['Quantite'] || r['Quantity'] || 0),
                                pdvStock: {}
                            });
                        }
                        imported++;
                    });

                    save();
                    renderProds();
                    alert(`‚úÖ ${imported} produit(s) import√©(s) avec succ√®s !`);
                } catch (err) {
                    alert('‚ùå Erreur lors de l\'import : ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function logout() {
            if (confirm('Se d√©connecter ?')) {
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        }

        // Initialisation
        renderDash();
    </script>
</body>
</html>
