<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock Professionnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .nav-buttons { display: flex; gap: 1rem; }
        .nav-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; background: transparent; color: #666; transition: all 0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #2563eb; color: white; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid; }
        .stat-card.blue { border-color: #2563eb; }
        .stat-card.green { border-color: #10b981; }
        .stat-card.red { border-color: #ef4444; }
        .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #333; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .card-title { font-size: 1.3rem; font-weight: bold; }
        .search-input { flex: 1; max-width: 400px; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.7rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-purple:hover { background: #7c3aed; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-orange { background: #f97316; color: white; }
        .btn-orange:hover { background: #ea580c; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { font-weight: 600; font-size: 0.9rem; color: #374151; }
        td { font-size: 0.9rem; }
        tbody tr:hover { background: #f9fafb; }
        .badge { padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-in { background: #d1fae5; color: #065f46; }
        .badge-out { background: #fee2e2; color: #991b1b; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; background: #f3f4f6; border: 1px solid #e5e7eb; }
        .product-img-error { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 8px; border: 1px solid #e5e7eb; color: #9ca3af; font-size: 1.5rem; }
        .action-btn { padding: 0.5rem; border: none; background: transparent; cursor: pointer; color: #666; transition: color 0.3s; font-size: 1.2rem; }
        .action-btn:hover { color: #2563eb; }
        .action-btn.delete:hover { color: #ef4444; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .form-input, .form-select { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .progress-bar { margin-bottom: 1rem; padding: 1rem; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: #1e40af; }
        .progress { height: 8px; background: #93c5fd; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
        .hidden { display: none; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">üì¶ Gestion de Stock Pro</div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('dashboard')">üè† Dashboard</button>
                <button class="nav-btn" onclick="showPage('products')">üì¶ Produits</button>
                <button class="nav-btn" onclick="showPage('movements')">üìä Entr√©es/Sorties</button>
                <button class="nav-btn" onclick="showPage('returns')">üîÑ Retours</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="dashboard-page">
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-label">Total Produits</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Stock Total</div>
                    <div class="stat-value" id="stat-stock">0</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Alertes Stock Faible</div>
                    <div class="stat-value" id="stat-alerts">0</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìã Mouvements R√©cents</div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Produit</th><th>Type</th><th>Raison</th><th>Quantit√©</th></tr>
                        </thead>
                        <tbody id="recent-movements"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="products-page" class="hidden">
            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="search-input" placeholder="üîç Rechercher par Nom R√©el ou R√©f√©rence...">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openModal()">‚ûï Ajouter</button>
                        <label class="btn btn-success">
                            üì§ Importer
                            <input type="file" id="import-file" accept=".xlsx,.xls">
                        </label>
                        <button class="btn btn-purple" onclick="handleExport()">üì• Exporter</button>
                        <button class="btn btn-danger" onclick="deleteSelectedProducts()">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
                <div id="import-progress" class="progress-bar hidden">
                    <div class="progress-info">
                        <span>Import en cours...</span>
                        <span id="progress-text">0 / 0</span>
                    </div>
                    <div class="progress">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-delete"></th>
                                <th>Image</th><th>Nom R√©el</th><th>Nom Convention</th><th>R√©f√©rence</th><th>Marque</th><th>Quantit√©</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="movements-page" class="hidden">
            <div class="card">
                <div class="card-title">üìä Enregistrer un Mouvement</div>
                <div class="form-grid" style="margin: 1.5rem 0;">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="movement-type" class="form-select">
                            <option value="in">Entr√©e</option>
                            <option value="out">Sortie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Raison</label>
                        <select id="movement-reason" class="form-select">
                            <option value="">S√©lectionner...</option>
                            <option value="Vente">Vente</option>
                            <option value="Mise en Stock">Mise en Stock</option>
                            <option value="Retour">Retour</option>
                        </select>
                    </div>
                    <div class="form-group" id="client-name-group" style="display: none;">
                        <label class="form-label">Nom Client</label>
                        <input type="text" id="client-name" class="form-input" placeholder="Nom du client">
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary" style="width: 100%; height: 42px;" id="validate-movement-btn">‚úÖ Valider</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-movement"></th>
                                <th>Produit</th><th>Stock</th><th>Quantit√©</th>
                            </tr>
                        </thead>
                        <tbody id="movement-products"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="returns-page" class="hidden">
            <div class="card">
                <div class="card-title">üõí Ventes (En attente livraison)</div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Produit</th><th>Client</th><th>Quantit√©</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="sales-table"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üîÑ Retours Client</div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Produit</th><th>Client</th><th>Quantit√©</th><th>Raison</th></tr>
                        </thead>
                        <tbody id="returns-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ajouter un Produit</h2>
                <button class="action-btn" onclick="closeModal()">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">URL Image</label>
                            <input type="text" id="form-image" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom R√©el *</label>
                            <input type="text" id="form-realName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom Conventionnel</label>
                            <input type="text" id="form-conventionalName" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Code-barres</label>
                            <input type="text" id="form-barcode" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">R√©p√©tition</label>
                            <input type="text" id="form-repetitionBarcode" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cat√©gorie</label>
                            <input type="text" id="form-category" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marque</label>
                            <input type="text" id="form-brand" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">R√©f√©rence</label>
                            <input type="text" id="form-reference" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantit√© *</label>
                            <input type="number" id="form-quantity" class="form-input" required min="0">
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
                        <button type="button" class="btn" onclick="closeModal()" style="background: #e5e7eb;">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let movements = JSON.parse(localStorage.getItem('movements')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let editingId = null;

        function saveData() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('movements', JSON.stringify(movements));
            localStorage.setItem('returns', JSON.stringify(returns));
        }

        function showPage(page) {
            document.querySelectorAll('[id$="-page"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (page === 'dashboard') updateDashboard();
            if (page === 'products') renderProducts();
            if (page === 'movements') renderMovementProducts();
            if (page === 'returns') renderReturns();
        }

        function updateDashboard() {
            document.getElementById('stat-total').textContent = products.length;
            document.getElementById('stat-stock').textContent = products.reduce((s, p) => s + p.quantity, 0);
            document.getElementById('stat-alerts').textContent = products.filter(p => p.quantity < 10).length;
            document.getElementById('recent-movements').innerHTML = movements.slice(-10).reverse().map(m => `
                <tr>
                    <td>${new Date(m.date).toLocaleDateString()}</td>
                    <td>${m.productName}</td>
                    <td><span class="badge badge-${m.type}">${m.type === 'in' ? 'Entr√©e' : 'Sortie'}</span></td>
                    <td>${m.reason}</td>
                    <td><strong>${m.quantity}</strong></td>
                </tr>
            `).join('');
        }

        function formatImageUrl(url) {
            if (!url) return '';
            url = String(url).trim();
            
            // Si c'est une URL Google Drive
            if (url.includes('drive.google.com')) {
                let fileId = '';
                
                // Extraire l'ID de diff√©rents formats
                // Format 1: /file/d/ID/view
                const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                // Format 2: ?id=ID ou &id=ID
                const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                
                fileId = match1 ? match1[1] : (match2 ? match2[1] : '');
                
                if (fileId) {
                    // Essayer plusieurs formats qui fonctionnent avec Google Drive
                    // Format le plus fiable pour les images publiques
                    return `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
                }
            }
            
            return url;
        }

        function renderProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filtered = products.filter(p => {
                const rn = String(p.realName || '').toLowerCase();
                const ref = String(p.reference || '').toLowerCase();
                return rn.includes(searchTerm) || ref.includes(searchTerm);
            });
            document.getElementById('products-table').innerHTML = filtered.map(p => {
                let imgHtml = '<div class="product-img-error">üì∑</div>';
                if (p.image) {
                    imgHtml = `<img src="${p.image}" class="product-img" alt="${p.realName}" 
                        onerror="console.error('Image failed:', '${p.image}'); this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="product-img-error" style="display:none;">üì∑</div>`;
                }
                return `
                <tr>
                    <td><input type="checkbox" class="delete-check" data-id="${p.id}"></td>
                    <td>${imgHtml}</td>
                    <td>${p.realName || '‚Äî'}</td>
                    <td>${p.conventionalName || '‚Äî'}</td>
                    <td>${p.reference || '‚Äî'}</td>
                    <td>${p.brand || '‚Äî'}</td>
                    <td><span class="badge ${p.quantity < 10 ? 'badge-danger' : 'badge-success'}">${p.quantity}</span></td>
                    <td>
                        <button class="action-btn" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `}).join('');
        }

        document.getElementById('search-input').addEventListener('input', renderProducts);
        document.getElementById('select-all-delete').addEventListener('change', function() {
            document.querySelectorAll('.delete-check').forEach(cb => cb.checked = this.checked);
        });

        function deleteProduct(id) {
            if (confirm('Supprimer ce produit ?')) {
                products = products.filter(p => p.id !== id);
                saveData();
                renderProducts();
                updateDashboard();
            }
        }

        function deleteSelectedProducts() {
            const ids = Array.from(document.querySelectorAll('.delete-check:checked')).map(cb => parseInt(cb.dataset.id));
            if (ids.length === 0) return alert('‚ö†Ô∏è S√©lectionnez des produits');
            if (confirm(`Supprimer ${ids.length} produit(s) ?`)) {
                products = products.filter(p => !ids.includes(p.id));
                saveData();
                renderProducts();
                updateDashboard();
            }
        }

        function openModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Ajouter un Produit';
            document.getElementById('product-form').reset();
            document.getElementById('product-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('product-modal').classList.remove('active');
            editingId = null;
        }

        function editProduct(id) {
            const p = products.find(p => p.id === id);
            if (!p) return;
            editingId = id;
            document.getElementById('modal-title').textContent = 'Modifier';
            document.getElementById('form-image').value = p.image || '';
            document.getElementById('form-realName').value = p.realName || '';
            document.getElementById('form-conventionalName').value = p.conventionalName || '';
            document.getElementById('form-barcode').value = p.barcode || '';
            document.getElementById('form-repetitionBarcode').value = p.repetitionBarcode || '';
            document.getElementById('form-category').value = p.category || '';
            document.getElementById('form-brand').value = p.brand || '';
            document.getElementById('form-reference').value = p.reference || '';
            document.getElementById('form-quantity').value = p.quantity || 0;
            document.getElementById('product-modal').classList.add('active');
        }

        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                image: formatImageUrl(document.getElementById('form-image').value),
                realName: document.getElementById('form-realName').value,
                conventionalName: document.getElementById('form-conventionalName').value,
                barcode: document.getElementById('form-barcode').value,
                repetitionBarcode: document.getElementById('form-repetitionBarcode').value,
                category: document.getElementById('form-category').value,
                brand: document.getElementById('form-brand').value,
                reference: document.getElementById('form-reference').value,
                quantity: parseInt(document.getElementById('form-quantity').value) || 0
            };
            if (editingId) {
                const idx = products.findIndex(p => p.id === editingId);
                products[idx] = { ...products[idx], ...data };
            } else {
                products.push({ id: Date.now(), ...data, createdAt: new Date().toISOString() });
            }
            saveData();
            renderProducts();
            updateDashboard();
            closeModal();
            alert('‚úÖ Enregistr√© !');
        });

        document.getElementById('import-file').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const pb = document.getElementById('import-progress');
                const pf = document.getElementById('progress-fill');
                const pt = document.getElementById('progress-text');
                pb.classList.remove('hidden');
                pf.style.width = '0%';
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data);
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws);
                if (rows.length === 0) throw new Error('Fichier vide');
                let count = 0;
                for (let i = 0; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r['Real Name']) continue;
                    const imgUrl = formatImageUrl(r['IMAGE'] || '');
                    products.push({
                        id: Date.now() + i + Math.random(),
                        image: imgUrl,
                        realName: r['Real Name'] || '',
                        conventionalName: r['Conventional Name'] || '',
                        barcode: r['Barcode'] || '',
                        repetitionBarcode: r['Repetition Barcode'] || '',
                        category: r['Category'] || '',
                        brand: r['Brand'] || '',
                        reference: r['R√©f√©rence'] || '',
                        quantity: parseInt(r['Selling Price']) || 0,
                        createdAt: new Date().toISOString()
                    });
                    count++;
                    pf.style.width = Math.round((i+1)/rows.length*100) + '%';
                    pt.textContent = `${i+1} / ${rows.length}`;
                    if (i % 100 === 0) await new Promise(r => setTimeout(r, 10));
                }
                saveData();
                renderProducts();
                updateDashboard();
                setTimeout(() => {
                    pb.classList.add('hidden');
                    alert(`‚úÖ ${count} produits import√©s !`);
                }, 500);
            } catch (err) {
                document.getElementById('import-progress').classList.add('hidden');
                alert('‚ùå Erreur: ' + err.message);
            }
            e.target.value = '';
        });

        function handleExport() {
            const data = products.map(p => ({
                'IMAGE': p.image, 'Real Name': p.realName, 'Conventional Name': p.conventionalName,
                'Selling Price': p.quantity, 'Barcode': p.barcode, 'Repetition Barcode': p.repetitionBarcode,
                'Category': p.category, 'Brand': p.brand, 'R√©f√©rence': p.reference
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `stock_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function renderMovementProducts() {
            document.getElementById('movement-products').innerHTML = products.map(p => `
                <tr>
                    <td><input type="checkbox" class="product-check" data-id="${p.id}"></td>
                    <td>${p.realName}</td>
                    <td>${p.quantity}</td>
                    <td><input type="number" class="form-input" id="qty-${p.id}" min="1" style="width:100px;" placeholder="Qty"></td>
                </tr>
            `).join('');
        }

        document.getElementById('select-all-movement').addEventListener('change', function() {
            document.querySelectorAll('.product-check').forEach(cb => cb.checked = this.checked);
        });

        document.getElementById('movement-reason').addEventListener('change', function() {
            document.getElementById('client-name-group').style.display = this.value === 'Vente' ? 'block' : 'none';
        });

        document.getElementById('validate-movement-btn').addEventListener('click', function() {
            const type = document.getElementById('movement-type').value;
            const reason = document.getElementById('movement-reason').value;
            const clientName = document.getElementById('client-name').value;
            const selected = Array.from(document.querySelectorAll('.product-check:checked'));
            
            if (selected.length === 0) return alert('‚ö†Ô∏è S√©lectionnez des produits');
            if (!reason) return alert('‚ö†Ô∏è S√©lectionnez une raison');
            if (reason === 'Vente' && !clientName.trim()) return alert('‚ö†Ô∏è Entrez le nom du client');

            const toProcess = [];
            for (let cb of selected) {
                const id = parseInt(cb.dataset.id);
                const product = products.find(p => p.id === id);
                const qty = parseInt(document.getElementById(`qty-${id}`).value) || 0;
                if (qty <= 0) return alert(`‚ö†Ô∏è Quantit√© invalide pour ${product.realName}`);
                if (type === 'out' && product.quantity < qty) return alert(`‚ùå Stock insuffisant pour ${product.realName}\nStock: ${product.quantity}, Demand√©: ${qty}`);
                toProcess.push({ product, qty });
            }

            toProcess.forEach(({ product, qty }) => {
                if (type === 'in') product.quantity += qty;
                else product.quantity -= qty;
                movements.push({
                    id: Date.now() + Math.random(),
                    productId: product.id,
                    productName: product.realName,
                    type: type,
                    reason: reason,
                    quantity: qty,
                    clientName: reason === 'Vente' ? clientName : '',
                    date: new Date().toISOString()
                });
            });

            saveData();
            document.getElementById('movement-type').value = 'in';
            document.getElementById('movement-reason').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-name-group').style.display = 'none';
            document.querySelectorAll('.product-check').forEach(cb => cb.checked = false);
            document.getElementById('select-all-movement').checked = false;
            renderMovementProducts();
            updateDashboard();
            alert(`‚úÖ Mouvement enregistr√© !\n${toProcess.length} produit(s) trait√©(s)`);
        });

        function renderReturns() {
            const sales = movements.filter(m => m.reason === 'Vente');
            document.getElementById('sales-table').innerHTML = sales.map(s => `
                <tr>
                    <td>${new Date(s.date).toLocaleDateString()}</td>
                    <td>${s.productName}</td>
                    <td>${s.clientName}</td>
                    <td>${s.quantity}</td>
                    <td><button class="btn btn-orange" onclick="handleReturn(${s.id})" style="padding:0.4rem 0.8rem;font-size:0.85rem;">üîÑ Retour</button></td>
                </tr>
            `).join('');
            document.getElementById('returns-table').innerHTML = returns.map(r => `
                <tr>
                    <td>${new Date(r.date).toLocaleDateString()}</td>
                    <td>${r.productName}</td>
                    <td>${r.clientName}</td>
                    <td>${r.quantity}</td>
                    <td>${r.reason}</td>
                </tr>
            `).join('');
        }

        function handleReturn(saleId) {
            const sale = movements.find(m => m.id === saleId);
            if (!sale) return;
            const returnQty = parseInt(prompt(`Quantit√© retourn√©e (max: ${sale.quantity}):`));
            if (!returnQty || returnQty <= 0 || returnQty > sale.quantity) return alert('‚ùå Quantit√© invalide');
            const returnReason = prompt('Raison du retour (ex: Client refuse):');
            if (!returnReason || !returnReason.trim()) return alert('‚ùå Entrez une raison');
            const product = products.find(p => p.id === sale.productId);
            if (product) {
                product.quantity += returnQty;
                returns.push({
                    id: Date.now(),
                    saleId: saleId,
                    productId: sale.productId,
                    productName: sale.productName,
                    clientName: sale.clientName,
                    quantity: returnQty,
                    reason: returnReason,
                    date: new Date().toISOString()
                });
                saveData();
                renderReturns();
                updateDashboard();
                alert(`‚úÖ Retour enregistr√© !\n${returnQty} ${sale.productName} remis en stock`);
            }
        }

        updateDashboard();
    </script>
</body>
</html>
