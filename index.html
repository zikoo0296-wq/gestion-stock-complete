<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .nav-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .nav-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: #666; transition: 0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #2563eb; color: white; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid; }
        .stat-card.blue { border-color: #2563eb; }
        .stat-card.green { border-color: #10b981; }
        .stat-card.red { border-color: #ef4444; }
        .stat-card.orange { border-color: #f59e0b; }
        .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap; }
        .card-title { font-size: 1.3rem; font-weight: bold; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.7rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.3s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .search-input { flex: 1; max-width: 400px; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        tr:hover { background: #f9fafb; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; }
        .progress-container { margin: 1rem 0; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
        .progress-text { margin-top: 0.5rem; text-align: center; color: #666; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 0.5rem; display: flex; gap: 1rem; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .image-modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .hidden { display: none; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        input[type="file"] { display: none; }
        .pdv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .pdv-card { background: #f9fafb; padding: 1rem; border-radius: 8px; border: 2px solid transparent; }
        .pdv-card:hover { border-color: #93c5fd; }
        .pdv-name { font-weight: 600; margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">üì¶ Stock Pro</div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="showPage('products')">üì¶ Produits</button>
                <button class="nav-btn" onclick="showPage('movements')">üîÑ Mouvements</button>
                <button class="nav-btn" onclick="showPage('pointsVente')">üè™ Points de Vente</button>
                <button class="nav-btn" onclick="showPage('history')">üìú Historique</button>
            </div>
        </div>
    </div>

    <div class="container" id="app-container"></div>
    <div class="toast-container" id="toast-container"></div>

    <div class="image-modal" id="image-modal" onclick="closeImageModal()">
        <div class="image-modal-close" onclick="closeImageModal()">‚úï</div>
        <img id="modal-image" src="" onclick="event.stopPropagation();">
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Ajouter un produit</h2>
                <button class="close-btn" onclick="closeProductModal()">√ó</button>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" id="product-image">
                </div>
                <div class="form-group">
                    <label>Nom *</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Nom commercial</label>
                    <input type="text" id="product-conventional">
                </div>
                <div class="form-group">
                    <label>R√©f√©rence *</label>
                    <input type="text" id="product-ref" required>
                </div>
                <div class="form-group">
                    <label>Code-barres</label>
                    <input type="text" id="product-barcode">
                </div>
                <div class="form-group">
                    <label>Cat√©gorie</label>
                    <input type="text" id="product-category">
                </div>
                <div class="form-group">
                    <label>Marque</label>
                    <input type="text" id="product-brand">
                </div>
                <div class="form-group">
                    <label>Prix *</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="product-quantity" value="0">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Importer depuis Excel</h2>
                <button class="close-btn" onclick="closeImportModal()">√ó</button>
            </div>
            <div style="margin-bottom:1rem;">
                <p style="margin-bottom:0.5rem;"><strong>Format Excel attendu :</strong></p>
                <p style="color:#666;font-size:0.9rem;line-height:1.6;margin-bottom:1rem;">
                    IMAGE | Real Name | Conventional Name | R√©f√©rence | Barcode | Repetition | Category | Brand | QTY [Nom PDV] | QTY [Nom PDV] | ...
                </p>
                <p style="color:#666;font-size:0.85rem;line-height:1.6;margin-bottom:1rem;">
                    Les colonnes <strong>QTY XXX</strong> repr√©sentent le stock de chaque point de vente (ex: QTY Al Baraka, QTY Roche Noire, QTY ALGHAFLA)<br>
                    Le syst√®me d√©tectera automatiquement tous les points de vente et distribuera le stock selon chaque colonne QTY.
                </p>
                <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleImport(event)">
                <button class="btn btn-primary" onclick="document.getElementById('excel-file').click()" style="font-size:1rem;">
                    üìÅ Choisir un fichier
                </button>
            </div>
            <div id="import-progress" class="progress-container hidden">
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <div class="progress-text" id="progress-text"></div>
            </div>
        </div>
    </div>

    <script>
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let movements = JSON.parse(localStorage.getItem('movements')) || [];
        let pointsVente = JSON.parse(localStorage.getItem('pointsVente')) || [];
        let currentPage = 'dashboard';
        let editingProduct = null;

        function showToast(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = `<div>${type === 'success' ? '‚úì' : '‚úó'}</div><div>${msg}</div>`;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => {
                if ((page === 'dashboard' && b.textContent.includes('Dashboard')) ||
                    (page === 'products' && b.textContent.includes('Produits')) ||
                    (page === 'movements' && b.textContent.includes('Mouvements')) ||
                    (page === 'pointsVente' && b.textContent.includes('Points')) ||
                    (page === 'history' && b.textContent.includes('Historique'))) {
                    b.classList.add('active');
                }
            });
            
            if (page === 'dashboard') renderDashboard();
            else if (page === 'products') renderProducts();
            else if (page === 'movements') renderMovements();
            else if (page === 'pointsVente') renderPointsVente();
            else if (page === 'history') renderHistory();
        }

        function renderDashboard() {
            const total = products.length;
            const stock = products.reduce((s, p) => s + (p.quantity || 0), 0);
            const low = products.filter(p => (p.quantity || 0) < 10).length;
            const value = products.reduce((s, p) => s + ((p.quantity || 0) * (p.price || 0)), 0);

            document.getElementById('app-container').innerHTML = `
                <div class="card"><input type="text" id="dash-search" class="search-input" placeholder="üîç Rechercher..." style="width:100%;"></div>
                <div class="stats-grid">
                    <div class="stat-card blue"><div class="stat-label">Produits</div><div class="stat-value">${total}</div></div>
                    <div class="stat-card green"><div class="stat-label">Stock Total</div><div class="stat-value">${stock}</div></div>
                    <div class="stat-card red"><div class="stat-label">Alertes</div><div class="stat-value">${low}</div></div>
                    <div class="stat-card orange"><div class="stat-label">Valeur</div><div class="stat-value">${value.toFixed(2)} DH</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üö® Alertes (stock < 10)</h3></div>
                    <div class="table-container"><table><thead><tr><th>Produit</th><th>R√©f√©rence</th><th>Stock</th></tr></thead>
                    <tbody id="dash-body">${renderAlerts(products.filter(p => (p.quantity || 0) < 10))}</tbody></table></div>
                </div>
            `;

            document.getElementById('dash-search').oninput = function() {
                const s = this.value.toLowerCase();
                const f = products.filter(p => (p.quantity || 0) < 10 && (p.name.toLowerCase().includes(s) || p.reference.toLowerCase().includes(s)));
                document.getElementById('dash-body').innerHTML = renderAlerts(f);
            };
        }

        function renderAlerts(list) {
            if (list.length === 0) return '<tr><td colspan="3" style="text-align:center;">Aucune alerte</td></tr>';
            return list.map(p => `<tr><td><strong>${p.name}</strong></td><td>${p.reference}</td><td style="color:#ef4444;"><strong>${p.quantity || 0}</strong></td></tr>`).join('');
        }

        function renderProducts() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üì¶ Gestion des produits</h3>
                        <div class="btn-group">
                            <input type="text" id="prod-search" class="search-input" placeholder="üîç Rechercher un produit...">
                            <button class="btn btn-primary" onclick="openProductModal()">‚ûï Ajouter</button>
                            <button class="btn btn-success" onclick="openImportModal()">üì§ Importer Excel</button>
                            <button class="btn btn-warning" onclick="exportProducts()">üì• Exporter Excel</button>
                            <button class="btn btn-danger" onclick="deleteSel()" id="del-btn" style="display:none;">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:50px;"><input type="checkbox" onclick="toggleAll(this)"></th>
                                    <th style="width:80px;">Image</th>
                                    <th>Nom</th>
                                    <th>R√©f√©rence</th>
                                    <th>Code-barres</th>
                                    <th>Cat√©gorie</th>
                                    <th>Marque</th>
                                    <th style="width:100px;">Stock</th>
                                    <th style="width:120px;">Prix</th>
                                    <th style="width:150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="prod-body">${renderProdRows(products)}</tbody>
                        </table>
                    </div>
                    ${products.length === 0 ? '<div style="text-align:center;padding:3rem;color:#666;font-size:1.1rem;">Aucun produit trouv√©</div>' : ''}
                </div>
            `;

            document.getElementById('prod-search').oninput = function() {
                const s = this.value.toLowerCase();
                const f = products.filter(p => 
                    p.name.toLowerCase().includes(s) || 
                    p.reference.toLowerCase().includes(s) ||
                    (p.barcode || '').toLowerCase().includes(s) ||
                    (p.category || '').toLowerCase().includes(s) ||
                    (p.brand || '').toLowerCase().includes(s)
                );
                document.getElementById('prod-body').innerHTML = renderProdRows(f);
                attachCB();
            };
            attachCB();
        }

        function renderProdRows(list) {
            if (list.length === 0) return '<tr><td colspan="10" style="text-align:center;padding:2rem;color:#666;">Aucun produit trouv√©</td></tr>';
            
            return list.map(p => {
                let img = 'üì¶';
                if (p.image) {
                    const match = p.image.match(/[?&]id=([^&]+)/);
                    if (match) {
                        const id = match[1];
                        img = `<img src="https://drive.google.com/thumbnail?id=${id}&sz=w200" class="product-img" onclick="openImgModal('${p.image}')" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2224%22%3Eüì¶%3C/text%3E%3C/svg%3E';" style="width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;">`;
                    }
                }
                
                return `
                    <tr>
                        <td><input type="checkbox" class="cb" data-ref="${p.reference}"></td>
                        <td>${img}</td>
                        <td>
                            <strong style="display:block;">${p.name}</strong>
                            ${p.conventionalName ? `<small style="color:#666;">${p.conventionalName}</small>` : ''}
                        </td>
                        <td>${p.reference}</td>
                        <td>${p.barcode || '-'}</td>
                        <td>${p.category || '-'}</td>
                        <td>${p.brand || '-'}</td>
                        <td><strong style="font-size:1.1rem;">${p.quantity || 0}</strong></td>
                        <td><strong>${p.price.toFixed(2)} DH</strong></td>
                        <td>
                            <button class="btn btn-primary" onclick='editP("${p.reference}")' style="padding:0.4rem 0.8rem;margin-right:0.3rem;">‚úèÔ∏è Modifier</button>
                            <button class="btn btn-danger" onclick='delP("${p.reference}")' style="padding:0.4rem 0.8rem;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openImgModal(src) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-image');
            const match = src.match(/[?&]id=([^&]+)/);
            if (match) {
                const id = match[1];
                // Essayer d'abord le format uc?export=view
                img.src = `https://drive.google.com/uc?export=view&id=${id}`;
                
                // Si √©chec, essayer thumbnail
                img.onerror = function() {
                    if (this.src.includes('uc?export=view')) {
                        this.src = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
                        this.onerror = function() {
                            this.src = `https://lh3.googleusercontent.com/d/${id}=w1000`;
                            this.onerror = null;
                        };
                    }
                };
            } else {
                img.src = src;
            }
            modal.classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        function attachCB() {
            document.querySelectorAll('.cb').forEach(c => {
                c.onchange = function() {
                    const n = document.querySelectorAll('.cb:checked').length;
                    const b = document.getElementById('del-btn');
                    b.style.display = n > 0 ? 'inline-block' : 'none';
                    b.textContent = `üóëÔ∏è (${n})`;
                };
            });
        }

        function toggleAll(c) {
            document.querySelectorAll('.cb').forEach(x => x.checked = c.checked);
            document.querySelectorAll('.cb')[0]?.dispatchEvent(new Event('change'));
        }

        function deleteSel() {
            const refs = Array.from(document.querySelectorAll('.cb:checked')).map(c => c.dataset.ref);
            if (!confirm(`Supprimer ${refs.length} produit(s) ?`)) return;
            products = products.filter(p => !refs.includes(p.reference));
            pointsVente.forEach(pdv => { if (pdv.products) pdv.products = pdv.products.filter(p => !refs.includes(p.reference)); });
            save();
            savePDV();
            showToast(`${refs.length} supprim√©(s)`);
            renderProducts();
        }

        function editP(ref) {
            const p = products.find(x => x.reference === ref);
            if (!p) return;
            editingProduct = p;
            document.getElementById('modal-title').textContent = 'Modifier';
            document.getElementById('product-image').value = p.image || '';
            document.getElementById('product-name').value = p.name;
            document.getElementById('product-conventional').value = p.conventionalName || '';
            document.getElementById('product-ref').value = p.reference;
            document.getElementById('product-barcode').value = p.barcode || '';
            document.getElementById('product-category').value = p.category || '';
            document.getElementById('product-brand').value = p.brand || '';
            document.getElementById('product-price').value = p.price;
            document.getElementById('product-quantity').value = p.quantity || 0;
            document.getElementById('product-modal').classList.add('active');
        }

        function delP(ref) {
            if (!confirm('Supprimer ?')) return;
            products = products.filter(p => p.reference !== ref);
            pointsVente.forEach(pdv => { if (pdv.products) pdv.products = pdv.products.filter(p => p.reference !== ref); });
            save();
            savePDV();
            showToast('Supprim√©');
            renderProducts();
        }

        function openProductModal() {
            editingProduct = null;
            document.getElementById('modal-title').textContent = 'Ajouter';
            document.getElementById('product-form').reset();
            document.getElementById('product-modal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        document.getElementById('product-form').onsubmit = function(e) {
            e.preventDefault();
            const data = {
                image: document.getElementById('product-image').value,
                name: document.getElementById('product-name').value,
                conventionalName: document.getElementById('product-conventional').value,
                reference: document.getElementById('product-ref').value,
                barcode: document.getElementById('product-barcode').value,
                category: document.getElementById('product-category').value,
                brand: document.getElementById('product-brand').value,
                price: parseFloat(document.getElementById('product-price').value),
                quantity: parseInt(document.getElementById('product-quantity').value) || 0
            };

            if (editingProduct) {
                const i = products.findIndex(p => p.reference === editingProduct.reference);
                products[i] = { ...products[i], ...data };
                showToast('Modifi√©');
            } else {
                if (products.some(p => p.reference === data.reference)) {
                    showToast('R√©f√©rence existe', 'error');
                    return;
                }
                products.push(data);
                showToast('Ajout√©');
            }

            save();
            closeProductModal();
            renderProducts();
        };

        function openImportModal() {
            document.getElementById('import-modal').classList.add('active');
            document.getElementById('import-progress').classList.add('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
        }

        async function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const pg = document.getElementById('import-progress');
            const fill = document.getElementById('progress-fill');
            const txt = document.getElementById('progress-text');
            
            pg.classList.remove('hidden');
            fill.style.width = '0%';
            txt.textContent = 'Lecture...';

            try {
                const data = await file.arrayBuffer();
                
                // Parser Excel RAPIDE
                const wb = XLSX.read(data, {
                    cellFormula: false,
                    cellHTML: false,
                    cellStyles: false,
                    sheetStubs: false,
                    dense: true
                });
                
                const allRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {
                    raw: false,
                    defval: '',
                    blankrows: false
                });

                console.log('Total lignes Excel:', allRows.length);
                console.log('Colonnes d√©tect√©es:', Object.keys(allRows[0]));
                console.log('Premi√®re ligne exemple:', allRows[0]);

                // FILTRER lignes vides - v√©rifier plusieurs colonnes
                const rows = allRows.filter(r => {
                    // Une ligne est valide SI elle a une r√©f√©rence ET un nom
                    const hasRef = r['R√©f√©rence'] && r['R√©f√©rence'].toString().trim() && 
                                  !r['R√©f√©rence'].toString().includes('drive.google.com');
                    const hasName = r['Real Name'] && r['Real Name'].toString().trim() && 
                                   !r['Real Name'].toString().includes('drive.google.com');
                    return hasRef && hasName;
                });

                console.log(`Produits filtr√©s: ${rows.length}`);

                if (rows.length === 0) { 
                    showToast('Aucun produit trouv√©', 'error'); 
                    closeImportModal(); 
                    return; 
                }

                txt.textContent = `${rows.length} produits d√©tect√©s`;
                fill.style.width = '20%';

                // D√©tecter colonnes PDV (QTY suivi d'un nom)
                const cols = Object.keys(rows[0]);
                const pdvCols = cols.filter(c => {
                    const upper = c.toUpperCase();
                    return upper.includes('QTY') || upper.startsWith('QT√â');
                });
                
                console.log('Colonnes PDV trouv√©es:', pdvCols);
                
                // Cr√©er PDV
                pdvCols.forEach(c => {
                    let n = c.replace(/QTY/gi, '').replace(/QT√â/gi, '').trim();
                    if (n && !pointsVente.find(p => p.name === n)) {
                        pointsVente.push({ 
                            id: `pdv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, 
                            name: n, 
                            products: [] 
                        });
                        console.log('PDV cr√©√©:', n);
                    }
                });

                txt.textContent = 'Traitement...';
                fill.style.width = '30%';

                // TRAITEMENT ULTRA-RAPIDE
                const batchSize = 500;
                const allData = [];
                
                for (let i = 0; i < rows.length; i += batchSize) {
                    const batch = rows.slice(i, i + batchSize);
                    
                    batch.forEach((r, idx) => {
                        // IMAGE - chercher dans toutes les colonnes
                        let img = '';
                        
                        // V√©rifier colonne IMAGE
                        if (r['IMAGE'] && r['IMAGE'].toString().trim()) {
                            img = r['IMAGE'].toString().trim();
                        }
                        // Si pas dans IMAGE, chercher dans Real Name si c'est une URL
                        else if (r['Real Name'] && r['Real Name'].toString().includes('drive.google.com')) {
                            img = r['Real Name'].toString().trim();
                        }
                        // Chercher dans R√©f√©rence
                        else if (r['R√©f√©rence'] && r['R√©f√©rence'].toString().includes('drive.google.com')) {
                            img = r['R√©f√©rence'].toString().trim();
                        }
                        
                        // Convertir URL Google Drive
                        if (img && img.includes('drive.google.com')) {
                            const m = img.match(/\/d\/([^/\?]+)/) || img.match(/[?&]id=([^&]+)/);
                            if (m) img = `https://drive.google.com/uc?export=view&id=${m[1]}`;
                        }

                        // Real Name - chercher dans les colonnes
                        let name = '';
                        if (r['Real Name'] && !r['Real Name'].toString().includes('drive.google.com')) {
                            name = r['Real Name'].toString().trim();
                        } else if (r['Conventional Name'] && !r['Conventional Name'].toString().includes('drive.google.com')) {
                            name = r['Conventional Name'].toString().trim();
                        }

                        // R√©f√©rence - OBLIGATOIRE, ne jamais g√©n√©rer
                        let ref = '';
                        if (r['R√©f√©rence'] && !r['R√©f√©rence'].toString().includes('drive.google.com')) {
                            ref = r['R√©f√©rence'].toString().trim();
                        }
                        
                        // Si pas de r√©f√©rence valide, IGNORER ce produit
                        if (!ref) {
                            console.warn(`Produit ignor√© (pas de r√©f√©rence): ligne ${i + idx + 2}`);
                            return;
                        }
                        
                        if (!name) {
                            console.warn(`Produit sans nom, utilise r√©f√©rence: ${ref}`);
                            name = ref;
                        }

                        // Calculer quantit√© totale
                        let totalQty = 0;
                        const pdvQtys = {};
                        
                        pdvCols.forEach(c => {
                            const val = r[c];
                            const q = val ? parseInt(val.toString().replace(/[^\d]/g, '')) || 0 : 0;
                            totalQty += q;
                            const n = c.replace(/QTY/gi, '').replace(/QT√â/gi, '').trim();
                            if (n) pdvQtys[n] = q;
                        });

                        allData.push({
                            prod: {
                                image: img,
                                name: name,
                                conventionalName: (r['Conventional Name'] || '').toString().trim(),
                                reference: ref,
                                barcode: (r['Barcode'] || r['Code-barres'] || '').toString().trim(),
                                category: (r['Category'] || r['Cat√©gorie'] || '').toString().trim(),
                                brand: (r['Brand'] || r['Marque'] || '').toString().trim(),
                                price: parseFloat((r['Selling Price'] || r['Prix'] || '0').toString().replace(/[^\d.]/g, '')) || 0,
                                quantity: totalQty
                            },
                            ref,
                            pdvQtys
                        });
                    });

                    const percent = 30 + Math.round(((i + batch.length) / rows.length) * 60);
                    fill.style.width = percent + '%';
                    txt.textContent = `${i + batch.length}/${rows.length}`;
                    
                    await new Promise(r => setTimeout(r, 1));
                }

                console.log('Produits trait√©s:', allData.length);
                
                txt.textContent = 'Sauvegarde...';
                fill.style.width = '90%';

                // Mise √† jour RAPIDE
                allData.forEach(({ prod, ref, pdvQtys }) => {
                    const idx = products.findIndex(p => p.reference === ref);
                    if (idx >= 0) {
                        products[idx] = { ...prod, image: prod.image || products[idx].image };
                    } else {
                        products.push(prod);
                    }

                    // MAJ PDV
                    Object.entries(pdvQtys).forEach(([pdvName, qty]) => {
                        const pdv = pointsVente.find(p => p.name === pdvName);
                        if (pdv && qty > 0) {
                            if (!pdv.products) pdv.products = [];
                            const pi = pdv.products.findIndex(p => p.reference === ref);
                            if (pi >= 0) pdv.products[pi].quantity = qty;
                            else pdv.products.push({ reference: ref, quantity: qty });
                        }
                    });
                });

                save();
                savePDV();
                
                fill.style.width = '100%';
                txt.textContent = `‚úì ${allData.length} import√©s !`;
                console.log('Import termin√©:', allData.length, 'produits');
                showToast(`${allData.length} produits import√©s`, 'success');
                
                setTimeout(() => {
                    closeImportModal();
                    if (currentPage === 'products') renderProducts();
                }, 1000);

            } catch (err) {
                console.error('ERREUR:', err);
                txt.textContent = '‚ùå ' + err.message;
                showToast('Erreur: ' + err.message, 'error');
            }
        }

        function exportProducts() {
            if (products.length === 0) { showToast('Aucun produit', 'warning'); return; }

            const data = products.map(p => {
                const r = {
                    'IMAGE': p.image || '',
                    'Real Name': p.name,
                    'Conventional Name': p.conventionalName || '',
                    'R√©f√©rence': p.reference,
                    'Barcode': p.barcode || '',
                    'Repetition': p.quantity || 0,
                    'Category': p.category || '',
                    'Brand': p.brand || ''
                };
                pointsVente.forEach(pdv => {
                    const pp = pdv.products?.find(x => x.reference === p.reference);
                    r[`QTY ${pdv.name}`] = pp?.quantity || 0;
                });
                return r;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `produits_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Export√©');
        }

        function renderMovements() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîÑ Mouvements</h3>
                        <input type="text" id="mov-search" class="search-input" placeholder="üîç">
                    </div>
                    <div style="background:#f9fafb;padding:1.5rem;border-radius:8px;margin-bottom:1.5rem;">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;">
                            <div><label style="display:block;margin-bottom:0.5rem;font-weight:600;">Type</label>
                                <select id="mov-type" onchange="updMov()" style="width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:8px;">
                                    <option value="in">Entr√©e (+)</option><option value="out">Sortie (-)</option><option value="transfer">Transfert</option>
                                </select>
                            </div>
                            <div id="reas"><label style="display:block;margin-bottom:0.5rem;font-weight:600;">Raison</label>
                                <select id="mov-reas" style="width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:8px;">
                                    <option value="Achat">Achat</option><option value="Vente">Vente</option><option value="Retour">Retour</option>
                                </select>
                            </div>
                            <div id="src" style="display:none;"><label style="display:block;margin-bottom:0.5rem;font-weight:600;">Source</label>
                                <select id="pdv-src" style="width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:8px;">
                                    <option value="">Central</option>${pointsVente.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div id="dst" style="display:none;"><label style="display:block;margin-bottom:0.5rem;font-weight:600;">Destination</label>
                                <select id="pdv-dst" style="width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:8px;">
                                    <option value="">Central</option>${pointsVente.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div><label style="display:block;margin-bottom:0.5rem;font-weight:600;">Note</label>
                                <input type="text" id="mov-note" style="width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:8px;">
                            </div>
                        </div>
                        <div style="text-align:center;"><button class="btn btn-success" onclick="valMov()" style="padding:0.9rem 3rem;">‚úì VALIDER</button></div>
                    </div>
                    <div class="table-container"><table><thead><tr><th><input type="checkbox" onclick="togMov(this)"></th><th>Produit</th><th>Stock</th><th>Quantit√©</th></tr></thead>
                    <tbody id="mov-body">${renderMovRows(products)}</tbody></table></div>
                </div>
            `;

            document.querySelectorAll('.mck').forEach(c => {
                c.onchange = function() {
                    const inp = document.querySelector(`.mqt[data-ref="${this.dataset.ref}"]`);
                    if (inp) { inp.disabled = !this.checked; if (!this.checked) inp.value = ''; }
                };
            });

            document.getElementById('mov-search').oninput = function() {
                const s = this.value.toLowerCase();
                const f = products.filter(p => p.name.toLowerCase().includes(s) || p.reference.toLowerCase().includes(s));
                document.getElementById('mov-body').innerHTML = renderMovRows(f);
                document.querySelectorAll('.mck').forEach(c => {
                    c.onchange = function() {
                        const inp = document.querySelector(`.mqt[data-ref="${this.dataset.ref}"]`);
                        if (inp) { inp.disabled = !this.checked; if (!this.checked) inp.value = ''; }
                    };
                });
            };
        }

        function renderMovRows(list) {
            if (list.length === 0) return '<tr><td colspan="4" style="text-align:center;">Aucun produit</td></tr>';
            return list.map(p => `
                <tr>
                    <td><input type="checkbox" class="mck" data-ref="${p.reference}"></td>
                    <td><strong>${p.name}</strong></td>
                    <td><strong>${p.quantity || 0}</strong></td>
                    <td><input type="number" class="mqt" data-ref="${p.reference}" min="1" style="width:100px;padding:0.5rem;" disabled></td>
                </tr>
            `).join('');
        }

        function updMov() {
            const t = document.getElementById('mov-type').value;
            document.getElementById('reas').style.display = t === 'transfer' ? 'none' : 'block';
            document.getElementById('src').style.display = t === 'transfer' ? 'block' : 'none';
            document.getElementById('dst').style.display = t === 'transfer' ? 'block' : 'none';
        }

        function togMov(c) {
            document.querySelectorAll('.mck').forEach(x => { x.checked = c.checked; x.dispatchEvent(new Event('change')); });
        }

        function valMov() {
            const type = document.getElementById('mov-type').value;
            const reas = document.getElementById('mov-reas')?.value;
            const note = document.getElementById('mov-note').value;
            
            const items = [];
            document.querySelectorAll('.mck:checked').forEach(c => {
                const q = parseInt(document.querySelector(`.mqt[data-ref="${c.dataset.ref}"]`).value) || 0;
                if (q > 0) items.push({ reference: c.dataset.ref, quantity: q });
            });

            if (items.length === 0) { showToast('S√©lectionnez des produits', 'warning'); return; }

            if (type === 'transfer') {
                const src = document.getElementById('pdv-src').value;
                const dst = document.getElementById('pdv-dst').value;
                if (src === dst) { showToast('Source ‚â† Destination', 'error'); return; }

                let cnt = 0;
                items.forEach(it => {
                    const p = products.find(x => x.reference === it.reference);
                    if (!p) return;

                    if (src === '') {
                        if ((p.quantity || 0) < it.quantity) { showToast(`Stock insuffisant: ${p.name}`, 'error'); return; }
                        p.quantity -= it.quantity;
                    } else {
                        const ps = pointsVente.find(x => x.id === src);
                        const pp = ps.products?.find(x => x.reference === it.reference);
                        if (!pp || pp.quantity < it.quantity) { showToast(`PDV insuffisant: ${p.name}`, 'error'); return; }
                        pp.quantity -= it.quantity;
                    }

                    if (dst === '') {
                        p.quantity += it.quantity;
                    } else {
                        const pd = pointsVente.find(x => x.id === dst);
                        if (!pd.products) pd.products = [];
                        const pp = pd.products.find(x => x.reference === it.reference);
                        if (pp) pp.quantity += it.quantity;
                        else pd.products.push({ reference: it.reference, quantity: it.quantity });
                    }

                    const tot = pointsVente.reduce((s, pdv) => {
                        const pp = pdv.products?.find(x => x.reference === it.reference);
                        return s + (pp?.quantity || 0);
                    }, 0);
                    p.quantity = tot;

                    const sn = src ? pointsVente.find(x => x.id === src)?.name : 'Central';
                    const dn = dst ? pointsVente.find(x => x.id === dst)?.name : 'Central';

                    movements.push({
                        id: Date.now() + Math.random(),
                        date: new Date().toISOString(),
                        type: 'transfer',
                        reason: `${sn} ‚Üí ${dn}`,
                        note,
                        product: p.name,
                        reference: it.reference,
                        quantity: it.quantity
                    });
                    cnt++;
                });

                if (cnt > 0) { save(); savePDV(); saveMov(); showToast(`${cnt} transfert(s)`); renderMovements(); }
                return;
            }

            let cnt = 0;
            items.forEach(it => {
                const p = products.find(x => x.reference === it.reference);
                if (!p) return;

                const old = p.quantity || 0;
                let newQ;

                if (type === 'in') {
                    newQ = old + it.quantity;
                } else {
                    if (old < it.quantity) { showToast(`Stock insuffisant: ${p.name}`, 'error'); return; }
                    newQ = old - it.quantity;
                }

                p.quantity = newQ;

                movements.push({
                    id: Date.now() + Math.random(),
                    date: new Date().toISOString(),
                    type,
                    reason: reas,
                    note,
                    product: p.name,
                    reference: it.reference,
                    quantity: it.quantity,
                    oldQuantity: old,
                    newQuantity: newQ
                });
                cnt++;
            });

            if (cnt > 0) { save(); saveMov(); showToast(`${cnt} mouvement(s)`); renderMovements(); }
        }

        function renderPointsVente() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè™ Points de Vente</h3>
                        <div class="btn-group">
                            <input type="text" id="pdv-search" class="search-input" placeholder="üîç">
                            <button class="btn btn-primary" onclick="addPDV()">‚ûï PDV</button>
                        </div>
                    </div>
                    <div class="pdv-grid">
                        ${pointsVente.map(p => `<div class="pdv-card"><div class="pdv-name">${p.name}</div><button class="btn btn-primary" onclick="viewPDV('${p.id}')" style="margin-top:0.5rem;width:100%;padding:0.4rem;">Voir</button></div>`).join('') || '<p style="text-align:center;color:#666;">Aucun PDV</p>'}
                    </div>
                    <div style="margin-top:2rem;">
                        <h4 style="margin-bottom:1rem;">üìä Vue d'ensemble</h4>
                        <div class="table-container"><table><thead><tr><th>Produit</th><th>Total</th>${pointsVente.map(p => `<th>${p.name}</th>`).join('')}</tr></thead>
                        <tbody id="pdv-ov">${renderPDVOv(products)}</tbody></table></div>
                    </div>
                </div>
            `;

            document.getElementById('pdv-search').oninput = function() {
                const s = this.value.toLowerCase();
                const f = products.filter(p => p.name.toLowerCase().includes(s) || p.reference.toLowerCase().includes(s));
                document.getElementById('pdv-ov').innerHTML = renderPDVOv(f);
            };
        }

        function renderPDVOv(list) {
            if (list.length === 0) return '<tr><td colspan="100" style="text-align:center;">Aucun produit</td></tr>';
            return list.map(p => {
                const tot = pointsVente.reduce((s, pdv) => {
                    const pp = pdv.products?.find(x => x.reference === p.reference);
                    return s + (pp?.quantity || 0);
                }, 0);
                return `<tr><td><strong>${p.name}</strong></td><td><strong style="color:#2563eb;">${tot}</strong></td>${pointsVente.map(pdv => {
                    const pp = pdv.products?.find(x => x.reference === p.reference);
                    return `<td>${pp?.quantity || 0}</td>`;
                }).join('')}</tr>`;
            }).join('');
        }

        function addPDV() {
            const n = prompt('Nom du PDV:');
            if (!n || !n.trim()) return;
            pointsVente.push({ id: Date.now().toString(), name: n.trim(), products: [] });
            savePDV();
            showToast('PDV ajout√©');
            renderPointsVente();
        }

        function viewPDV(id) {
            const pdv = pointsVente.find(p => p.id === id);
            if (!pdv) return;

            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè™ ${pdv.name}</h3>
                        <button class="btn btn-secondary" onclick="renderPointsVente()">‚Üê Retour</button>
                    </div>
                    <div class="table-container"><table><thead><tr><th>Produit</th><th>Central</th><th>PDV</th><th>Transf√©rer</th><th>Action</th></tr></thead>
                    <tbody>
                        ${products.map(p => {
                            const pp = pdv.products?.find(x => x.reference === p.reference);
                            return `<tr><td><strong>${p.name}</strong></td><td>${p.quantity || 0}</td><td>${pp?.quantity || 0}</td>
                                <td><input type="number" id="t-${p.reference}" min="1" max="${p.quantity || 0}" style="width:100px;padding:0.5rem;"></td>
                                <td><button class="btn btn-primary" onclick="transTo('${id}','${p.reference}')" style="padding:0.4rem 0.8rem;">‚û°Ô∏è</button></td></tr>`;
                        }).join('')}
                    </tbody></table></div>
                </div>
            `;
        }

        function transTo(pdvId, ref) {
            const pdv = pointsVente.find(p => p.id === pdvId);
            const prod = products.find(p => p.reference === ref);
            const q = parseInt(document.getElementById(`t-${ref}`).value) || 0;

            if (q <= 0) { showToast('Quantit√© invalide', 'error'); return; }
            if ((prod.quantity || 0) < q) { showToast('Stock insuffisant', 'error'); return; }

            prod.quantity -= q;
            if (!pdv.products) pdv.products = [];
            const pp = pdv.products.find(p => p.reference === ref);
            if (pp) pp.quantity += q;
            else pdv.products.push({ reference: ref, quantity: q });

            movements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                type: 'transfer',
                reason: `Vers ${pdv.name}`,
                product: prod.name,
                reference: ref,
                quantity: q
            });

            save();
            savePDV();
            saveMov();
            showToast(`${q} transf√©r√©s`);
            viewPDV(pdvId);
        }

        function renderHistory() {
            const sorted = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìú Historique</h3>
                        <button class="btn btn-warning" onclick="expHist()">üì•</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem;background:#f9fafb;padding:1rem;border-radius:8px;">
                        <div><label style="display:block;margin-bottom:0.5rem;font-weight:600;">üîç</label>
                            <input type="text" id="hs" placeholder="Rechercher..." style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:8px;">
                        </div>
                        <div><label style="display:block;margin-bottom:0.5rem;font-weight:600;">üìÖ Date</label>
                            <input type="date" id="hd" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:8px;">
                        </div>
                        <div><label style="display:block;margin-bottom:0.5rem;font-weight:600;">üìÜ Mois</label>
                            <input type="month" id="hm" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:8px;">
                        </div>
                        <div><label style="display:block;margin-bottom:0.5rem;font-weight:600;">üìÖ Ann√©e</label>
                            <select id="hy" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:8px;">
                                <option value="">Toutes</option>${getYrs().map(y => `<option value="${y}">${y}</option>`).join('')}
                            </select>
                        </div>
                        <div style="display:flex;align-items:flex-end;">
                            <button class="btn btn-secondary" onclick="rstHist()" style="width:100%;">üîÑ</button>
                        </div>
                    </div>
                    <div style="margin-bottom:1rem;padding:0.75rem;background:#eff6ff;border-radius:8px;">
                        <strong id="hc">${sorted.length}</strong> mouvement(s)
                    </div>
                    <div class="table-container"><table><thead><tr><th>Date</th><th>Type</th><th>Raison</th><th>Produit</th><th>Quantit√©</th><th>Note</th></tr></thead>
                    <tbody id="hb">${renderHist(sorted)}</tbody></table></div>
                </div>
            `;

            ['hs', 'hd', 'hm', 'hy'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener(id === 'hs' ? 'input' : 'change', filtHist);
            });
        }

        function renderHist(list) {
            if (!list || list.length === 0) return '<tr><td colspan="6" style="text-align:center;">Aucun mouvement</td></tr>';
            return list.map(m => {
                const ic = m.type === 'in' ? '‚ûï' : m.type === 'transfer' ? 'üîÑ' : '‚ûñ';
                const cl = m.type === 'in' ? '#10b981' : m.type === 'transfer' ? '#f59e0b' : '#ef4444';
                const tp = m.type === 'in' ? 'Entr√©e' : m.type === 'transfer' ? 'Transfert' : 'Sortie';
                return `<tr><td>${new Date(m.date).toLocaleString('fr-FR')}</td>
                    <td><span style="color:${cl};font-weight:bold;">${ic} ${tp}</span></td>
                    <td>${m.reason || '-'}</td><td><strong>${m.product}</strong></td>
                    <td><strong style="color:${cl};">${m.quantity}</strong></td><td>${m.note || '-'}</td></tr>`;
            }).join('');
        }

        function getYrs() {
            const y = new Set();
            movements.forEach(m => y.add(new Date(m.date).getFullYear()));
            return Array.from(y).sort((a, b) => b - a);
        }

        function rstHist() {
            document.getElementById('hs').value = '';
            document.getElementById('hd').value = '';
            document.getElementById('hm').value = '';
            document.getElementById('hy').value = '';
            filtHist();
        }

        function filtHist() {
            const s = document.getElementById('hs').value.toLowerCase();
            const d = document.getElementById('hd').value;
            const m = document.getElementById('hm').value;
            const y = document.getElementById('hy').value;

            const sorted = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));
            const filt = sorted.filter(mv => {
                const dt = new Date(mv.date);
                const ds = dt.toISOString().split('T')[0];
                const ms = dt.toISOString().substring(0, 7);
                const ys = dt.getFullYear().toString();

                const ms1 = !s || mv.product.toLowerCase().includes(s) || mv.reference.toLowerCase().includes(s);
                const md = !d || ds === d;
                const mm = !m || ms === m;
                const my = !y || ys === y;

                return ms1 && md && mm && my;
            });

            document.getElementById('hb').innerHTML = renderHist(filt);
            document.getElementById('hc').textContent = filt.length;
        }

        function expHist() {
            if (movements.length === 0) { showToast('Aucun historique', 'warning'); return; }

            const data = movements.map(m => ({
                'Date': new Date(m.date).toLocaleString('fr-FR'),
                'Type': m.type === 'in' ? 'Entr√©e' : m.type === 'transfer' ? 'Transfert' : 'Sortie',
                'Raison': m.reason,
                'Produit': m.product,
                'R√©f√©rence': m.reference,
                'Quantit√©': m.quantity,
                'Note': m.note || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Historique');
            XLSX.writeFile(wb, `historique_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Export√©');
        }

        function save() {
            products.forEach(p => {
                const t = pointsVente.reduce((s, pdv) => {
                    const pp = pdv.products?.find(x => x.reference === p.reference);
                    return s + (pp?.quantity || 0);
                }, 0);
                p.quantity = t;
            });
            localStorage.setItem('products', JSON.stringify(products));
        }

        function saveMov() {
            localStorage.setItem('movements', JSON.stringify(movements));
        }

        function savePDV() {
            localStorage.setItem('pointsVente', JSON.stringify(pointsVente));
            save();
        }

        renderDashboard();
    </script>
</body>
</html>
