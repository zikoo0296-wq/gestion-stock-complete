<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock Professionnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .nav-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .nav-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; background: transparent; color: #666; transition: all 0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #2563eb; color: white; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid; }
        .stat-card.blue { border-color: #2563eb; }
        .stat-card.green { border-color: #10b981; }
        .stat-card.red { border-color: #ef4444; }
        .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #333; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .card-title { font-size: 1.3rem; font-weight: bold; }
        .search-input { flex: 1; max-width: 400px; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.7rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-purple:hover { background: #7c3aed; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-orange { background: #f97316; color: white; }
        .btn-orange:hover { background: #ea580c; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { font-weight: 600; font-size: 0.9rem; color: #374151; }
        td { font-size: 0.9rem; }
        tbody tr:hover { background: #f9fafb; }
        .badge { padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-in { background: #d1fae5; color: #065f46; }
        .badge-out { background: #fee2e2; color: #991b1b; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; background: #f3f4f6; border: 1px solid #e5e7eb; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.05); }
        .product-img-error { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 8px; border: 1px solid #e5e7eb; color: #9ca3af; font-size: 1.5rem; }
        .action-btn { padding: 0.5rem; border: none; background: transparent; cursor: pointer; color: #666; transition: color 0.3s; font-size: 1.2rem; }
        .action-btn:hover { color: #2563eb; }
        .action-btn.delete:hover { color: #ef4444; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .form-input, .form-select { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .progress-bar { margin-bottom: 1rem; padding: 1rem; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: #1e40af; }
        .progress { height: 8px; background: #93c5fd; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
        .hidden { display: none; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        input[type="file"] { display: none; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .toast { background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; border-left: 4px solid; min-width: 300px; }
        .toast.success { border-color: #10b981; }
        .toast.error { border-color: #ef4444; }
        .toast.warning { border-color: #f59e0b; }
        .toast.info { border-color: #3b82f6; }
        .toast-icon { font-size: 24px; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 2px; }
        .toast-message { font-size: 0.9rem; color: #666; }
        .toast-close { cursor: pointer; font-size: 20px; color: #999; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Image Viewer */
        .image-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .image-viewer.active { display: flex; }
        .image-viewer-content { position: relative; max-width: 90%; max-height: 90%; }
        .image-viewer-img { max-width: 100%; max-height: 90vh; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .image-viewer-close { position: absolute; top: -40px; right: 0; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; color: #333; }
        
        /* Custom Confirm Dialog */
        .confirm-dialog { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center; }
        .confirm-dialog.active { display: flex; }
        .confirm-content { background: white; border-radius: 16px; padding: 2rem; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .confirm-icon { font-size: 48px; margin-bottom: 1rem; }
        .confirm-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; }
        .confirm-message { color: #666; margin-bottom: 2rem; }
        .confirm-buttons { display: flex; gap: 1rem; justify-content: center; }
        
        @media (max-width: 768px) {
            .navbar-content { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; align-items: stretch; }
            .search-input { max-width: 100%; }
            .toast-container { left: 10px; right: 10px; max-width: none; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">üì¶ Gestion de Stock Pro</div>
            <div class="nav-buttons" id="nav-container"></div>
        </div>
    </nav>

    <div class="container" id="app-container"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Image Viewer -->
    <div class="image-viewer" id="image-viewer">
        <div class="image-viewer-content">
            <button class="image-viewer-close" id="close-image-viewer">‚úñ</button>
            <img class="image-viewer-img" id="viewer-img" src="" alt="">
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirm-icon">‚ö†Ô∏è</div>
            <div class="confirm-title" id="confirm-title">Confirmation</div>
            <div class="confirm-message" id="confirm-message">√ätes-vous s√ªr ?</div>
            <div class="confirm-buttons">
                <button class="btn btn-danger" id="confirm-yes">Oui</button>
                <button class="btn" id="confirm-no" style="background:#e5e7eb;">Annuler</button>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ajouter un Produit</h2>
                <button class="action-btn" id="close-modal-btn">‚úñ</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">URL Image</label>
                            <input type="text" id="form-image" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom R√©el *</label>
                            <input type="text" id="form-realName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom Conventionnel</label>
                            <input type="text" id="form-conventionalName" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Code-barres</label>
                            <input type="text" id="form-barcode" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">R√©p√©tition</label>
                            <input type="text" id="form-repetitionBarcode" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cat√©gorie</label>
                            <input type="text" id="form-category" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marque</label>
                            <input type="text" id="form-brand" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">R√©f√©rence</label>
                            <input type="text" id="form-reference" class="form-input">
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
                        <button type="button" class="btn" id="cancel-modal-btn" style="background: #e5e7eb;">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // === DONN√âES ===
        let APP = {
            products: JSON.parse(localStorage.getItem('products')) || [],
            stores: JSON.parse(localStorage.getItem('stores')) || [],
            movements: JSON.parse(localStorage.getItem('movements')) || [],
            returns: JSON.parse(localStorage.getItem('returns')) || [],
            currentPage: 'dashboard',
            editingProduct: null
        };

        const PAGES = [
            { id: 'dashboard', label: 'üè† Dashboard' },
            { id: 'products', label: 'üì¶ Produits' },
            { id: 'stores', label: 'üè™ Points de Vente' },
            { id: 'movements', label: 'üìä Mouvements' },
            { id: 'returns', label: 'üîÑ Retours' }
        ];

        // === FONCTIONS UTILITAIRES ===
        function save() {
            localStorage.setItem('products', JSON.stringify(APP.products));
            localStorage.setItem('stores', JSON.stringify(APP.stores));
            localStorage.setItem('movements', JSON.stringify(APP.movements));
            localStorage.setItem('returns', JSON.stringify(APP.returns));
            console.log('‚úì Donn√©es sauvegard√©es');
        }

        function formatImageUrl(url) {
            if (!url) return '';
            url = String(url).trim();
            if (url.includes('drive.google.com')) {
                const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                const fileId = match1 ? match1[1] : (match2 ? match2[1] : '');
                if (fileId) return `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
            }
            return url;
        }

        // === TOAST NOTIFICATIONS ===
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close">√ó</div>
            `;
            
            container.appendChild(toast);
            
            toast.querySelector('.toast-close').onclick = () => toast.remove();
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // === IMAGE VIEWER ===
        function openImageViewer(src) {
            document.getElementById('viewer-img').src = src;
            document.getElementById('image-viewer').classList.add('active');
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').classList.remove('active');
        }

        document.getElementById('close-image-viewer').onclick = closeImageViewer;
        document.getElementById('image-viewer').onclick = (e) => {
            if (e.target.id === 'image-viewer') closeImageViewer();
        };

        // === CUSTOM CONFIRM ===
        let confirmCallback = null;

        function showConfirm(title, message, onConfirm, icon = '‚ö†Ô∏è') {
            document.getElementById('confirm-icon').textContent = icon;
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-dialog').classList.add('active');
            confirmCallback = onConfirm;
        }

        document.getElementById('confirm-yes').onclick = () => {
            document.getElementById('confirm-dialog').classList.remove('active');
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
        };

        document.getElementById('confirm-no').onclick = () => {
            document.getElementById('confirm-dialog').classList.remove('active');
            confirmCallback = null;
        };

        // === NAVIGATION ===
        function renderNav() {
            const nav = document.getElementById('nav-container');
            nav.innerHTML = PAGES.map(p => 
                `<button class="nav-btn ${p.id === APP.currentPage ? 'active' : ''}" data-page="${p.id}">${p.label}</button>`
            ).join('');
            
            nav.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => navigateTo(btn.dataset.page);
            });
        }

        function navigateTo(page) {
            APP.currentPage = page;
            renderNav();
            render();
        }

        // === RENDU PRINCIPAL ===
        function render() {
            const container = document.getElementById('app-container');
            
            switch(APP.currentPage) {
                case 'dashboard':
                    container.innerHTML = renderDashboard();
                    break;
                case 'products':
                    container.innerHTML = renderProductsPage();
                    attachProductsEvents();
                    break;
                case 'stores':
                    container.innerHTML = renderStoresPage();
                    attachStoresEvents();
                    break;
                case 'movements':
                    container.innerHTML = renderMovementsPage();
                    attachMovementsEvents();
                    break;
                case 'returns':
                    container.innerHTML = renderReturnsPage();
                    attachReturnsEvents();
                    break;
            }
        }

        // === DASHBOARD ===
        function renderDashboard() {
            const totalProducts = APP.products.length;
            const totalStores = APP.stores.length;
            const lowStock = APP.products.filter(p => {
                const totalQty = APP.stores.reduce((sum, s) => sum + (s.stocks[p.id] || 0), 0);
                return totalQty < 10;
            }).length;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-label">Total Produits</div>
                        <div class="stat-value">${totalProducts}</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Points de Vente</div>
                        <div class="stat-value">${totalStores}</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Alertes Stock Faible</div>
                        <div class="stat-value">${lowStock}</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üìã Mouvements R√©cents</div>
                    <table style="margin-top: 1rem;">
                        <thead>
                            <tr><th>Date</th><th>Produit</th><th>Type</th><th>Raison</th><th>Quantit√©</th></tr>
                        </thead>
                        <tbody>
                            ${APP.movements.slice(-10).reverse().map(m => `
                                <tr>
                                    <td>${new Date(m.date).toLocaleDateString()}</td>
                                    <td>${m.productName}</td>
                                    <td><span class="badge badge-${m.type}">${m.type === 'in' ? 'Entr√©e' : 'Sortie'}</span></td>
                                    <td>${m.reason}</td>
                                    <td><strong>${m.quantity}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // === PRODUITS ===
        function renderProductsPage() {
            const storesHeaders = APP.stores.map(s => `<th>QTY ${s.name}</th>`).join('');
            
            return `
                <div class="card">
                    <div class="card-header">
                        <input type="text" class="search-input" id="search-products" placeholder="üîç Rechercher...">
                        <div class="btn-group">
                            <button class="btn btn-primary" id="btn-add-product">‚ûï Ajouter</button>
                            <label class="btn btn-success">
                                üì§ Importer
                                <input type="file" id="import-products" accept=".xlsx,.xls">
                            </label>
                            <button class="btn btn-purple" id="btn-export-products">üì• Exporter</button>
                            <button class="btn btn-danger" id="btn-delete-selected">üóëÔ∏è Supprimer S√©lection</button>
                        </div>
                    </div>
                    <div id="import-progress" class="progress-bar hidden">
                        <div class="progress-info">
                            <span>Import en cours...</span>
                            <span id="progress-text">0 / 0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all"></th>
                                    <th>Image</th><th>Nom R√©el</th><th>R√©f√©rence</th><th>Marque</th>
                                    ${storesHeaders}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-tbody"></tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderProductsTable(searchTerm = '') {
            const filtered = APP.products.filter(p => {
                const search = searchTerm.toLowerCase();
                return String(p.realName || '').toLowerCase().includes(search) ||
                       String(p.reference || '').toLowerCase().includes(search);
            });
            
            const tbody = document.getElementById('products-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = filtered.map(p => {
                let imgHtml = '<div class="product-img-error">üì∑</div>';
                if (p.image) {
                    imgHtml = `<img src="${p.image}" class="product-img" data-src="${p.image}" onerror="this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='flex';">
                        <div class="product-img-error" style="display:none;">üì∑</div>`;
                }
                
                const storesQty = APP.stores.map(s => {
                    const qty = s.stocks[p.id] || 0;
                    return `<td><span class="badge ${qty < 10 ? 'badge-danger' : 'badge-success'}">${qty}</span></td>`;
                }).join('');
                
                return `
                    <tr data-product-id="${p.id}">
                        <td><input type="checkbox" class="product-check" data-id="${p.id}"></td>
                        <td>${imgHtml}</td>
                        <td>${p.realName || '‚Äî'}</td>
                        <td>${p.reference || '‚Äî'}</td>
                        <td>${p.brand || '‚Äî'}</td>
                        ${storesQty}
                        <td>
                            <button class="action-btn btn-edit-product" data-id="${p.id}">‚úèÔ∏è</button>
                            <button class="action-btn delete btn-delete-product" data-id="${p.id}">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Attacher √©v√©nements images
            setTimeout(() => {
                document.querySelectorAll('.product-img[data-src]').forEach(img => {
                    img.onclick = () => openImageViewer(img.dataset.src);
                });
            }, 100);
        }}
                
                const storesQty = APP.stores.map(s => {
                    const qty = s.stocks[p.id] || 0;
                    return `<td><span class="badge ${qty < 10 ? 'badge-danger' : 'badge-success'}">${qty}</span></td>`;
                }).join('');
                
                return `
                    <tr>
                        <td><input type="checkbox" class="product-check" data-id="${p.id}"></td>
                        <td>${imgHtml}</td>
                        <td>${p.realName || '‚Äî'}</td>
                        <td>${p.reference || '‚Äî'}</td>
                        <td>${p.brand || '‚Äî'}</td>
                        ${storesQty}
                        <td>
                            <button class="action-btn btn-edit-product" data-id="${p.id}">‚úèÔ∏è</button>
                            <button class="action-btn delete btn-delete-product" data-id="${p.id}">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function attachProductsEvents() {
            console.log('=== ATTACH PRODUCTS EVENTS ===');
            
            // Recherche
            const searchInput = document.getElementById('search-products');
            if (searchInput) {
                searchInput.oninput = (e) => renderProductsTable(e.target.value);
            }
            
            renderProductsTable();
            
            // Select all
            const selectAll = document.getElementById('select-all');
            if (selectAll) {
                selectAll.onchange = function() {
                    console.log('Select all:', this.checked);
                    document.querySelectorAll('.product-check').forEach(cb => {
                        cb.checked = this.checked;
                    });
                };
            }
            
            // Bouton ajouter
            const btnAdd = document.getElementById('btn-add-product');
            if (btnAdd) {
                btnAdd.onclick = () => {
                    console.log('Bouton Ajouter cliqu√©');
                    openProductModal();
                };
            }
            
            // Boutons √©diter
            setTimeout(() => {
                document.querySelectorAll('.btn-edit-product').forEach(btn => {
                    btn.onclick = function() {
                        console.log('Edit product:', this.dataset.id);
                        const id = parseInt(this.dataset.id);
                        const product = APP.products.find(p => p.id === id);
                        if (product) openProductModal(product);
                    };
                });
                
                // Boutons supprimer
                document.querySelectorAll('.btn-delete-product').forEach(btn => {
                    btn.onclick = function() {
                        console.log('Delete product:', this.dataset.id);
                        const id = parseInt(this.dataset.id);
                        deleteProduct(id);
                    };
                });
            }, 100);
            
            // Supprimer s√©lection
            const btnDeleteSelected = document.getElementById('btn-delete-selected');
            if (btnDeleteSelected) {
                btnDeleteSelected.onclick = function() {
                    console.log('=== DELETE SELECTED ===');
                    
                    const checked = document.querySelectorAll('.product-check:checked');
                    const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id));
                    
                    console.log('Produits coch√©s:', ids.length);
                    console.log('IDs:', ids);
                    
                    if (ids.length === 0) {
                        showToast('Attention', 'Veuillez s√©lectionner au moins un produit', 'warning');
                        return;
                    }
                    
                    showConfirm(
                        'Supprimer les produits',
                        `Voulez-vous vraiment supprimer ${ids.length} produit(s) ?`,
                        () => {
                            console.log('Confirmation OK, suppression...');
                            const before = APP.products.length;
                            APP.products = APP.products.filter(p => !ids.includes(p.id));
                            console.log('Produits avant:', before, 'apr√®s:', APP.products.length);
                            save();
                            render();
                            showToast('Succ√®s', `${ids.length} produit(s) supprim√©(s)`, 'success');
                        },
                        'üóëÔ∏è'
                    );
                };
            }
            
            // Import
            const importFile = document.getElementById('import-products');
            if (importFile) {
                importFile.onchange = handleImportProducts;
            }
            
            // Export
            const btnExport = document.getElementById('btn-export-products');
            if (btnExport) {
                btnExport.onclick = exportProducts;
            }
        }

        function deleteProduct(id) {
            console.log('=== DELETE SINGLE PRODUCT ===');
            console.log('ID:', id);
            
            const product = APP.products.find(p => p.id === id);
            if (!product) {
                console.error('Produit non trouv√©');
                return;
            }
            
            showConfirm(
                'Supprimer le produit',
                `Voulez-vous vraiment supprimer "${product.realName}" ?`,
                () => {
                    console.log('Confirmation OK, suppression...');
                    const before = APP.products.length;
                    APP.products = APP.products.filter(p => p.id !== id);
                    console.log('Produits avant:', before, 'apr√®s:', APP.products.length);
                    save();
                    render();
                    showToast('Succ√®s', 'Produit supprim√©', 'success');
                },
                'üóëÔ∏è'
            );
        }

        function openProductModal(product = null) {
            APP.editingProduct = product;
            document.getElementById('modal-title').textContent = product ? 'Modifier le Produit' : 'Ajouter un Produit';
            
            if (product) {
                document.getElementById('form-image').value = product.image || '';
                document.getElementById('form-realName').value = product.realName || '';
                document.getElementById('form-conventionalName').value = product.conventionalName || '';
                document.getElementById('form-barcode').value = product.barcode || '';
                document.getElementById('form-repetitionBarcode').value = product.repetitionBarcode || '';
                document.getElementById('form-category').value = product.category || '';
                document.getElementById('form-brand').value = product.brand || '';
                document.getElementById('form-reference').value = product.reference || '';
            } else {
                document.getElementById('product-form').reset();
            }
            
            document.getElementById('product-modal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
            APP.editingProduct = null;
        }

        document.getElementById('close-modal-btn').onclick = closeProductModal;
        document.getElementById('cancel-modal-btn').onclick = closeProductModal;

        document.getElementById('product-form').onsubmit = (e) => {
            e.preventDefault();
            
            const data = {
                image: formatImageUrl(document.getElementById('form-image').value),
                realName: document.getElementById('form-realName').value,
                conventionalName: document.getElementById('form-conventionalName').value,
                barcode: document.getElementById('form-barcode').value,
                repetitionBarcode: document.getElementById('form-repetitionBarcode').value,
                category: document.getElementById('form-category').value,
                brand: document.getElementById('form-brand').value,
                reference: document.getElementById('form-reference').value
            };
            
            if (APP.editingProduct) {
                const idx = APP.products.findIndex(p => p.id === APP.editingProduct.id);
                APP.products[idx] = { ...APP.products[idx], ...data };
            } else {
                APP.products.push({ id: Date.now(), ...data });
            }
            
            save();
            closeProductModal();
            render();
            alert('‚úÖ Produit enregistr√©');
        };

        async function handleImportProducts(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const progressBar = document.getElementById('import-progress');
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                progressBar.classList.remove('hidden');
                progressFill.style.width = '0%';
                
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data);
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws);
                
                const headers = Object.keys(rows[0]);
                const qtyColumns = headers.filter(h => h.toUpperCase().startsWith('QTY '));
                const storeNames = qtyColumns.map(c => c.replace(/^QTY /i, '').trim());
                
                // Cr√©er PDV si n√©cessaire
                const storesMap = {};
                storeNames.forEach((name, idx) => {
                    let store = APP.stores.find(s => s.name.toUpperCase() === name.toUpperCase());
                    if (!store) {
                        store = { id: Date.now() + idx, name, responsable: '', stocks: {} };
                        APP.stores.push(store);
                    }
                    storesMap[name] = store;
                });
                
                let newCount = 0;
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const realName = row['Real Name'];
                    if (!realName) continue;
                    
                    const reference = row['R√©f√©rence'] || '';
                    let product = APP.products.find(p => 
                        p.realName === realName || (reference && p.reference === reference)
                    );
                    
                    if (!product) {
                        product = {
                            id: Date.now() + Math.random(),
                            image: formatImageUrl(row['IMAGE'] || ''),
                            realName,
                            conventionalName: row['Conventional Name'] || '',
                            reference,
                            barcode: row['Barcode'] || '',
                            repetitionBarcode: row['Repetition'] || '',
                            category: row['Category'] || '',
                            brand: row['Brand'] || ''
                        };
                        APP.products.push(product);
                        newCount++;
                    }
                    
                    storeNames.forEach((name, idx) => {
                        const qty = parseInt(row[qtyColumns[idx]]) || 0;
                        storesMap[name].stocks[product.id] = qty;
                    });
                    
                    const percent = Math.round(((i + 1) / rows.length) * 100);
                    progressFill.style.width = percent + '%';
                    progressText.textContent = `${i + 1} / ${rows.length}`;
                    
                    if (i % 100 === 0) await new Promise(r => setTimeout(r, 10));
                }
                
                save();
                setTimeout(() => {
                    progressBar.classList.add('hidden');
                    render();
                    alert(`‚úÖ Import r√©ussi!\n\nüè™ ${storeNames.length} PDV\nüì¶ ${newCount} nouveaux produits`);
                }, 500);
                
            } catch (err) {
                console.error(err);
                document.getElementById('import-progress').classList.add('hidden');
                alert('‚ùå Erreur: ' + err.message);
            }
            
            e.target.value = '';
        }

        function exportProducts() {
            const data = APP.products.map(p => {
                const row = {
                    'IMAGE': p.image || '',
                    'Real Name': p.realName,
                    'Conventional Name': p.conventionalName || '',
                    'R√©f√©rence': p.reference || '',
                    'Barcode': p.barcode || '',
                    'Repetition': p.repetitionBarcode || '',
                    'Category': p.category || '',
                    'Brand': p.brand || ''
                };
                APP.stores.forEach(s => {
                    row[`QTY ${s.name}`] = s.stocks[p.id] || 0;
                });
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `stock_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // === POINTS DE VENTE ===
        function renderStoresPage() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üè™ Points de Vente</h2>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="btn-add-store">‚ûï Ajouter PDV</button>
                            <label class="btn btn-success">
                                üì§ Importer Excel
                                <input type="file" id="import-stores" accept=".xlsx,.xls">
                            </label>
                        </div>
                    </div>
                    <div id="stores-list">
                        ${APP.stores.length === 0 ? '<p>Aucun point de vente. Ajoutez-en un ou importez un fichier Excel.</p>' : ''}
                        ${APP.stores.map(s => {
                            const totalStock = APP.products.reduce((sum, p) => sum + (s.stocks[p.id] || 0), 0);
                            return `
                                <div class="card" style="margin-bottom: 1rem; border-left: 4px solid #2563eb;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h3>üè™ ${s.name}</h3>
                                            <p><strong>Responsable:</strong> ${s.responsable || 'Non d√©fini'}</p>
                                            <p><strong>Stock total:</strong> ${totalStock} unit√©s</p>
                                        </div>
                                        <button class="btn btn-danger btn-delete-store" data-id="${s.id}">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function attachStoresEvents() {
            const btnAdd = document.getElementById('btn-add-store');
            if (btnAdd) {
                btnAdd.onclick = () => {
                    console.log('=== ADD STORE ===');
                    
                    const name = prompt('Nom du point de vente:');
                    if (!name || !name.trim()) {
                        console.log('Annul√©: nom vide');
                        return;
                    }
                    
                    const responsable = prompt('Nom du responsable:');
                    if (!responsable || !responsable.trim()) {
                        console.log('Annul√©: responsable vide');
                        return;
                    }
                    
                    const newStore = {
                        id: Date.now(),
                        name: name.trim(),
                        responsable: responsable.trim(),
                        stocks: {}
                    };
                    
                    console.log('Nouveau PDV:', newStore);
                    APP.stores.push(newStore);
                    
                    save();
                    render();
                    showToast('Succ√®s', `PDV "${name}" ajout√© !`, 'success');
                };
            }
            
            setTimeout(() => {
                document.querySelectorAll('.btn-delete-store').forEach(btn => {
                    btn.onclick = function() {
                        const id = parseInt(this.dataset.id);
                        const store = APP.stores.find(s => s.id === id);
                        if (!store) return;
                        
                        showConfirm(
                            'Supprimer le PDV',
                            `Voulez-vous vraiment supprimer "${store.name}" ?`,
                            () => {
                                APP.stores = APP.stores.filter(s => s.id !== id);
                                save();
                                render();
                                showToast('Succ√®s', 'PDV supprim√©', 'success');
                            },
                            'üóëÔ∏è'
                        );
                    };
                });
            }, 100);
            
            const importFile = document.getElementById('import-stores');
            if (importFile) {
                importFile.onchange = handleImportProducts;
            }
        }

        // === MOUVEMENTS ===
        function renderMovementsPage() {
            return `
                <div class="card">
                    <h2 class="card-title">üìä Enregistrer un Mouvement</h2>
                    <div class="form-grid" style="margin: 1.5rem 0;">
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select id="movement-type" class="form-select">
                                <option value="in">Entr√©e</option>
                                <option value="out">Sortie</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Raison</label>
                            <select id="movement-reason" class="form-select">
                                <option value="">S√©lectionner...</option>
                                <option value="Vente">Vente</option>
                                <option value="Mise en Stock">Mise en Stock</option>
                                <option value="Retour">Retour</option>
                            </select>
                        </div>
                        <div class="form-group" id="client-group" style="display:none;">
                            <label class="form-label">Nom Client</label>
                            <input type="text" id="client-name" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary" id="btn-validate-movement" style="width:100%;height:42px;">‚úÖ Valider</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-movements"></th>
                                <th>Produit</th>
                                <th>Stock Dispo</th>
                                <th>Quantit√©</th>
                            </tr>
                        </thead>
                        <tbody id="movements-tbody"></tbody>
                    </table>
                </div>
            `;
        }

        function attachMovementsEvents() {
            console.log('=== ATTACH MOVEMENTS EVENTS ===');
            
            const tbody = document.getElementById('movements-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = APP.products.map(p => {
                const totalStock = APP.stores.reduce((sum, s) => sum + (s.stocks[p.id] || 0), 0);
                return `
                    <tr>
                        <td><input type="checkbox" class="movement-check" data-id="${p.id}"></td>
                        <td>${p.realName}</td>
                        <td>${totalStock}</td>
                        <td><input type="number" class="form-input" id="qty-${p.id}" min="1" style="width:100px;"></td>
                    </tr>
                `;
            }).join('');
            
            const selectAll = document.getElementById('select-all-movements');
            if (selectAll) {
                selectAll.onchange = function() {
                    document.querySelectorAll('.movement-check').forEach(cb => {
                        cb.checked = this.checked;
                    });
                };
            }
            
            const reasonSelect = document.getElementById('movement-reason');
            if (reasonSelect) {
                reasonSelect.onchange = function() {
                    const clientGroup = document.getElementById('client-group');
                    if (clientGroup) {
                        clientGroup.style.display = this.value === 'Vente' ? 'block' : 'none';
                    }
                };
            }
            
            const btnValidate = document.getElementById('btn-validate-movement');
            if (btnValidate) {
                btnValidate.onclick = function() {
                    console.log('=== VALIDATE MOVEMENT ===');
                    
                    const type = document.getElementById('movement-type').value;
                    const reason = document.getElementById('movement-reason').value;
                    const clientName = document.getElementById('client-name').value;
                    
                    console.log('Type:', type, 'Raison:', reason, 'Client:', clientName);
                    
                    if (!reason) {
                        showToast('Attention', 'Veuillez s√©lectionner une raison', 'warning');
                        return;
                    }
                    
                    if (reason === 'Vente' && !clientName.trim()) {
                        showToast('Attention', 'Veuillez entrer le nom du client', 'warning');
                        return;
                    }
                    
                    const checked = document.querySelectorAll('.movement-check:checked');
                    console.log('Produits coch√©s:', checked.length);
                    
                    if (checked.length === 0) {
                        showToast('Attention', 'Veuillez s√©lectionner au moins un produit', 'warning');
                        return;
                    }
                    
                    const toProcess = [];
                    let hasError = false;
                    
                    for (let cb of checked) {
                        const id = parseInt(cb.dataset.id);
                        const product = APP.products.find(p => p.id === id);
                        const qtyInput = document.getElementById(`qty-${id}`);
                        const qty = parseInt(qtyInput.value) || 0;
                        
                        console.log(`Produit: ${product.realName}, Qty: ${qty}`);
                        
                        if (qty <= 0) {
                            showToast('Erreur', `Quantit√© invalide pour ${product.realName}`, 'error');
                            hasError = true;
                            break;
                        }
                        
                        const totalStock = APP.stores.reduce((sum, s) => sum + (s.stocks[product.id] || 0), 0);
                        
                        if (type === 'out' && totalStock < qty) {
                            showToast('Erreur', `Stock insuffisant pour ${product.realName}`, 'error');
                            hasError = true;
                            break;
                        }
                        
                        toProcess.push({ product, qty });
                    }
                    
                    if (hasError) {
                        console.log('Erreur d√©tect√©e, arr√™t');
                        return;
                    }
                    
                    console.log('Traitement de', toProcess.length, 'produits');
                    
                    toProcess.forEach(({ product, qty }) => {
                        APP.movements.push({
                            id: Date.now() + Math.random(),
                            productId: product.id,
                            productName: product.realName,
                            type,
                            reason,
                            quantity: qty,
                            clientName: reason === 'Vente' ? clientName : '',
                            date: new Date().toISOString()
                        });
                    });
                    
                    save();
                    render();
                    showToast('Succ√®s', `${toProcess.length} mouvement(s) enregistr√©(s)`, 'success');
                };
            }
        }

        // === RETOURS ===
        function renderReturnsPage() {
            const sales = APP.movements.filter(m => m.reason === 'Vente');
            
            return `
                <div class="card">
                    <h2 class="card-title">üõí Ventes</h2>
                    <table style="margin-top:1rem;">
                        <thead>
                            <tr><th>Date</th><th>Produit</th><th>Client</th><th>Quantit√©</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${sales.map(s => `
                                <tr>
                                    <td>${new Date(s.date).toLocaleDateString()}</td>
                                    <td>${s.productName}</td>
                                    <td>${s.clientName}</td>
                                    <td>${s.quantity}</td>
                                    <td><button class="btn btn-orange btn-return" data-id="${s.id}">üîÑ Retour</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h2 class="card-title">üîÑ Historique Retours</h2>
                    <table style="margin-top:1rem;">
                        <thead>
                            <tr><th>Date</th><th>Produit</th><th>Client</th><th>Quantit√©</th><th>Raison</th></tr>
                        </thead>
                        <tbody>
                            ${APP.returns.map(r => `
                                <tr>
                                    <td>${new Date(r.date).toLocaleDateString()}</td>
                                    <td>${r.productName}</td>
                                    <td>${r.clientName}</td>
                                    <td>${r.quantity}</td>
                                    <td>${r.reason}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function attachReturnsEvents() {
            setTimeout(() => {
                document.querySelectorAll('.btn-return').forEach(btn => {
                    btn.onclick = function() {
                        const id = parseFloat(this.dataset.id);
                        const sale = APP.movements.find(m => m.id === id);
                        if (!sale) return;
                        
                        const qty = parseInt(prompt(`Quantit√© √† retourner (max: ${sale.quantity}):`));
                        if (!qty || qty <= 0 || qty > sale.quantity) {
                            showToast('Erreur', 'Quantit√© invalide', 'error');
                            return;
                        }
                        
                        const reason = prompt('Raison du retour:');
                        if (!reason || !reason.trim()) {
                            showToast('Erreur', 'Veuillez entrer une raison', 'error');
                            return;
                        }
                        
                        APP.returns.push({
                            id: Date.now(),
                            saleId: sale.id,
                            productId: sale.productId,
                            productName: sale.productName,
                            clientName: sale.clientName,
                            quantity: qty,
                            reason: reason.trim(),
                            date: new Date().toISOString()
                        });
                        
                        save();
                        render();
                        showToast('Succ√®s', `Retour enregistr√©: ${qty} ${sale.productName}`, 'success');
                    };
                });
            }, 100);
        }

        // === INIT ===
        renderNav();
        render();
        console.log('‚úÖ Application pr√™te');
        showToast('Bienvenue', 'Application de gestion de stock charg√©e !', 'info');
    </script>
</body>
</html>
