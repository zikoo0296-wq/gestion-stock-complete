<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock Professionnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        
        /* Navbar */
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .nav-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .nav-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; background: transparent; color: #666; transition: all 0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #2563eb; color: white; }
        
        /* Container */
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid; }
        .stat-card.blue { border-color: #2563eb; }
        .stat-card.green { border-color: #10b981; }
        .stat-card.red { border-color: #ef4444; }
        .stat-card.orange { border-color: #f59e0b; }
        .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #333; }
        
        /* Cards */
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .card-title { font-size: 1.3rem; font-weight: bold; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.7rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        /* Search */
        .search-input { flex: 1; max-width: 400px; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; }
        tr:hover { background: #f9fafb; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.1); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        /* Form */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        /* Progress */
        .progress-container { margin: 1rem 0; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
        .progress-text { margin-top: 0.5rem; text-align: center; color: #666; font-size: 0.9rem; }
        
        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem; min-width: 300px; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Image Modal */
        .image-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .image-modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        
        /* Utilities */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        input[type="file"] { display: none; }
        
        /* Points de Vente */
        .pdv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .pdv-card { background: #f9fafb; padding: 1rem; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s; }
        .pdv-card.active { border-color: #2563eb; background: #eff6ff; }
        .pdv-card:hover { border-color: #93c5fd; }
        .pdv-name { font-weight: 600; margin-bottom: 0.5rem; }
        .pdv-stock { color: #666; font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            .navbar-content { flex-direction: column; }
            .card-header { flex-direction: column; align-items: stretch; }
            .search-input { max-width: 100%; }
            .btn-group { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">üì¶ Stock Pro</div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="showPage('products')">üì¶ Produits</button>
                <button class="nav-btn" onclick="showPage('movements')">üîÑ Mouvements</button>
                <button class="nav-btn" onclick="showPage('pointsVente')">üè™ Points de Vente</button>
                <button class="nav-btn" onclick="showPage('history')">üìú Historique</button>
            </div>
        </div>
    </div>

    <!-- Container -->
    <div class="container" id="app-container"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-close" onclick="closeImageModal()">‚úï</div>
        <img id="modal-image" src="" alt="">
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Ajouter un produit</h2>
                <button class="close-btn" onclick="closeProductModal()">√ó</button>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label>Image URL (Google Drive)</label>
                    <input type="text" id="product-image" placeholder="https://drive.google.com/uc?export=view&id=...">
                </div>
                <div class="form-group">
                    <label>Nom du produit *</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Nom commercial</label>
                    <input type="text" id="product-conventional">
                </div>
                <div class="form-group">
                    <label>R√©f√©rence *</label>
                    <input type="text" id="product-ref" required>
                </div>
                <div class="form-group">
                    <label>Code-barres</label>
                    <input type="text" id="product-barcode">
                </div>
                <div class="form-group">
                    <label>Cat√©gorie</label>
                    <input type="text" id="product-category">
                </div>
                <div class="form-group">
                    <label>Marque</label>
                    <input type="text" id="product-brand">
                </div>
                <div class="form-group">
                    <label>Prix de vente *</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                <div class="form-group">
                    <label>Quantit√© initiale</label>
                    <input type="number" id="product-quantity" value="0">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Importer depuis Excel</h2>
                <button class="close-btn" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="mb-2">
                <p style="color: #666; margin-bottom: 1rem;">
                    <strong>Format Excel attendu :</strong><br>
                    IMAGE | Real Name | Conventional Name | R√©f√©rence | Barcode | Repetition | Category | Brand | QTY [Nom PDV] | QTY [Nom PDV] | ...<br>
                    <small style="color: #999;">
                        Les colonnes <strong>QTY XXX</strong> repr√©sentent le stock de chaque point de vente (ex: QTY Al Baraka, QTY Roche Noire, QTY ALGHAFLA)<br>
                        Le syst√®me d√©tectera automatiquement tous les points de vente et distribuera le stock selon chaque colonne QTY.
                    </small>
                    <br><br>
                    <strong style="color: #ef4444;">‚ö†Ô∏è Important pour les images :</strong><br>
                    <small style="color: #666;">
                        ‚Ä¢ Les images Google Drive doivent √™tre <strong>partag√©es publiquement</strong><br>
                        ‚Ä¢ Format accept√© : <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">https://drive.google.com/uc?export=view&id=XXX</code><br>
                        ‚Ä¢ Testez vos images en ouvrant l'URL dans un navigateur incognito<br>
                        ‚Ä¢ Si "Acc√®s refus√©", partagez le fichier en mode "Tous les utilisateurs disposant du lien"
                    </small>
                </p>
                <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleImport(event)">
                <button class="btn btn-primary" onclick="document.getElementById('excel-file').click()">üìÅ Choisir un fichier</button>
            </div>
            <div id="import-progress" class="progress-container hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Import en cours...</div>
            </div>
        </div>
    </div>

    <script>
        // ============ DATA STORAGE ============
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let movements = JSON.parse(localStorage.getItem('movements')) || [];
        let pointsVente = JSON.parse(localStorage.getItem('pointsVente')) || [];
        let currentPage = 'dashboard';
        let editingProduct = null;

        // ============ TOAST NOTIFICATIONS ============
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†'}</div>
                <div>${message}</div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ IMAGE MODAL ============
        function openImageModal(src) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            
            // Extraire l'ID du fichier pour essayer plusieurs formats
            const idMatch = src.match(/[?&]id=([^&]+)/);
            const fileId = idMatch ? idMatch[1] : null;
            
            if (fileId) {
                // Essayer le format haute r√©solution
                modalImg.src = `https://drive.google.com/uc?export=view&id=${fileId}`;
                modalImg.onerror = function() {
                    // Si √©chec, essayer le format thumbnail plus large
                    if (this.src.includes('uc?export=view')) {
                        this.src = `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
                    } else if (this.src.includes('thumbnail')) {
                        this.src = `https://lh3.googleusercontent.com/d/${fileId}=w800`;
                    } else {
                        console.error('Impossible de charger l\'image en haute r√©solution');
                        this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22400%22%3E%3Crect fill=%22%23333%22 width=%22400%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2224%22%3EImage non disponible%3C/text%3E%3C/svg%3E';
                    }
                };
            } else {
                modalImg.src = src;
            }
            
            modal.classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        // ============ NAVIGATION ============
        function showPage(page) {
            console.log('=== CHANGEMENT DE PAGE ===');
            console.log('Ancienne page:', currentPage);
            console.log('Nouvelle page:', page);
            
            currentPage = page;
            
            // Mettre √† jour les boutons de navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Trouver et activer le bon bouton
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if ((page === 'dashboard' && btnText.includes('dashboard')) ||
                    (page === 'products' && btnText.includes('produits')) ||
                    (page === 'movements' && btnText.includes('mouvements')) ||
                    (page === 'pointsVente' && btnText.includes('points')) ||
                    (page === 'history' && btnText.includes('historique'))) {
                    btn.classList.add('active');
                }
            });
            
            // Appeler la fonction de rendu appropri√©e
            try {
                const pages = {
                    'dashboard': renderDashboard,
                    'products': renderProducts,
                    'movements': renderMovements,
                    'pointsVente': renderPointsVente,
                    'history': renderHistory
                };
                
                if (pages[page]) {
                    console.log('Rendu de la page:', page);
                    pages[page]();
                } else {
                    console.error('Page inconnue:', page);
                }
            } catch (error) {
                console.error('Erreur lors du rendu de la page:', error);
                showToast('Erreur lors du chargement de la page', 'error');
            }
        }

        // ============ DASHBOARD ============
        function renderDashboard() {
            console.log('=== RENDU DASHBOARD ===');
            
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + (p.quantity || 0), 0);
            const lowStock = products.filter(p => (p.quantity || 0) < 10).length;
            const totalValue = products.reduce((sum, p) => sum + ((p.quantity || 0) * (p.price || 0)), 0);

            const container = document.getElementById('app-container');
            if (!container) {
                console.error('Container app-container introuvable');
                return;
            }

            container.innerHTML = `
                <div class="card" style="margin-bottom: 1.5rem;">
                    <input type="text" id="dashboard-search" class="search-input" placeholder="üîç Rechercher un produit ou r√©f√©rence..." style="width: 100%;">
                </div>

                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-label">Total Produits</div>
                        <div class="stat-value">${totalProducts}</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Stock Total</div>
                        <div class="stat-value">${totalStock}</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Alertes Stock Faible</div>
                        <div class="stat-value">${lowStock}</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Valeur Totale</div>
                        <div class="stat-value">${totalValue.toFixed(2)} DH</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üö® Produits en alerte</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Produit</th>
                                    <th>R√©f√©rence</th>
                                    <th>Stock</th>
                                    <th>Prix</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-alerts-body">
                                ${renderDashboardAlerts(products.filter(p => (p.quantity || 0) < 10))}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Attacher l'√©v√©nement de recherche
            const searchInput = document.getElementById('dashboard-search');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    filterDashboardProducts(this.value);
                });
                console.log('‚úì √âv√©nement de recherche attach√© au dashboard');
            }
        }

        function renderDashboardAlerts(filteredProducts) {
            if (filteredProducts.length === 0) {
                return '<tr><td colspan="5" class="text-center">Aucun produit en alerte</td></tr>';
            }

            return filteredProducts.map(p => {
                const imageSrc = p.image || '';
                const idMatch = imageSrc.match(/[?&]id=([^&]+)/);
                const fileId = idMatch ? idMatch[1] : null;
                let imageHtml = 'üì¶';
                
                if (fileId) {
                    imageHtml = `<img src="https://drive.google.com/thumbnail?id=${fileId}&sz=w200" class="product-img" onclick="openImageModal('https://drive.google.com/uc?export=view&id=${fileId}')" onerror="if (this.src.includes('thumbnail')) { this.src='https://drive.google.com/uc?export=view&id=${fileId}'; } else { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'; }" alt="${p.name}">`;
                }
                
                return `
                    <tr>
                        <td>${imageHtml}</td>
                        <td><strong>${p.name}</strong><br><small>${p.conventionalName || ''}</small></td>
                        <td>${p.reference}</td>
                        <td><span style="color: #ef4444; font-weight: bold;">${p.quantity || 0}</span></td>
                        <td>${p.price} DH</td>
                    </tr>
                `;
            }).join('');
        }

        function filterDashboardProducts(search) {
            const searchLower = search.toLowerCase().trim();
            console.log('Recherche dashboard:', searchLower);
            
            const filtered = products.filter(p => 
                (p.quantity || 0) < 10 && (
                    p.name.toLowerCase().includes(searchLower) ||
                    p.reference.toLowerCase().includes(searchLower) ||
                    (p.conventionalName || '').toLowerCase().includes(searchLower) ||
                    (p.barcode || '').toLowerCase().includes(searchLower)
                )
            );
            
            console.log('R√©sultats trouv√©s:', filtered.length);
            
            const tbody = document.getElementById('dashboard-alerts-body');
            if (tbody) {
                tbody.innerHTML = renderDashboardAlerts(filtered);
            }
        }

        // ============ PRODUCTS PAGE ============
        function renderProducts() {
            console.log('=== RENDU PRODUITS ===');
            
            const container = document.getElementById('app-container');
            if (!container) {
                console.error('Container app-container introuvable');
                return;
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üì¶ Gestion des produits</h3>
                        <div class="btn-group">
                            <input type="text" id="products-search" class="search-input" placeholder="üîç Rechercher un produit...">
                            <button class="btn btn-primary" onclick="openProductModal()">‚ûï Ajouter</button>
                            <button class="btn btn-success" onclick="openImportModal()">üì§ Importer Excel</button>
                            <button class="btn btn-warning" onclick="exportProducts()">üì• Exporter Excel</button>
                            <button class="btn btn-danger" onclick="deleteSelectedProducts()" id="delete-selected-btn" style="display: none;">üóëÔ∏è Supprimer s√©lection</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-products" onchange="toggleAllProductsSelection(this.checked)"></th>
                                    <th>Image</th>
                                    <th>Nom</th>
                                    <th>R√©f√©rence</th>
                                    <th>Code-barres</th>
                                    <th>Cat√©gorie</th>
                                    <th>Marque</th>
                                    <th>Stock</th>
                                    <th>Prix</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderProductRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Attacher les listeners
            attachProductCheckboxListeners();
            
            const searchInput = document.getElementById('products-search');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    filterProducts(this.value);
                });
                console.log('‚úì √âv√©nement de recherche attach√© aux produits');
            }
        }

        function attachProductCheckboxListeners() {
            document.querySelectorAll('.product-select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteButton);
            });
        }

        function toggleAllProductsSelection(checked) {
            document.querySelectorAll('.product-select-checkbox').forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkedCount = document.querySelectorAll('.product-select-checkbox:checked').length;
            const deleteBtn = document.getElementById('delete-selected-btn');
            if (checkedCount > 0) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.textContent = `üóëÔ∏è Supprimer (${checkedCount})`;
            } else {
                deleteBtn.style.display = 'none';
            }
        }

        function deleteSelectedProducts() {
            const checkedBoxes = document.querySelectorAll('.product-select-checkbox:checked');
            const count = checkedBoxes.length;
            
            console.log('Suppression de produits s√©lectionn√©s:', count);
            
            if (count === 0) {
                showToast('Aucun produit s√©lectionn√©', 'warning');
                return;
            }

            if (!confirm(`Voulez-vous vraiment supprimer ${count} produit(s) ?`)) {
                return;
            }

            const refsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.ref);
            console.log('R√©f√©rences √† supprimer:', refsToDelete);
            
            const initialLength = products.length;
            products = products.filter(p => !refsToDelete.includes(p.reference));
            console.log(`Produits avant: ${initialLength}, apr√®s: ${products.length}`);
            
            // Supprimer aussi des PDV
            pointsVente.forEach(pdv => {
                if (pdv.products) {
                    pdv.products = pdv.products.filter(p => !refsToDelete.includes(p.reference));
                }
            });

            saveProducts();
            savePDV();
            showToast(`${count} produit(s) supprim√©(s) avec succ√®s`, 'success');
            renderProducts();
        }

        function renderProductRows(filteredProducts = products) {
            if (filteredProducts.length === 0) {
                return '<tr><td colspan="10" class="text-center">Aucun produit trouv√©</td></tr>';
            }
            
            return filteredProducts.map(p => {
                const imageSrc = p.image || '';
                
                // Cr√©er plusieurs formats d'URL Google Drive en fallback
                let imageHtml = 'üì¶';
                if (imageSrc) {
                    // Extraire l'ID du fichier
                    const idMatch = imageSrc.match(/[?&]id=([^&]+)/);
                    const fileId = idMatch ? idMatch[1] : null;
                    
                    if (fileId) {
                        // Essayer plusieurs formats d'URL
                        imageHtml = `
                            <img 
                                src="https://drive.google.com/thumbnail?id=${fileId}&sz=w200" 
                                class="product-img" 
                                onclick="openImageModal('https://drive.google.com/uc?export=view&id=${fileId}')"
                                onerror="
                                    if (this.src.includes('thumbnail')) {
                                        this.src='https://drive.google.com/uc?export=view&id=${fileId}';
                                    } else if (this.src.includes('uc?export=view')) {
                                        this.src='https://lh3.googleusercontent.com/d/${fileId}';
                                    } else {
                                        console.error('Image non charg√©e:', '${fileId}'); 
                                        this.onerror=null; 
                                        this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E';
                                    }
                                " 
                                alt="${p.name}"
                                title="ID: ${fileId}"
                            >`;
                    } else {
                        imageHtml = `<img src="${imageSrc}" class="product-img" onclick="openImageModal('${imageSrc}')" onerror="console.error('URL invalide:', '${imageSrc}'); this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E';" alt="${p.name}">`;
                    }
                }
                
                return `
                <tr>
                    <td><input type="checkbox" class="product-select-checkbox" data-ref="${p.reference}"></td>
                    <td>${imageHtml}</td>
                    <td>
                        <strong>${p.name}</strong>
                        ${p.conventionalName ? `<br><small style="color: #666;">${p.conventionalName}</small>` : ''}
                    </td>
                    <td>${p.reference}</td>
                    <td>${p.barcode || '-'}</td>
                    <td>${p.category || '-'}</td>
                    <td>${p.brand || '-'}</td>
                    <td><strong>${p.quantity || 0}</strong></td>
                    <td>${p.price || 0} DH</td>
                    <td>
                        <button class="btn btn-primary" onclick='editProductByRef("${p.reference}")' style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${p.reference}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function editProductByRef(reference) {
            const product = products.find(p => p.reference === reference);
            if (product) {
                editProduct(product);
            }
        }

        function filterProducts(search) {
            const searchLower = search.toLowerCase().trim();
            console.log('Recherche produits:', searchLower);
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchLower) ||
                p.reference.toLowerCase().includes(searchLower) ||
                (p.barcode || '').toLowerCase().includes(searchLower) ||
                (p.category || '').toLowerCase().includes(searchLower) ||
                (p.brand || '').toLowerCase().includes(searchLower) ||
                (p.conventionalName || '').toLowerCase().includes(searchLower)
            );
            
            console.log('R√©sultats trouv√©s:', filtered.length);
            
            const tbody = document.querySelector('#products-table tbody');
            if (tbody) {
                tbody.innerHTML = renderProductRows(filtered);
                attachProductCheckboxListeners();
            }
        }

        // ============ PRODUCT MODAL ============
        function openProductModal() {
            editingProduct = null;
            document.getElementById('modal-title').textContent = 'Ajouter un produit';
            document.getElementById('product-form').reset();
            document.getElementById('product-modal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
            editingProduct = null;
        }

        function editProduct(product) {
            editingProduct = product;
            document.getElementById('modal-title').textContent = 'Modifier le produit';
            document.getElementById('product-image').value = product.image || '';
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-conventional').value = product.conventionalName || '';
            document.getElementById('product-ref').value = product.reference;
            document.getElementById('product-barcode').value = product.barcode || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-brand').value = product.brand || '';
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-quantity').value = product.quantity || 0;
            document.getElementById('product-modal').classList.add('active');
        }

        function deleteProduct(reference) {
            console.log('Suppression du produit:', reference);
            if (confirm('Voulez-vous vraiment supprimer ce produit ?')) {
                const initialLength = products.length;
                products = products.filter(p => p.reference !== reference);
                
                // Supprimer aussi des PDV
                pointsVente.forEach(pdv => {
                    if (pdv.products) {
                        pdv.products = pdv.products.filter(p => p.reference !== reference);
                    }
                });
                
                console.log(`Produits avant: ${initialLength}, apr√®s: ${products.length}`);
                saveProducts();
                savePDV();
                showToast('Produit supprim√© avec succ√®s', 'success');
                
                // Recharger la page produits
                if (currentPage === 'products') {
                    renderProducts();
                }
            }
        }

        // ============ PRODUCT FORM SUBMIT ============
        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                image: document.getElementById('product-image').value,
                name: document.getElementById('product-name').value,
                conventionalName: document.getElementById('product-conventional').value,
                reference: document.getElementById('product-ref').value,
                barcode: document.getElementById('product-barcode').value,
                category: document.getElementById('product-category').value,
                brand: document.getElementById('product-brand').value,
                price: parseFloat(document.getElementById('product-price').value),
                quantity: parseInt(document.getElementById('product-quantity').value) || 0
            };

            if (editingProduct) {
                const index = products.findIndex(p => p.reference === editingProduct.reference);
                products[index] = { ...products[index], ...productData };
                showToast('Produit modifi√© avec succ√®s', 'success');
            } else {
                if (products.some(p => p.reference === productData.reference)) {
                    showToast('Cette r√©f√©rence existe d√©j√†', 'error');
                    return;
                }
                products.push(productData);
                showToast('Produit ajout√© avec succ√®s', 'success');
            }

            saveProducts();
            closeProductModal();
            renderProducts();
        });

        // ============ IMPORT EXCEL ============
        function openImportModal() {
            document.getElementById('import-modal').classList.add('active');
            document.getElementById('import-progress').classList.add('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
            document.getElementById('excel-file').value = '';
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('=== D√âBUT IMPORT EXCEL ===');
            
            const progressContainer = document.getElementById('import-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.classList.remove('hidden');
            progressFill.style.width = '0%';
            progressText.textContent = 'Lecture du fichier...';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                console.log(`Fichier lu: ${rows.length} lignes`);
                console.log('Premi√®re ligne:', rows[0]);
                
                if (rows.length === 0) {
                    showToast('Le fichier est vide', 'error');
                    closeImportModal();
                    return;
                }

                // D√©tecter les colonnes de quantit√© PDV (QTY XXX)
                const columns = Object.keys(rows[0]);
                const pdvColumns = columns.filter(col => col.startsWith('QTY '));
                console.log('Colonnes PDV d√©tect√©es:', pdvColumns);

                // Cr√©er automatiquement les PDV s'ils n'existent pas
                pdvColumns.forEach(col => {
                    const pdvName = col.replace('QTY ', '').trim();
                    if (!pointsVente.find(p => p.name === pdvName)) {
                        pointsVente.push({
                            id: Date.now().toString() + Math.random(),
                            name: pdvName,
                            products: []
                        });
                        console.log('PDV cr√©√©:', pdvName);
                    }
                });

                progressText.textContent = `Traitement: 0/${rows.length} (0%)`;
                
                let imported = 0;
                const batchSize = 50;
                
                for (let i = 0; i < rows.length; i += batchSize) {
                    const batch = rows.slice(i, i + batchSize);
                    
                    for (const row of batch) {
                        // Convertir l'URL Google Drive
                        let imageUrl = row['IMAGE'] || '';
                        
                        if (imageUrl) {
                            // Supprimer les espaces
                            imageUrl = imageUrl.trim();
                            
                            // Convertir les diff√©rents formats Google Drive
                            if (imageUrl.includes('drive.google.com')) {
                                // Format: https://drive.google.com/file/d/ID/view
                                let match = imageUrl.match(/\/file\/d\/([^/]+)/);
                                if (match) {
                                    imageUrl = `https://drive.google.com/uc?export=view&id=${match[1]}`;
                                }
                                // Format: https://drive.google.com/open?id=ID
                                else {
                                    match = imageUrl.match(/[?&]id=([^&]+)/);
                                    if (match) {
                                        imageUrl = `https://drive.google.com/uc?export=view&id=${match[1]}`;
                                    }
                                }
                            }
                        }

                        const reference = row['R√©f√©rence'] || row['Reference'] || `REF-${Date.now()}-${i}`;

                        // Calculer le stock total (somme de tous les PDV)
                        let totalQuantity = 0;
                        pdvColumns.forEach(col => {
                            totalQuantity += parseInt(row[col]) || 0;
                        });
                        
                        // Si aucune colonne QTY, utiliser Repetition
                        if (pdvColumns.length === 0 && row['Repetition']) {
                            totalQuantity = parseInt(row['Repetition']) || 0;
                        }

                        const product = {
                            image: imageUrl,
                            name: row['Real Name'] || row['Nom'] || '',
                            conventionalName: row['Conventional Name'] || '',
                            reference: reference,
                            barcode: row['Barcode'] || '',
                            category: row['Category'] || row['Cat√©gorie'] || '',
                            brand: row['Brand'] || row['Marque'] || '',
                            price: parseFloat(row['Selling Price'] || row['Prix'] || 0),
                            quantity: totalQuantity
                        };

                        console.log(`Produit: ${product.name}, Image URL: ${product.image}`);

                        // V√©rifier si le produit existe d√©j√†
                        const existingIndex = products.findIndex(p => p.reference === product.reference);
                        if (existingIndex >= 0) {
                            // Mise √† jour: garder l'ancienne image si la nouvelle est vide
                            const oldImage = products[existingIndex].image;
                            products[existingIndex] = { 
                                ...products[existingIndex], 
                                ...product,
                                image: product.image || oldImage
                            };
                        } else {
                            products.push(product);
                        }

                        // Ajouter les quantit√©s dans chaque PDV
                        pdvColumns.forEach(col => {
                            const pdvName = col.replace('QTY ', '').trim();
                            const pdv = pointsVente.find(p => p.name === pdvName);
                            if (pdv) {
                                const quantity = parseInt(row[col]) || 0;
                                if (!pdv.products) pdv.products = [];
                                
                                const pdvProductIndex = pdv.products.findIndex(p => p.reference === reference);
                                if (pdvProductIndex >= 0) {
                                    pdv.products[pdvProductIndex].quantity = quantity;
                                } else if (quantity > 0) {
                                    pdv.products.push({
                                        reference: reference,
                                        quantity: quantity
                                    });
                                }
                            }
                        });
                        
                        imported++;
                    }

                    // Mise √† jour de la progression
                    const progress = Math.round((imported / rows.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Trait√©: ${imported}/${rows.length} (${progress}%)`;
                    
                    // Pause pour ne pas bloquer l'interface
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                // Sauvegarder les produits ET les PDV
                saveProducts();
                savePDV();
                
                console.log(`Import termin√©: ${imported} produits`);
                console.log(`PDV cr√©√©s/mis √† jour: ${pdvColumns.length}`);
                
                // Recalculer tous les stocks totaux apr√®s import
                products.forEach(product => {
                    const totalInAllPDV = pointsVente.reduce((sum, pdv) => {
                        const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                        return sum + (pdvProduct?.quantity || 0);
                    }, 0);
                    product.quantity = totalInAllPDV;
                });
                saveProducts();
                
                showToast(`${imported} produit(s) import√©(s) avec succ√®s dans ${pdvColumns.length} point(s) de vente`, 'success');
                
                // Fermer le modal apr√®s un court d√©lai
                setTimeout(() => {
                    closeImportModal();
                    if (currentPage === 'products') {
                        renderProducts();
                    }
                }, 1000);

            } catch (error) {
                console.error('Erreur import:', error);
                showToast('Erreur lors de l\'importation: ' + error.message, 'error');
                closeImportModal();
            }
        }

        // ============ EXPORT EXCEL ============
        function exportProducts() {
            if (products.length === 0) {
                showToast('Aucun produit √† exporter', 'warning');
                return;
            }

            // R√©cup√©rer tous les noms de PDV
            const pdvNames = pointsVente.map(pdv => pdv.name);

            const exportData = products.map(p => {
                const row = {
                    'IMAGE': p.image || '',
                    'Real Name': p.name,
                    'Conventional Name': p.conventionalName || '',
                    'R√©f√©rence': p.reference,
                    'Barcode': p.barcode || '',
                    'Repetition': p.quantity || 0,
                    'Category': p.category || '',
                    'Brand': p.brand || ''
                };

                // Ajouter les colonnes QTY pour chaque PDV
                pdvNames.forEach(pdvName => {
                    const pdv = pointsVente.find(pv => pv.name === pdvName);
                    const pdvProduct = pdv?.products?.find(pp => pp.reference === p.reference);
                    row[`QTY ${pdvName}`] = pdvProduct?.quantity || 0;
                });

                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `produits_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast('Export r√©ussi', 'success');
        }

        // ============ MOVEMENTS PAGE ============
        function renderMovements() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîÑ Mouvements de stock</h3>
                        <input type="text" class="search-input" id="movement-search" placeholder="üîç Rechercher un produit ou r√©f√©rence..." onkeyup="filterMovementProducts(this.value)">
                    </div>
                    
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Type de mouvement</label>
                                <select id="movement-type" onchange="updateMovementForm()" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                                    <option value="in">Entr√©e (+)</option>
                                    <option value="out">Sortie (-)</option>
                                    <option value="transfer">Transfert entre PDV</option>
                                </select>
                            </div>
                            
                            <div id="reason-container">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Raison</label>
                                <select id="movement-reason" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                                    <option value="Achat">Achat fournisseur</option>
                                    <option value="Retour">Retour client</option>
                                    <option value="Vente">Vente</option>
                                    <option value="Ajustement">Ajustement inventaire</option>
                                    <option value="Casse">Casse/Perte</option>
                                </select>
                            </div>

                            <div id="pdv-source-container" style="display: none;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Point de vente SOURCE</label>
                                <select id="pdv-source" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                                    <option value="">-- Stock Central --</option>
                                    ${pointsVente.map(pdv => `<option value="${pdv.id}">${pdv.name}</option>`).join('')}
                                </select>
                            </div>

                            <div id="pdv-dest-container" style="display: none;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Point de vente DESTINATION</label>
                                <select id="pdv-dest" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                                    <option value="">-- Stock Central --</option>
                                    ${pointsVente.map(pdv => `<option value="${pdv.id}">${pdv.name}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Note (optionnel)</label>
                                <input type="text" id="movement-note" placeholder="Commentaire..." style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="validateMovement()" style="font-size: 1.1rem; padding: 0.9rem 3rem; font-weight: 600;">
                                ‚úì VALIDER LE MOUVEMENT
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onchange="toggleAllProducts(this.checked)"></th>
                                    <th>Image</th>
                                    <th>Produit</th>
                                    <th>R√©f√©rence</th>
                                    <th>Stock actuel</th>
                                    <th>Quantit√©</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table-body">
                                ${renderMovementRows(products)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Activer/d√©sactiver les champs quantit√© selon la s√©lection
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const input = document.querySelector(`.quantity-input[data-ref="${this.dataset.ref}"]`);
                    input.disabled = !this.checked;
                    if (!this.checked) input.value = '';
                });
            });
        }

        function updateMovementForm() {
            const type = document.getElementById('movement-type').value;
            const reasonContainer = document.getElementById('reason-container');
            const pdvSourceContainer = document.getElementById('pdv-source-container');
            const pdvDestContainer = document.getElementById('pdv-dest-container');

            if (type === 'transfer') {
                reasonContainer.style.display = 'none';
                pdvSourceContainer.style.display = 'block';
                pdvDestContainer.style.display = 'block';
            } else {
                reasonContainer.style.display = 'block';
                pdvSourceContainer.style.display = 'none';
                pdvDestContainer.style.display = 'none';
            }
        }

        function renderMovementRows(productList) {
            if (productList.length === 0) {
                return '<tr><td colspan="6" class="text-center">Aucun produit trouv√©</td></tr>';
            }
            
            return productList.map(p => {
                const imageSrc = p.image || '';
                const idMatch = imageSrc.match(/[?&]id=([^&]+)/);
                const fileId = idMatch ? idMatch[1] : null;
                let imageHtml = 'üì¶';
                
                if (fileId) {
                    imageHtml = `<img src="https://drive.google.com/thumbnail?id=${fileId}&sz=w200" class="product-img" onclick="openImageModal('https://drive.google.com/uc?export=view&id=${fileId}')" onerror="if (this.src.includes('thumbnail')) { this.src='https://drive.google.com/uc?export=view&id=${fileId}'; } else { this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'; }" alt="${p.name}">`;
                }
                
                return `
                <tr>
                    <td><input type="checkbox" class="product-checkbox" data-ref="${p.reference}"></td>
                    <td>${imageHtml}</td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.reference}</td>
                    <td><strong>${p.quantity || 0}</strong></td>
                    <td><input type="number" class="quantity-input" data-ref="${p.reference}" min="1" style="width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" disabled></td>
                </tr>
            `}).join('');
        }

        function filterMovementProducts(search) {
            const searchLower = search.toLowerCase().trim();
            console.log('Recherche mouvements:', searchLower);
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchLower) ||
                p.reference.toLowerCase().includes(searchLower) ||
                (p.conventionalName || '').toLowerCase().includes(searchLower) ||
                (p.barcode || '').toLowerCase().includes(searchLower)
            );
            
            console.log('R√©sultats trouv√©s:', filtered.length);
            
            const tbody = document.getElementById('movements-table-body');
            if (tbody) {
                tbody.innerHTML = renderMovementRows(filtered);
                
                // R√©attacher les event listeners apr√®s le filtrage
                document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const input = document.querySelector(`.quantity-input[data-ref="${this.dataset.ref}"]`);
                        if (input) {
                            input.disabled = !this.checked;
                            if (!this.checked) input.value = '';
                        }
                    });
                });
            }
        }

        function toggleAllProducts(checked) {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = checked;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        function validateMovement() {
            const type = document.getElementById('movement-type').value;
            const reason = document.getElementById('movement-reason')?.value;
            const note = document.getElementById('movement-note').value;
            
            const checkedProducts = [];
            document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
                const ref = checkbox.dataset.ref;
                const quantityInput = document.querySelector(`.quantity-input[data-ref="${ref}"]`);
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (quantity > 0) {
                    checkedProducts.push({ reference: ref, quantity });
                }
            });

            if (checkedProducts.length === 0) {
                showToast('Veuillez s√©lectionner au moins un produit avec une quantit√©', 'warning');
                return;
            }

            // Transfert entre PDV
            if (type === 'transfer') {
                const pdvSourceId = document.getElementById('pdv-source').value;
                const pdvDestId = document.getElementById('pdv-dest').value;

                if (pdvSourceId === pdvDestId) {
                    showToast('Le point de vente source et destination doivent √™tre diff√©rents', 'error');
                    return;
                }

                console.log('=== TRANSFERT ENTRE PDV ===');
                console.log('Source:', pdvSourceId || 'Stock Central', 'Destination:', pdvDestId || 'Stock Central');
                console.log('Produits:', checkedProducts);

                let processedCount = 0;

                checkedProducts.forEach(item => {
                    const product = products.find(p => p.reference === item.reference);
                    if (!product) return;

                    // SOURCE: Retirer du stock
                    if (pdvSourceId === '') {
                        // Retirer du stock central
                        if ((product.quantity || 0) < item.quantity) {
                            showToast(`Stock central insuffisant pour ${product.name}`, 'error');
                            return;
                        }
                        product.quantity = (product.quantity || 0) - item.quantity;
                    } else {
                        // Retirer du PDV source
                        const pdvSource = pointsVente.find(p => p.id === pdvSourceId);
                        if (!pdvSource.products) pdvSource.products = [];
                        const pdvProduct = pdvSource.products.find(p => p.reference === item.reference);
                        
                        if (!pdvProduct || (pdvProduct.quantity || 0) < item.quantity) {
                            showToast(`Stock insuffisant dans le PDV source pour ${product.name}`, 'error');
                            return;
                        }
                        
                        pdvProduct.quantity -= item.quantity;
                        // Ne pas toucher au stock total du produit lors d'un transfert PDV vers PDV
                    }

                    // DESTINATION: Ajouter au stock
                    if (pdvDestId === '') {
                        // Ajouter au stock central
                        product.quantity = (product.quantity || 0) + item.quantity;
                    } else {
                        // Ajouter au PDV destination
                        const pdvDest = pointsVente.find(p => p.id === pdvDestId);
                        if (!pdvDest.products) pdvDest.products = [];
                        const pdvProductDest = pdvDest.products.find(p => p.reference === item.reference);
                        
                        if (pdvProductDest) {
                            pdvProductDest.quantity = (pdvProductDest.quantity || 0) + item.quantity;
                        } else {
                            pdvDest.products.push({
                                reference: item.reference,
                                quantity: item.quantity
                            });
                        }
                        // Ne pas toucher au stock total du produit lors d'un transfert PDV vers PDV
                    }

                    // Recalculer le stock total = somme de tous les PDV
                    const totalInAllPDV = pointsVente.reduce((sum, pdv) => {
                        const pdvProd = pdv.products?.find(p => p.reference === item.reference);
                        return sum + (pdvProd?.quantity || 0);
                    }, 0);
                    product.quantity = totalInAllPDV;

                    // Enregistrer le mouvement
                    const pdvSourceName = pdvSourceId ? pointsVente.find(p => p.id === pdvSourceId)?.name : 'Stock Central';
                    const pdvDestName = pdvDestId ? pointsVente.find(p => p.id === pdvDestId)?.name : 'Stock Central';

                    movements.push({
                        id: Date.now() + Math.random(),
                        date: new Date().toISOString(),
                        type: 'transfer',
                        reason: `Transfert: ${pdvSourceName} ‚Üí ${pdvDestName}`,
                        note,
                        product: product.name,
                        reference: product.reference,
                        quantity: item.quantity,
                        pdvSource: pdvSourceName,
                        pdvDest: pdvDestName
                    });
                    
                    processedCount++;
                });

                if (processedCount > 0) {
                    saveProducts();
                    savePDV();
                    saveMovements();
                    showToast(`${processedCount} transfert(s) effectu√©(s) avec succ√®s`, 'success');
                    renderMovements();
                }
                return;
            }

            // Mouvements normaux (Entr√©e/Sortie)
            console.log('=== VALIDATION MOUVEMENT ===');
            console.log('Type:', type, 'Raison:', reason);
            console.log('Produits:', checkedProducts);

            let processedCount = 0;

            checkedProducts.forEach(item => {
                const product = products.find(p => p.reference === item.reference);
                if (!product) return;

                const oldQuantity = product.quantity || 0;
                let newQuantity;

                if (type === 'in') {
                    newQuantity = oldQuantity + item.quantity;
                } else {
                    if (oldQuantity < item.quantity) {
                        showToast(`Stock insuffisant pour ${product.name} (disponible: ${oldQuantity})`, 'error');
                        return;
                    }
                    newQuantity = oldQuantity - item.quantity;
                }

                // Mettre √† jour le stock
                product.quantity = newQuantity;

                // Enregistrer le mouvement
                const movement = {
                    id: Date.now() + Math.random(),
                    date: new Date().toISOString(),
                    type,
                    reason,
                    note,
                    product: product.name,
                    reference: product.reference,
                    quantity: item.quantity,
                    oldQuantity,
                    newQuantity
                };
                
                movements.push(movement);
                processedCount++;
            });

            if (processedCount > 0) {
                saveProducts();
                saveMovements();
                showToast(`${processedCount} mouvement(s) enregistr√©(s) avec succ√®s`, 'success');
                renderMovements();
            }
        }

        // ============ POINTS DE VENTE ============
        function renderPointsVente() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè™ Points de Vente</h3>
                        <div class="btn-group">
                            <input type="text" id="pdv-search" class="search-input" placeholder="üîç Rechercher un produit ou r√©f√©rence..." onkeyup="filterPDVProducts(this.value)">
                            <button class="btn btn-primary" onclick="openAddPDVModal()">‚ûï Ajouter un point de vente</button>
                        </div>
                    </div>

                    <div class="pdv-grid">
                        ${pointsVente.map(pdv => `
                            <div class="pdv-card">
                                <div class="pdv-name">${pdv.name}</div>
                                <div class="pdv-stock">${pdv.products?.length || 0} produits</div>
                                <div style="margin-top: 0.5rem;">
                                    <button class="btn btn-primary" onclick="viewPDV('${pdv.id}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; width: 100%;">Voir d√©tails</button>
                                </div>
                            </div>
                        `).join('') || '<p style="grid-column: 1/-1; text-align: center; color: #666;">Aucun point de vente configur√©</p>'}
                    </div>

                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">üìä Vue d'ensemble du stock par point de vente</h4>
                        <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                            <strong>L√©gende :</strong> Le stock total d'un produit = somme de tous les points de vente
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>R√©f√©rence</th>
                                        <th>Stock Total</th>
                                        ${pointsVente.map(pdv => `<th>${pdv.name}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody id="pdv-overview-body">
                                    ${renderPDVOverview(products)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPDVOverview(filteredProducts) {
            if (filteredProducts.length === 0) {
                return '<tr><td colspan="100" class="text-center">Aucun produit disponible</td></tr>';
            }

            return filteredProducts.map(product => {
                // Calculer le stock total = somme de tous les PDV
                const totalInAllPDV = pointsVente.reduce((sum, pdv) => {
                    const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                    return sum + (pdvProduct?.quantity || 0);
                }, 0);
                
                // Mettre √† jour le stock total du produit si n√©cessaire
                if (product.quantity !== totalInAllPDV) {
                    product.quantity = totalInAllPDV;
                }
                
                return `
                <tr>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.reference}</td>
                    <td><strong style="color: #2563eb;">${totalInAllPDV}</strong></td>
                    ${pointsVente.map(pdv => {
                        const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                        const qty = pdvProduct?.quantity || 0;
                        return `<td>${qty}</td>`;
                    }).join('')}
                </tr>
            `}).join('');
        }

        function filterPDVProducts(search) {
            const searchLower = search.toLowerCase().trim();
            console.log('Recherche PDV:', searchLower);
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchLower) ||
                p.reference.toLowerCase().includes(searchLower) ||
                (p.conventionalName || '').toLowerCase().includes(searchLower) ||
                (p.barcode || '').toLowerCase().includes(searchLower)
            );
            
            console.log('R√©sultats trouv√©s:', filtered.length);
            
            const tbody = document.getElementById('pdv-overview-body');
            if (tbody) {
                tbody.innerHTML = renderPDVOverview(filtered);
            }
        }

        function openAddPDVModal() {
            const name = prompt('Nom du point de vente:');
            if (name && name.trim()) {
                const pdv = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    products: []
                };
                pointsVente.push(pdv);
                savePDV();
                showToast('Point de vente ajout√©', 'success');
                renderPointsVente();
            }
        }

        function viewPDV(pdvId) {
            const pdv = pointsVente.find(p => p.id === pdvId);
            if (!pdv) return;

            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè™ ${pdv.name}</h3>
                        <button class="btn btn-secondary" onclick="renderPointsVente()">‚Üê Retour</button>
                    </div>

                    <h4 style="margin-bottom: 1rem;">Transf√©rer du stock vers ce point de vente</h4>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Stock Central</th>
                                    <th>Stock PDV</th>
                                    <th>Quantit√© √† transf√©rer</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => {
                                    const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                                    return `
                                        <tr>
                                            <td><strong>${product.name}</strong></td>
                                            <td>${product.quantity || 0}</td>
                                            <td>${pdvProduct?.quantity || 0}</td>
                                            <td><input type="number" id="transfer-${product.reference}" min="1" max="${product.quantity || 0}" style="width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></td>
                                            <td><button class="btn btn-primary" onclick="transferToPDV('${pdvId}', '${product.reference}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">‚û°Ô∏è Transf√©rer</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function transferToPDV(pdvId, productRef) {
            const pdv = pointsVente.find(p => p.id === pdvId);
            const product = products.find(p => p.reference === productRef);
            const input = document.getElementById(`transfer-${productRef}`);
            const quantity = parseInt(input.value) || 0;

            if (quantity <= 0) {
                showToast('Quantit√© invalide', 'error');
                return;
            }

            if ((product.quantity || 0) < quantity) {
                showToast('Stock insuffisant', 'error');
                return;
            }

            // Retirer du stock central
            product.quantity = (product.quantity || 0) - quantity;

            // Ajouter au PDV
            if (!pdv.products) pdv.products = [];
            const pdvProduct = pdv.products.find(p => p.reference === productRef);
            if (pdvProduct) {
                pdvProduct.quantity = (pdvProduct.quantity || 0) + quantity;
            } else {
                pdv.products.push({
                    reference: productRef,
                    quantity: quantity
                });
            }

            // Enregistrer le mouvement
            movements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                type: 'transfer',
                reason: 'Transfert vers PDV',
                note: `Transfert vers ${pdv.name}`,
                product: product.name,
                reference: productRef,
                quantity: quantity,
                oldQuantity: (product.quantity || 0) + quantity,
                newQuantity: product.quantity
            });

            saveProducts();
            savePDV();
            saveMovements();
            showToast(`${quantity} unit√©s transf√©r√©es vers ${pdv.name}`, 'success');
            viewPDV(pdvId);
        }

        // ============ HISTORY PAGE ============
        function renderHistory() {
            const sortedMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìú Historique des mouvements</h3>
                        <div class="btn-group">
                            <button class="btn btn-warning" onclick="exportHistory()">üì• Exporter</button>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; background: #f9fafb; padding: 1rem; border-radius: 8px;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">üîç Rechercher</label>
                            <input type="text" id="history-search" class="search-input" placeholder="Produit ou r√©f√©rence..." onkeyup="filterHistory()" style="width: 100%;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">üìÖ Date</label>
                            <input type="date" id="history-date" onchange="filterHistory()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">üìÜ Mois</label>
                            <input type="month" id="history-month" onchange="filterHistory()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">üìÖ Ann√©e</label>
                            <select id="history-year" onchange="filterHistory()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="">Toutes les ann√©es</option>
                                ${getAvailableYears().map(year => `<option value="${year}">${year}</option>`).join('')}
                            </select>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">üè™ Point de vente</label>
                            <select id="history-pdv" onchange="filterHistory()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="">Tous les PDV</option>
                                <option value="Stock Central">Stock Central</option>
                                ${pointsVente.map(pdv => `<option value="${pdv.name}">${pdv.name}</option>`).join('')}
                            </select>
                        </div>

                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="resetHistoryFilters()" style="width: 100%;">üîÑ R√©initialiser</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #2563eb;">
                        <strong id="history-count">${sortedMovements.length}</strong> mouvement(s) trouv√©(s)
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Raison</th>
                                    <th>Produit</th>
                                    <th>R√©f√©rence</th>
                                    <th>Quantit√©</th>
                                    <th>Stock avant</th>
                                    <th>Stock apr√®s</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                ${renderHistoryRows(sortedMovements)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getAvailableYears() {
            const years = new Set();
            movements.forEach(m => {
                const year = new Date(m.date).getFullYear();
                years.add(year);
            });
            return Array.from(years).sort((a, b) => b - a);
        }

        function resetHistoryFilters() {
            document.getElementById('history-search').value = '';
            document.getElementById('history-date').value = '';
            document.getElementById('history-month').value = '';
            document.getElementById('history-year').value = '';
            document.getElementById('history-pdv').value = '';
            filterHistory();
        }

        function filterHistory() {
            const searchLower = document.getElementById('history-search').value.toLowerCase().trim();
            const selectedDate = document.getElementById('history-date').value;
            const selectedMonth = document.getElementById('history-month').value;
            const selectedYear = document.getElementById('history-year').value;
            const selectedPDV = document.getElementById('history-pdv').value;

            console.log('=== FILTRES HISTORIQUE ===');
            console.log('Recherche:', searchLower);
            console.log('Date:', selectedDate);
            console.log('Mois:', selectedMonth);
            console.log('Ann√©e:', selectedYear);
            console.log('PDV:', selectedPDV);

            const sortedMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const filtered = sortedMovements.filter(m => {
                const movementDate = new Date(m.date);
                const movementDateStr = movementDate.toISOString().split('T')[0];
                const movementMonth = movementDate.toISOString().substring(0, 7);
                const movementYear = movementDate.getFullYear().toString();

                // Filtre par recherche texte
                const matchesSearch = !searchLower || 
                    m.product.toLowerCase().includes(searchLower) ||
                    m.reference.toLowerCase().includes(searchLower) ||
                    (m.reason || '').toLowerCase().includes(searchLower) ||
                    (m.note || '').toLowerCase().includes(searchLower);

                // Filtre par date exacte
                const matchesDate = !selectedDate || movementDateStr === selectedDate;

                // Filtre par mois
                const matchesMonth = !selectedMonth || movementMonth === selectedMonth;

                // Filtre par ann√©e
                const matchesYear = !selectedYear || movementYear === selectedYear;

                // Filtre par PDV (dans la raison ou les notes)
                const matchesPDV = !selectedPDV || 
                    (m.reason || '').includes(selectedPDV) ||
                    (m.note || '').includes(selectedPDV) ||
                    (m.pdvSource === selectedPDV) ||
                    (m.pdvDest === selectedPDV);

                return matchesSearch && matchesDate && matchesMonth && matchesYear && matchesPDV;
            });

            console.log('R√©sultats trouv√©s:', filtered.length);

            const tbody = document.getElementById('history-table-body');
            const countElement = document.getElementById('history-count');
            
            if (tbody) {
                tbody.innerHTML = renderHistoryRows(filtered);
            }
            
            if (countElement) {
                countElement.textContent = filtered.length;
            }
        }

        function exportHistory() {
            if (movements.length === 0) {
                showToast('Aucun historique √† exporter', 'warning');
                return;
            }

            // R√©cup√©rer les filtres actifs
            const searchLower = document.getElementById('history-search')?.value.toLowerCase().trim() || '';
            const selectedDate = document.getElementById('history-date')?.value || '';
            const selectedMonth = document.getElementById('history-month')?.value || '';
            const selectedYear = document.getElementById('history-year')?.value || '';
            const selectedPDV = document.getElementById('history-pdv')?.value || '';

            const sortedMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Appliquer les m√™mes filtres que l'affichage
            const filtered = sortedMovements.filter(m => {
                const movementDate = new Date(m.date);
                const movementDateStr = movementDate.toISOString().split('T')[0];
                const movementMonth = movementDate.toISOString().substring(0, 7);
                const movementYear = movementDate.getFullYear().toString();

                const matchesSearch = !searchLower || 
                    m.product.toLowerCase().includes(searchLower) ||
                    m.reference.toLowerCase().includes(searchLower) ||
                    (m.reason || '').toLowerCase().includes(searchLower) ||
                    (m.note || '').toLowerCase().includes(searchLower);

                const matchesDate = !selectedDate || movementDateStr === selectedDate;
                const matchesMonth = !selectedMonth || movementMonth === selectedMonth;
                const matchesYear = !selectedYear || movementYear === selectedYear;
                const matchesPDV = !selectedPDV || 
                    (m.reason || '').includes(selectedPDV) ||
                    (m.note || '').includes(selectedPDV) ||
                    (m.pdvSource === selectedPDV) ||
                    (m.pdvDest === selectedPDV);

                return matchesSearch && matchesDate && matchesMonth && matchesYear && matchesPDV;
            });

            if (filtered.length === 0) {
                showToast('Aucun mouvement √† exporter avec ces filtres', 'warning');
                return;
            }

            const exportData = filtered.map(m => ({
                'Date': new Date(m.date).toLocaleString('fr-FR'),
                'Type': m.type === 'in' ? 'Entr√©e' : m.type === 'transfer' ? 'Transfert' : 'Sortie',
                'Raison': m.reason,
                'Produit': m.product,
                'R√©f√©rence': m.reference,
                'Quantit√©': m.quantity,
                'Stock Avant': m.oldQuantity !== undefined ? m.oldQuantity : '',
                'Stock Apr√®s': m.newQuantity !== undefined ? m.newQuantity : '',
                'Note': m.note || ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Historique');
            
            const fileName = `historique_${selectedDate || selectedMonth || selectedYear || new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast(`${filtered.length} mouvement(s) export√©(s)`, 'success');
        }

        // ============ SAVE FUNCTIONS ============
        function saveProducts() {
            // Avant de sauvegarder, recalculer tous les stocks totaux
            products.forEach(product => {
                const totalInAllPDV = pointsVente.reduce((sum, pdv) => {
                    const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                    return sum + (pdvProduct?.quantity || 0);
                }, 0);
                product.quantity = totalInAllPDV;
            });
            localStorage.setItem('products', JSON.stringify(products));
        }

        function saveMovements() {
            localStorage.setItem('movements', JSON.stringify(movements));
        }

        function savePDV() {
            localStorage.setItem('pointsVente', JSON.stringify(pointsVente));
            // Apr√®s avoir sauvegard√© les PDV, recalculer les stocks totaux
            saveProducts();
        }

        // ============ INIT ============
        renderDashboard();
    </script>
</body>
</html>
