<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock Professionnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        
        /* Navbar */
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .navbar-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .nav-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .nav-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; background: transparent; color: #666; transition: all 0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #2563eb; color: white; }
        
        /* Container */
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid; }
        .stat-card.blue { border-color: #2563eb; }
        .stat-card.green { border-color: #10b981; }
        .stat-card.red { border-color: #ef4444; }
        .stat-card.orange { border-color: #f59e0b; }
        .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #333; }
        
        /* Cards */
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .card-title { font-size: 1.3rem; font-weight: bold; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.7rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        /* Search */
        .search-input { flex: 1; max-width: 400px; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; }
        tr:hover { background: #f9fafb; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.1); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        /* Form */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        /* Progress */
        .progress-container { margin: 1rem 0; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
        .progress-text { margin-top: 0.5rem; text-align: center; color: #666; font-size: 0.9rem; }
        
        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem; min-width: 300px; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Image Modal */
        .image-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .image-modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        
        /* Utilities */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        input[type="file"] { display: none; }
        
        /* Points de Vente */
        .pdv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .pdv-card { background: #f9fafb; padding: 1rem; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s; }
        .pdv-card.active { border-color: #2563eb; background: #eff6ff; }
        .pdv-card:hover { border-color: #93c5fd; }
        .pdv-name { font-weight: 600; margin-bottom: 0.5rem; }
        .pdv-stock { color: #666; font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            .navbar-content { flex-direction: column; }
            .card-header { flex-direction: column; align-items: stretch; }
            .search-input { max-width: 100%; }
            .btn-group { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">üì¶ Stock Pro</div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="showPage('products')">üì¶ Produits</button>
                <button class="nav-btn" onclick="showPage('movements')">üîÑ Mouvements</button>
                <button class="nav-btn" onclick="showPage('pointsVente')">üè™ Points de Vente</button>
                <button class="nav-btn" onclick="showPage('history')">üìú Historique</button>
            </div>
        </div>
    </div>

    <!-- Container -->
    <div class="container" id="app-container"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-close" onclick="closeImageModal()">‚úï</div>
        <img id="modal-image" src="" alt="">
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Ajouter un produit</h2>
                <button class="close-btn" onclick="closeProductModal()">√ó</button>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label>Image URL (Google Drive)</label>
                    <input type="text" id="product-image" placeholder="https://drive.google.com/uc?export=view&id=...">
                </div>
                <div class="form-group">
                    <label>Nom du produit *</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Nom commercial</label>
                    <input type="text" id="product-conventional">
                </div>
                <div class="form-group">
                    <label>R√©f√©rence *</label>
                    <input type="text" id="product-ref" required>
                </div>
                <div class="form-group">
                    <label>Code-barres</label>
                    <input type="text" id="product-barcode">
                </div>
                <div class="form-group">
                    <label>Cat√©gorie</label>
                    <input type="text" id="product-category">
                </div>
                <div class="form-group">
                    <label>Marque</label>
                    <input type="text" id="product-brand">
                </div>
                <div class="form-group">
                    <label>Prix de vente *</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                <div class="form-group">
                    <label>Quantit√© initiale</label>
                    <input type="number" id="product-quantity" value="0">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Importer depuis Excel</h2>
                <button class="close-btn" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="mb-2">
                <p style="color: #666; margin-bottom: 1rem;">
                    <strong>Format Excel attendu :</strong><br>
                    IMAGE | Real Name | Conventional Name | R√©f√©rence | Barcode | Repetition | Category | Brand | QTY [Nom PDV] | QTY [Nom PDV] | ...<br>
                    <small style="color: #999;">
                        Les colonnes <strong>QTY XXX</strong> repr√©sentent le stock de chaque point de vente (ex: QTY Al Baraka, QTY Roche Noire, QTY ALGHAFLA)<br>
                        Le syst√®me d√©tectera automatiquement tous les points de vente et distribuera le stock selon chaque colonne QTY.
                    </small>
                </p>
                <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleImport(event)">
                <button class="btn btn-primary" onclick="document.getElementById('excel-file').click()">üìÅ Choisir un fichier</button>
            </div>
            <div id="import-progress" class="progress-container hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Import en cours...</div>
            </div>
        </div>
    </div>

    <script>
        // ============ DATA STORAGE ============
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let movements = JSON.parse(localStorage.getItem('movements')) || [];
        let pointsVente = JSON.parse(localStorage.getItem('pointsVente')) || [];
        let currentPage = 'dashboard';
        let editingProduct = null;

        // ============ TOAST NOTIFICATIONS ============
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†'}</div>
                <div>${message}</div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ IMAGE MODAL ============
        function openImageModal(src) {
            document.getElementById('modal-image').src = src;
            document.getElementById('image-modal').classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        // ============ NAVIGATION ============
        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const pages = {
                'dashboard': renderDashboard,
                'products': renderProducts,
                'movements': renderMovements,
                'pointsVente': renderPointsVente,
                'history': renderHistory
            };
            
            pages[page]();
        }

        // ============ DASHBOARD ============
        function renderDashboard() {
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + (p.quantity || 0), 0);
            const lowStock = products.filter(p => (p.quantity || 0) < 10).length;
            const totalValue = products.reduce((sum, p) => sum + ((p.quantity || 0) * (p.price || 0)), 0);

            document.getElementById('app-container').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-label">Total Produits</div>
                        <div class="stat-value">${totalProducts}</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Stock Total</div>
                        <div class="stat-value">${totalStock}</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Alertes Stock Faible</div>
                        <div class="stat-value">${lowStock}</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Valeur Totale</div>
                        <div class="stat-value">${totalValue.toFixed(2)} DH</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üö® Produits en alerte</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Produit</th>
                                    <th>R√©f√©rence</th>
                                    <th>Stock</th>
                                    <th>Prix</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.filter(p => (p.quantity || 0) < 10).map(p => `
                                    <tr>
                                        <td>${p.image ? `<img src="${p.image}" class="product-img" onclick="openImageModal('${p.image}')" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E';" alt="${p.name}">` : 'üì¶'}</td>
                                        <td><strong>${p.name}</strong><br><small>${p.conventionalName || ''}</small></td>
                                        <td>${p.reference}</td>
                                        <td><span style="color: #ef4444; font-weight: bold;">${p.quantity || 0}</span></td>
                                        <td>${p.price} DH</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="5" class="text-center">Aucun produit en alerte</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ============ PRODUCTS PAGE ============
        function renderProducts() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üì¶ Gestion des produits</h3>
                        <div class="btn-group">
                            <input type="text" class="search-input" placeholder="üîç Rechercher un produit..." onkeyup="filterProducts(this.value)">
                            <button class="btn btn-primary" onclick="openProductModal()">‚ûï Ajouter</button>
                            <button class="btn btn-success" onclick="openImportModal()">üì§ Importer Excel</button>
                            <button class="btn btn-warning" onclick="exportProducts()">üì• Exporter Excel</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Nom</th>
                                    <th>R√©f√©rence</th>
                                    <th>Code-barres</th>
                                    <th>Cat√©gorie</th>
                                    <th>Marque</th>
                                    <th>Stock</th>
                                    <th>Prix</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderProductRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderProductRows(filteredProducts = products) {
            if (filteredProducts.length === 0) {
                return '<tr><td colspan="9" class="text-center">Aucun produit trouv√©</td></tr>';
            }
            
            return filteredProducts.map(p => `
                <tr>
                    <td>${p.image ? `<img src="${p.image}" class="product-img" onclick="openImageModal('${p.image}')" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E';" alt="${p.name}">` : 'üì¶'}</td>
                    <td>
                        <strong>${p.name}</strong>
                        ${p.conventionalName ? `<br><small style="color: #666;">${p.conventionalName}</small>` : ''}
                    </td>
                    <td>${p.reference}</td>
                    <td>${p.barcode || '-'}</td>
                    <td>${p.category || '-'}</td>
                    <td>${p.brand || '-'}</td>
                    <td><strong>${p.quantity || 0}</strong></td>
                    <td>${p.price} DH</td>
                    <td>
                        <button class="btn btn-primary" onclick='editProduct(${JSON.stringify(p)})' style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${p.reference}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterProducts(search) {
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search.toLowerCase()) ||
                p.reference.toLowerCase().includes(search.toLowerCase()) ||
                (p.barcode || '').toLowerCase().includes(search.toLowerCase()) ||
                (p.category || '').toLowerCase().includes(search.toLowerCase()) ||
                (p.brand || '').toLowerCase().includes(search.toLowerCase())
            );
            document.querySelector('#products-table tbody').innerHTML = renderProductRows(filtered);
        }

        // ============ PRODUCT MODAL ============
        function openProductModal() {
            editingProduct = null;
            document.getElementById('modal-title').textContent = 'Ajouter un produit';
            document.getElementById('product-form').reset();
            document.getElementById('product-modal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
            editingProduct = null;
        }

        function editProduct(product) {
            editingProduct = product;
            document.getElementById('modal-title').textContent = 'Modifier le produit';
            document.getElementById('product-image').value = product.image || '';
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-conventional').value = product.conventionalName || '';
            document.getElementById('product-ref').value = product.reference;
            document.getElementById('product-barcode').value = product.barcode || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-brand').value = product.brand || '';
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-quantity').value = product.quantity || 0;
            document.getElementById('product-modal').classList.add('active');
        }

        function deleteProduct(reference) {
            if (confirm('Voulez-vous vraiment supprimer ce produit ?')) {
                products = products.filter(p => p.reference !== reference);
                saveProducts();
                showToast('Produit supprim√© avec succ√®s', 'success');
                renderProducts();
            }
        }

        // ============ PRODUCT FORM SUBMIT ============
        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                image: document.getElementById('product-image').value,
                name: document.getElementById('product-name').value,
                conventionalName: document.getElementById('product-conventional').value,
                reference: document.getElementById('product-ref').value,
                barcode: document.getElementById('product-barcode').value,
                category: document.getElementById('product-category').value,
                brand: document.getElementById('product-brand').value,
                price: parseFloat(document.getElementById('product-price').value),
                quantity: parseInt(document.getElementById('product-quantity').value) || 0
            };

            if (editingProduct) {
                const index = products.findIndex(p => p.reference === editingProduct.reference);
                products[index] = { ...products[index], ...productData };
                showToast('Produit modifi√© avec succ√®s', 'success');
            } else {
                if (products.some(p => p.reference === productData.reference)) {
                    showToast('Cette r√©f√©rence existe d√©j√†', 'error');
                    return;
                }
                products.push(productData);
                showToast('Produit ajout√© avec succ√®s', 'success');
            }

            saveProducts();
            closeProductModal();
            renderProducts();
        });

        // ============ IMPORT EXCEL ============
        function openImportModal() {
            document.getElementById('import-modal').classList.add('active');
            document.getElementById('import-progress').classList.add('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
            document.getElementById('excel-file').value = '';
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('=== D√âBUT IMPORT EXCEL ===');
            
            const progressContainer = document.getElementById('import-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.classList.remove('hidden');
            progressFill.style.width = '0%';
            progressText.textContent = 'Lecture du fichier...';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                console.log(`Fichier lu: ${rows.length} lignes`);
                console.log('Premi√®re ligne:', rows[0]);
                
                if (rows.length === 0) {
                    showToast('Le fichier est vide', 'error');
                    closeImportModal();
                    return;
                }

                // D√©tecter les colonnes de quantit√© PDV (QTY XXX)
                const columns = Object.keys(rows[0]);
                const pdvColumns = columns.filter(col => col.startsWith('QTY '));
                console.log('Colonnes PDV d√©tect√©es:', pdvColumns);

                // Cr√©er automatiquement les PDV s'ils n'existent pas
                pdvColumns.forEach(col => {
                    const pdvName = col.replace('QTY ', '').trim();
                    if (!pointsVente.find(p => p.name === pdvName)) {
                        pointsVente.push({
                            id: Date.now().toString() + Math.random(),
                            name: pdvName,
                            products: []
                        });
                        console.log('PDV cr√©√©:', pdvName);
                    }
                });

                progressText.textContent = `Traitement: 0/${rows.length} (0%)`;
                
                let imported = 0;
                const batchSize = 50;
                
                for (let i = 0; i < rows.length; i += batchSize) {
                    const batch = rows.slice(i, i + batchSize);
                    
                    for (const row of batch) {
                        // Convertir l'URL Google Drive
                        let imageUrl = row['IMAGE'] || '';
                        
                        if (imageUrl) {
                            // Supprimer les espaces
                            imageUrl = imageUrl.trim();
                            
                            // Convertir les diff√©rents formats Google Drive
                            if (imageUrl.includes('drive.google.com')) {
                                // Format: https://drive.google.com/file/d/ID/view
                                let match = imageUrl.match(/\/file\/d\/([^/]+)/);
                                if (match) {
                                    imageUrl = `https://drive.google.com/uc?export=view&id=${match[1]}`;
                                }
                                // Format: https://drive.google.com/open?id=ID
                                else {
                                    match = imageUrl.match(/[?&]id=([^&]+)/);
                                    if (match) {
                                        imageUrl = `https://drive.google.com/uc?export=view&id=${match[1]}`;
                                    }
                                }
                            }
                        }

                        const reference = row['R√©f√©rence'] || row['Reference'] || `REF-${Date.now()}-${i}`;

                        // Calculer le stock total (somme de tous les PDV)
                        let totalQuantity = 0;
                        pdvColumns.forEach(col => {
                            totalQuantity += parseInt(row[col]) || 0;
                        });
                        
                        // Si aucune colonne QTY, utiliser Repetition
                        if (pdvColumns.length === 0 && row['Repetition']) {
                            totalQuantity = parseInt(row['Repetition']) || 0;
                        }

                        const product = {
                            image: imageUrl,
                            name: row['Real Name'] || row['Nom'] || '',
                            conventionalName: row['Conventional Name'] || '',
                            reference: reference,
                            barcode: row['Barcode'] || '',
                            category: row['Category'] || row['Cat√©gorie'] || '',
                            brand: row['Brand'] || row['Marque'] || '',
                            price: parseFloat(row['Selling Price'] || row['Prix'] || 0),
                            quantity: totalQuantity
                        };

                        console.log(`Produit: ${product.name}, Image: ${product.image}`);

                        // V√©rifier si le produit existe d√©j√†
                        const existingIndex = products.findIndex(p => p.reference === product.reference);
                        if (existingIndex >= 0) {
                            products[existingIndex] = { ...products[existingIndex], ...product };
                        } else {
                            products.push(product);
                        }

                        // Ajouter les quantit√©s dans chaque PDV
                        pdvColumns.forEach(col => {
                            const pdvName = col.replace('QTY ', '').trim();
                            const pdv = pointsVente.find(p => p.name === pdvName);
                            if (pdv) {
                                const quantity = parseInt(row[col]) || 0;
                                if (!pdv.products) pdv.products = [];
                                
                                const pdvProductIndex = pdv.products.findIndex(p => p.reference === reference);
                                if (pdvProductIndex >= 0) {
                                    pdv.products[pdvProductIndex].quantity = quantity;
                                } else if (quantity > 0) {
                                    pdv.products.push({
                                        reference: reference,
                                        quantity: quantity
                                    });
                                }
                            }
                        });
                        
                        imported++;
                    }

                    // Mise √† jour de la progression
                    const progress = Math.round((imported / rows.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Trait√©: ${imported}/${rows.length} (${progress}%)`;
                    
                    // Pause pour ne pas bloquer l'interface
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                // Sauvegarder les produits ET les PDV
                saveProducts();
                savePDV();
                
                console.log(`Import termin√©: ${imported} produits`);
                console.log(`PDV cr√©√©s/mis √† jour: ${pdvColumns.length}`);
                showToast(`${imported} produit(s) import√©(s) avec succ√®s dans ${pdvColumns.length} point(s) de vente`, 'success');
                
                // Fermer le modal apr√®s un court d√©lai
                setTimeout(() => {
                    closeImportModal();
                    if (currentPage === 'products') {
                        renderProducts();
                    }
                }, 1000);

            } catch (error) {
                console.error('Erreur import:', error);
                showToast('Erreur lors de l\'importation: ' + error.message, 'error');
                closeImportModal();
            }
        }

        // ============ EXPORT EXCEL ============
        function exportProducts() {
            if (products.length === 0) {
                showToast('Aucun produit √† exporter', 'warning');
                return;
            }

            const exportData = products.map(p => ({
                'IMAGE': p.image || '',
                'Real Name': p.name,
                'Conventional Name': p.conventionalName || '',
                'Selling Price': p.price,
                'Barcode': p.barcode || '',
                'Repetition': p.quantity || 0,
                'Barcode Category': '',
                'Category': p.category || '',
                'Brand': p.brand || '',
                'R√©f√©rence': p.reference
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `produits_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast('Export r√©ussi', 'success');
        }

        // ============ MOVEMENTS PAGE ============
        function renderMovements() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîÑ Mouvements de stock</h3>
                        <input type="text" class="search-input" id="movement-search" placeholder="üîç Rechercher un produit ou r√©f√©rence..." onkeyup="filterMovementProducts(this.value)">
                    </div>
                    
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Type de mouvement</label>
                                <select id="movement-type" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                                    <option value="in">Entr√©e (+)</option>
                                    <option value="out">Sortie (-)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Raison</label>
                                <select id="movement-reason" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                                    <option value="Achat">Achat fournisseur</option>
                                    <option value="Retour">Retour client</option>
                                    <option value="Vente">Vente</option>
                                    <option value="Transfert">Transfert</option>
                                    <option value="Ajustement">Ajustement inventaire</option>
                                    <option value="Casse">Casse/Perte</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Note (optionnel)</label>
                                <input type="text" id="movement-note" placeholder="Commentaire..." style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="validateMovement()" style="font-size: 1.1rem; padding: 0.9rem 3rem; font-weight: 600;">
                                ‚úì VALIDER LE MOUVEMENT
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onchange="toggleAllProducts(this.checked)"></th>
                                    <th>Image</th>
                                    <th>Produit</th>
                                    <th>R√©f√©rence</th>
                                    <th>Stock actuel</th>
                                    <th>Quantit√©</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table-body">
                                ${renderMovementRows(products)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Activer/d√©sactiver les champs quantit√© selon la s√©lection
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const input = document.querySelector(`.quantity-input[data-ref="${this.dataset.ref}"]`);
                    input.disabled = !this.checked;
                    if (!this.checked) input.value = '';
                });
            });
        }

        function renderMovementRows(productList) {
            if (productList.length === 0) {
                return '<tr><td colspan="6" class="text-center">Aucun produit trouv√©</td></tr>';
            }
            
            return productList.map(p => `
                <tr>
                    <td><input type="checkbox" class="product-checkbox" data-ref="${p.reference}"></td>
                    <td>${p.image ? `<img src="${p.image}" class="product-img" onclick="openImageModal('${p.image}')" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E';" alt="${p.name}">` : 'üì¶'}</td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.reference}</td>
                    <td><strong>${p.quantity || 0}</strong></td>
                    <td><input type="number" class="quantity-input" data-ref="${p.reference}" min="1" style="width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" disabled></td>
                </tr>
            `).join('');
        }

        function filterMovementProducts(search) {
            const searchLower = search.toLowerCase().trim();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchLower) ||
                p.reference.toLowerCase().includes(searchLower) ||
                (p.conventionalName || '').toLowerCase().includes(searchLower) ||
                (p.barcode || '').toLowerCase().includes(searchLower)
            );
            
            document.getElementById('movements-table-body').innerHTML = renderMovementRows(filtered);
            
            // R√©attacher les event listeners apr√®s le filtrage
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const input = document.querySelector(`.quantity-input[data-ref="${this.dataset.ref}"]`);
                    input.disabled = !this.checked;
                    if (!this.checked) input.value = '';
                });
            });
        }

        function toggleAllProducts(checked) {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = checked;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        function validateMovement() {
            const type = document.getElementById('movement-type').value;
            const reason = document.getElementById('movement-reason').value;
            const note = document.getElementById('movement-note').value;
            
            const checkedProducts = [];
            document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
                const ref = checkbox.dataset.ref;
                const quantityInput = document.querySelector(`.quantity-input[data-ref="${ref}"]`);
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (quantity > 0) {
                    checkedProducts.push({ reference: ref, quantity });
                }
            });

            if (checkedProducts.length === 0) {
                showToast('Veuillez s√©lectionner au moins un produit avec une quantit√©', 'warning');
                return;
            }

            console.log('=== VALIDATION MOUVEMENT ===');
            console.log('Type:', type, 'Raison:', reason);
            console.log('Produits:', checkedProducts);

            let processedCount = 0;

            checkedProducts.forEach(item => {
                const product = products.find(p => p.reference === item.reference);
                if (!product) return;

                const oldQuantity = product.quantity || 0;
                let newQuantity;

                if (type === 'in') {
                    newQuantity = oldQuantity + item.quantity;
                } else {
                    if (oldQuantity < item.quantity) {
                        showToast(`Stock insuffisant pour ${product.name} (disponible: ${oldQuantity})`, 'error');
                        return;
                    }
                    newQuantity = oldQuantity - item.quantity;
                }

                // Mettre √† jour le stock
                product.quantity = newQuantity;

                // Enregistrer le mouvement
                const movement = {
                    id: Date.now() + Math.random(),
                    date: new Date().toISOString(),
                    type,
                    reason,
                    note,
                    product: product.name,
                    reference: product.reference,
                    quantity: item.quantity,
                    oldQuantity,
                    newQuantity
                };
                
                movements.push(movement);
                processedCount++;
            });

            if (processedCount > 0) {
                saveProducts();
                saveMovements();
                showToast(`${processedCount} mouvement(s) enregistr√©(s) avec succ√®s`, 'success');
                renderMovements();
            }
        }

        // ============ POINTS DE VENTE ============
        function renderPointsVente() {
            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè™ Points de Vente</h3>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="openAddPDVModal()">‚ûï Ajouter un point de vente</button>
                        </div>
                    </div>

                    <div class="pdv-grid">
                        ${pointsVente.map(pdv => `
                            <div class="pdv-card">
                                <div class="pdv-name">${pdv.name}</div>
                                <div class="pdv-stock">${pdv.products?.length || 0} produits</div>
                                <div style="margin-top: 0.5rem;">
                                    <button class="btn btn-primary" onclick="viewPDV('${pdv.id}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; width: 100%;">Voir d√©tails</button>
                                </div>
                            </div>
                        `).join('') || '<p style="grid-column: 1/-1; text-align: center; color: #666;">Aucun point de vente configur√©</p>'}
                    </div>

                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">üìä Vue d'ensemble du stock par point de vente</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Stock Total</th>
                                        ${pointsVente.map(pdv => `<th>${pdv.name}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(product => `
                                        <tr>
                                            <td><strong>${product.name}</strong></td>
                                            <td><strong>${product.quantity || 0}</strong></td>
                                            ${pointsVente.map(pdv => {
                                                const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                                                return `<td>${pdvProduct?.quantity || 0}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function openAddPDVModal() {
            const name = prompt('Nom du point de vente:');
            if (name && name.trim()) {
                const pdv = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    products: []
                };
                pointsVente.push(pdv);
                savePDV();
                showToast('Point de vente ajout√©', 'success');
                renderPointsVente();
            }
        }

        function viewPDV(pdvId) {
            const pdv = pointsVente.find(p => p.id === pdvId);
            if (!pdv) return;

            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè™ ${pdv.name}</h3>
                        <button class="btn btn-secondary" onclick="renderPointsVente()">‚Üê Retour</button>
                    </div>

                    <h4 style="margin-bottom: 1rem;">Transf√©rer du stock vers ce point de vente</h4>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Stock Central</th>
                                    <th>Stock PDV</th>
                                    <th>Quantit√© √† transf√©rer</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => {
                                    const pdvProduct = pdv.products?.find(p => p.reference === product.reference);
                                    return `
                                        <tr>
                                            <td><strong>${product.name}</strong></td>
                                            <td>${product.quantity || 0}</td>
                                            <td>${pdvProduct?.quantity || 0}</td>
                                            <td><input type="number" id="transfer-${product.reference}" min="1" max="${product.quantity || 0}" style="width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></td>
                                            <td><button class="btn btn-primary" onclick="transferToPDV('${pdvId}', '${product.reference}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">‚û°Ô∏è Transf√©rer</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function transferToPDV(pdvId, productRef) {
            const pdv = pointsVente.find(p => p.id === pdvId);
            const product = products.find(p => p.reference === productRef);
            const input = document.getElementById(`transfer-${productRef}`);
            const quantity = parseInt(input.value) || 0;

            if (quantity <= 0) {
                showToast('Quantit√© invalide', 'error');
                return;
            }

            if ((product.quantity || 0) < quantity) {
                showToast('Stock insuffisant', 'error');
                return;
            }

            // Retirer du stock central
            product.quantity = (product.quantity || 0) - quantity;

            // Ajouter au PDV
            if (!pdv.products) pdv.products = [];
            const pdvProduct = pdv.products.find(p => p.reference === productRef);
            if (pdvProduct) {
                pdvProduct.quantity = (pdvProduct.quantity || 0) + quantity;
            } else {
                pdv.products.push({
                    reference: productRef,
                    quantity: quantity
                });
            }

            // Enregistrer le mouvement
            movements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                type: 'transfer',
                reason: 'Transfert vers PDV',
                note: `Transfert vers ${pdv.name}`,
                product: product.name,
                reference: productRef,
                quantity: quantity,
                oldQuantity: (product.quantity || 0) + quantity,
                newQuantity: product.quantity
            });

            saveProducts();
            savePDV();
            saveMovements();
            showToast(`${quantity} unit√©s transf√©r√©es vers ${pdv.name}`, 'success');
            viewPDV(pdvId);
        }

        // ============ HISTORY PAGE ============
        function renderHistory() {
            const sortedMovements = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('app-container').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìú Historique des mouvements</h3>
                        <button class="btn btn-warning" onclick="exportHistory()">üì• Exporter</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Raison</th>
                                    <th>Produit</th>
                                    <th>Quantit√©</th>
                                    <th>Stock avant</th>
                                    <th>Stock apr√®s</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedMovements.map(m => `
                                    <tr>
                                        <td>${new Date(m.date).toLocaleString('fr-FR')}</td>
                                        <td><span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; background: ${m.type === 'in' ? '#dcfce7' : '#fee2e2'}; color: ${m.type === 'in' ? '#166534' : '#991b1b'};">${m.type === 'in' ? 'ENTR√âE' : 'SORTIE'}</span></td>
                                        <td>${m.reason}</td>
                                        <td><strong>${m.product}</strong><br><small>${m.reference}</small></td>
                                        <td><strong>${m.quantity}</strong></td>
                                        <td>${m.oldQuantity}</td>
                                        <td>${m.newQuantity}</td>
                                        <td>${m.note || '-'}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="8" class="text-center">Aucun mouvement enregistr√©</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function exportHistory() {
            if (movements.length === 0) {
                showToast('Aucun historique √† exporter', 'warning');
                return;
            }

            const exportData = movements.map(m => ({
                'Date': new Date(m.date).toLocaleString('fr-FR'),
                'Type': m.type === 'in' ? 'Entr√©e' : 'Sortie',
                'Raison': m.reason,
                'Produit': m.product,
                'R√©f√©rence': m.reference,
                'Quantit√©': m.quantity,
                'Stock Avant': m.oldQuantity,
                'Stock Apr√®s': m.newQuantity,
                'Note': m.note || ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Historique');
            XLSX.writeFile(wb, `historique_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast('Export r√©ussi', 'success');
        }

        // ============ SAVE FUNCTIONS ============
        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function saveMovements() {
            localStorage.setItem('movements', JSON.stringify(movements));
        }

        function savePDV() {
            localStorage.setItem('pointsVente', JSON.stringify(pointsVente));
        }

        // ============ INIT ============
        renderDashboard();
    </script>
</body>
</html>
