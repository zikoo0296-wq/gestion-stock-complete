<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Pro - Gestion Interne</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f9fafb; }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            overflow-y: auto;
            z-index: 1000;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 2rem; }
        .logo-text { font-size: 1.5rem; font-weight: bold; }
        .user-profile {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .user-name { font-weight: 600; }
        .user-email { font-size: 0.85rem; opacity: 0.8; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid white;
        }
        .nav-icon { font-size: 1.2rem; }
        .main-content {
            margin-left: 260px;
            padding: 30px;
            min-height: 100vh;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-title { font-size: 2rem; font-weight: bold; color: var(--dark); }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-edit { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; margin-right: 5px; border: none; cursor: pointer; }
        .btn-delete { background: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .stat-label { font-size: 0.9rem; color: var(--gray); margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .stat-card.blue .stat-value { color: #3b82f6; }
        .stat-card.green .stat-value { color: var(--success); }
        .stat-card.red .stat-value { color: var(--danger); }
        .stat-card.orange .stat-value { color: var(--warning); }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title { font-size: 1.2rem; font-weight: 600; color: var(--dark); }
        .card-body { padding: 20px; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 6px; color: var(--dark); }
        .form-input, .form-select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: var(--light);
        }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        tr:hover { background: #f9fafb; }
        .custom-select-container {
            position: relative;
            width: 100%;
        }
        .custom-select-button {
            width: 100%;
            padding: 10px 35px 10px 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: auto !important;
        }
        .custom-select-button:hover {
            border-color: #667eea;
            background: #f9fafb;
        }
        .custom-select-button:active {
            background: #f3f4f6;
        }
        .custom-select-button::after {
            content: '‚ñº';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #6b7280;
            pointer-events: none;
        }
        .custom-select-button.open::after {
            content: '‚ñ≤';
        }
        .custom-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-height: 400px;
        }
        .custom-select-dropdown.show {
            display: block;
        }
        .custom-select-search {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }
        .custom-select-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .custom-select-search input:focus {
            outline: none;
            border-color: #667eea;
        }
        .custom-select-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .custom-select-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .custom-select-item:hover {
            background: #f9fafb;
        }
        .custom-select-item.selected {
            background: #ede9fe;
            font-weight: 600;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        .img-zoom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: zoom-out;
            animation: fadeIn 0.2s;
        }
        .img-zoom img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .section { display: none; }
        .section.active { display: block; }
        .search-input {
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 15px;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- PAGE DE CONNEXION - USERNAME ET PASSWORD UNIQUEMENT -->
    <div id="loginPage" style="display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background:white;padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:400px;max-width:90%;">
            <div style="text-align:center;margin-bottom:30px;">
                <div style="font-size:3rem;margin-bottom:10px;">üì¶</div>
                <h1 style="font-size:2rem;color:#1f2937;margin:0;">Stock Pro</h1>
                <p style="color:#6b7280;margin-top:10px;">Connexion</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;">Nom d'utilisateur</label>
                    <input type="text" id="login-username" required 
                           style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;transition:border-color 0.3s;"
                           placeholder="Entrez votre username"
                           autocomplete="username"
                           onfocus="this.style.borderColor='#667eea'" 
                           onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div style="margin-bottom:25px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;">Mot de passe</label>
                    <input type="password" id="login-password" required 
                           style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;transition:border-color 0.3s;"
                           placeholder="Entrez votre mot de passe"
                           autocomplete="current-password"
                           onfocus="this.style.borderColor='#667eea'" 
                           onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <button type="submit" 
                        style="width:100%;padding:14px;background:linear-gradient(135deg, #667eea, #764ba2);color:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s;"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(102,126,234,0.4)'"
                        onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
                    üîì Se connecter
                </button>
            </form>
            <div style="margin-top:25px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;">
                <p style="color:#9ca3af;font-size:0.85rem;margin:0;">
                    üîí Application priv√©e - Acc√®s r√©serv√©
                </p>
            </div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="mainApp" style="display:none;">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üì¶</div>
                <div class="logo-text">Stock Pro</div>
            </div>
        </div>
        <div class="user-profile">
            <div class="user-avatar">üë§</div>
            <div>
                <div class="user-name" id="user-name">Utilisateur</div>
                <div class="user-email" id="user-email">user@example.com</div>
            </div>
        </div>
        <nav>
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showSection('products')">
                <span class="nav-icon">üì¶</span>
                <span>Produits</span>
            </div>
            <div class="nav-item" onclick="showSection('movements')">
                <span class="nav-icon">üîÑ</span>
                <span>Mouvements</span>
            </div>
            <div class="nav-item" onclick="showSection('transfer')">
                <span class="nav-icon">üöö</span>
                <span>Transferts</span>
            </div>
            <div class="nav-item" onclick="showSection('pdv')">
                <span class="nav-icon">üè™</span>
                <span>Points de Vente</span>
            </div>
            <div class="nav-item" onclick="showSection('history')">
                <span class="nav-icon">üìú</span>
                <span>Historique</span>
            </div>
            <div class="nav-item" onclick="logout()">
                <span class="nav-icon">üö™</span>
                <span>D√©connexion</span>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="top-bar">
                <h1 class="page-title">üìä Dashboard</h1>
            </div>
            <div id="dash-content"></div>
        </div>

        <!-- PRODUITS -->
        <div id="products" class="section">
            <div class="top-bar">
                <h1 class="page-title">üì¶ Gestion des Produits</h1>
                <div>
                    <button class="btn btn-success" onclick="openModal('productModal')">‚ûï Nouveau Produit</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì• Importer Excel</button>
                    <button class="btn btn-primary" onclick="exportToExcel()">üì§ Exporter Excel</button>
                </div>
            </div>
            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none;" onchange="handleImport(event)">
            <div class="card">
                <div class="card-body">
                    <input type="text" id="prod-search" class="search-input" placeholder="üîç Rechercher par nom, r√©f√©rence, barcode...">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Nom</th>
                                    <th>R√©f√©rence</th>
                                    <th>Barcode</th>
                                    <th>Stock Total</th>
                                    <th>R√©p√©tition</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="prod-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOUVEMENTS -->
        <div id="movements" class="section">
            <div class="top-bar">
                <h1 class="page-title">üîÑ Gestion des Mouvements</h1>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Nouveau Mouvement</h3>
                </div>
                <div class="card-body">
                    <form onsubmit="addMovement(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Type *</label>
                                <select id="mov-type" class="form-select" required onchange="togglePdvSelect()">
                                    <option value="">S√©lectionner...</option>
                                    <option value="in">Entr√©e (+)</option>
                                    <option value="out">Sortie (-)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Produit *</label>
                                <div class="custom-select-container">
                                    <div class="custom-select-button" id="mov-select-btn" onclick="toggleMovDropdown(event)">
                                        S√©lectionner un produit...
                                    </div>
                                    <div class="custom-select-dropdown" id="mov-dropdown">
                                        <div class="custom-select-search">
                                            <input type="text" id="mov-search-input" placeholder="üîç Rechercher..." oninput="filterMovList()" onclick="event.stopPropagation()">
                                        </div>
                                        <div class="custom-select-list" id="mov-product-list"></div>
                                    </div>
                                    <input type="hidden" id="mov-product" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Point de Vente *</label>
                                <select id="mov-pdv" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantit√© *</label>
                                <input type="number" id="mov-quantity" class="form-input" min="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mode de Paiement *</label>
                                <select id="mov-payment" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Esp√®ce">Esp√®ce</option>
                                    <option value="Virement">Virement</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Raison</label>
                                <input type="text" id="mov-reason" class="form-input" placeholder="Facultatif">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <input type="text" id="mov-note" class="form-input" placeholder="Facultatif">
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top:15px;">‚úÖ Enregistrer</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- TRANSFERTS -->
        <div id="transfer" class="section">
            <div class="top-bar">
                <h1 class="page-title">üöö Transferts entre PDV</h1>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Nouveau Transfert</h3>
                </div>
                <div class="card-body">
                    <form onsubmit="addTransfer(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Produit *</label>
                                <div class="custom-select-container">
                                    <div class="custom-select-button" id="trans-select-btn" onclick="toggleTransDropdown(event)">
                                        S√©lectionner un produit...
                                    </div>
                                    <div class="custom-select-dropdown" id="trans-dropdown">
                                        <div class="custom-select-search">
                                            <input type="text" id="trans-search-input" placeholder="üîç Rechercher..." oninput="filterTransList()" onclick="event.stopPropagation()">
                                        </div>
                                        <div class="custom-select-list" id="trans-product-list"></div>
                                    </div>
                                    <input type="hidden" id="trans-product" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">De (Source) *</label>
                                <select id="trans-from" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vers (Destination) *</label>
                                <select id="trans-to" class="form-select" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantit√© *</label>
                                <input type="number" id="trans-quantity" class="form-input" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <input type="text" id="trans-note" class="form-input" placeholder="Facultatif">
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top:15px;">üöö Transf√©rer</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- POINTS DE VENTE -->
        <div id="pdv" class="section">
            <div class="top-bar">
                <h1 class="page-title">üè™ Points de Vente</h1>
                <button class="btn btn-success" onclick="openModal('pdvModal')">‚ûï Nouveau PDV</button>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <input type="text" id="pdv-search" class="search-input" placeholder="üîç Rechercher un produit par nom ou r√©f√©rence..." oninput="renderPdv()">
                    
                    <div class="table-container">
                        <table>
                            <thead id="pdv-table-header">
                                <tr>
                                    <th>Produit</th>
                                    <th>R√©f√©rence</th>
                                    <th>QTY Total</th>
                                </tr>
                            </thead>
                            <tbody id="pdv-products-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORIQUE -->
        <div id="history" class="section">
            <div class="top-bar">
                <h1 class="page-title">üìú Historique des Mouvements</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="form-grid">
                        <input type="text" id="hs" class="form-input" placeholder="üîç Rechercher...">
                        <input type="date" id="hd" class="form-input" placeholder="Date">
                        <select id="hm" class="form-select">
                            <option value="">Tous les mois</option>
                            <option value="0">Janvier</option>
                            <option value="1">F√©vrier</option>
                            <option value="2">Mars</option>
                            <option value="3">Avril</option>
                            <option value="4">Mai</option>
                            <option value="5">Juin</option>
                            <option value="6">Juillet</option>
                            <option value="7">Ao√ªt</option>
                            <option value="8">Septembre</option>
                            <option value="9">Octobre</option>
                            <option value="10">Novembre</option>
                            <option value="11">D√©cembre</option>
                        </select>
                        <select id="hy" class="form-select">
                            <option value="">Toutes les ann√©es</option>
                        </select>
                        <button class="btn btn-primary" onclick="rstHist()">üîÑ R√©initialiser</button>
                    </div>
                    <div class="table-container" style="margin-top:20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Raison</th>
                                    <th>Produit</th>
                                    <th>Quantit√©</th>
                                    <th>PDV/Paiement</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody id="hist-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- FIN APPLICATION PRINCIPALE -->

    <!-- MODALS -->
    <!-- MODAL PRODUIT -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter un Produit</h2>
                <button class="close-btn" onclick="closeModal('productModal')">‚úñ</button>
            </div>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label class="form-label">Nom du Produit *</label>
                    <input type="text" id="p-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">R√©f√©rence *</label>
                    <input type="text" id="p-ref" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantit√© Initiale</label>
                    <input type="number" id="p-qty" class="form-input" min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">R√©p√©tition</label>
                    <input type="text" id="p-rep" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Code-barres</label>
                    <input type="text" id="p-barcode" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie</label>
                    <input type="text" id="p-category" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Marque</label>
                    <input type="text" id="p-brand" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">URL Image Google Drive</label>
                    <input type="url" id="p-img" class="form-input" placeholder="https://drive.google.com/uc?export=view&id=...">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top:15px;">üíæ Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- MODAL PDV -->
    <div id="pdvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter un Point de Vente</h2>
                <button class="close-btn" onclick="closeModal('pdvModal')">‚úñ</button>
            </div>
            <form onsubmit="savePdv(event)">
                <input type="hidden" id="pdv-edit-id">
                <div class="form-group">
                    <label class="form-label">Nom du PDV *</label>
                    <input type="text" id="pdv-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Emplacement</label>
                    <input type="text" id="pdv-location" class="form-input">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top:15px;">üíæ Enregistrer</button>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION SUPABASE ==========
        let supabaseClient = null;
        let currentSupabaseUser = null;
        let useSupabase = false;
        
        // Initialiser Supabase si disponible
        if (typeof supabase !== 'undefined') {
            try {
                const SUPABASE_URL = 'https://djnaayhhntopupixzitm.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqbmFheWhobnRvcHVwaXh6aXRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzY0NTIsImV4cCI6MjA3NjU1MjQ1Mn0.AzrxJ7h7SNEgn-i8qgdGYPvoEpWdRohX1E8N_Ko_Gc0';
                
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase initialis√©');
                
                // V√©rifier session au d√©marrage (AUTO-RECONNEXION)
                supabaseClient.auth.getSession().then(function(result) {
                    if (result.data && result.data.session) {
                        currentSupabaseUser = result.data.session.user;
                        useSupabase = true;
                        console.log('‚úÖ Session Supabase:', currentSupabaseUser.email);
                        
                        // AUTO-RECONNEXION : Charger les donn√©es et afficher l'app
                        loadFromSupabase().then(function() {
                            document.getElementById('user-name').textContent = currentSupabaseUser.user_metadata.full_name || 'Utilisateur';
                            document.getElementById('user-email').textContent = currentSupabaseUser.email;
                            document.getElementById('loginPage').style.display = 'none';
                            document.getElementById('mainApp').style.display = 'block';
                            renderProds();
                            renderPdv();
                            renderMovForm();
                            renderHist();
                            renderDash();
                            console.log('‚úÖ Auto-reconnexion r√©ussie !');
                        });
                    }
                });
            } catch (error) {
                console.error('Erreur init Supabase:', error);
            }
        }
        
        // ========== COMPTES UTILISATEURS - MODIFIEZ ICI ==========
        const USERS = [
            { username: 'admin', password: 'admin123', fullName: 'Administrateur', role: 'admin' },
            { username: 'agent1', password: 'pass123', fullName: 'Agent 1', role: 'agent' },
            { username: 'agent2', password: 'pass456', fullName: 'Agent 2', role: 'agent' }
        ];
        
        // ========== FONCTION DE CONVERSION URL GOOGLE DRIVE ==========
        function convertGoogleDriveUrl(url) {
            if (!url) return '';
            
            url = url.toString().trim();
            
            // Si c'est d√©j√† au bon format thumbnail, retourner tel quel
            if (url.includes('drive.google.com/thumbnail')) {
                return url;
            }
            
            // Extraire l'ID du lien Google Drive
            let fileId = '';
            
            // Format: https://drive.google.com/file/d/ID/view
            if (url.includes('/file/d/')) {
                const match = url.match(/\/file\/d\/([^\/]+)/);
                if (match) fileId = match[1];
            }
            
            // Format: https://drive.google.com/open?id=ID
            else if (url.includes('open?id=')) {
                const match = url.match(/open\?id=([^&]+)/);
                if (match) fileId = match[1];
            }
            
            // Format: https://drive.google.com/uc?export=view&id=ID ou id=ID&export=view
            else if (url.includes('drive.google.com') && url.includes('id=')) {
                const match = url.match(/[?&]id=([^&]+)/);
                if (match) fileId = match[1];
            }
            
            // Si on a trouv√© un ID, retourner l'URL directe
            if (fileId) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w500`;
            }
            
            // Sinon retourner l'URL originale
            return url;
        }
        
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let pdvs = JSON.parse(localStorage.getItem('pdvs')) || [
            {id: 'al-baraka', name: 'Al Baraka', location: 'Centre-ville'},
            {id: 'alghafla', name: 'Alghafla', location: 'Zone industrielle'}
        ];
        let movements = JSON.parse(localStorage.getItem('movements')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];

        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                showLoginPage();
                return false;
            }
            const userExists = USERS.find(u => u.username === user.username);
            if (!userExists) {
                localStorage.removeItem('currentUser');
                showLoginPage();
                return false;
            }
            document.getElementById('user-name').textContent = user.fullName;
            document.getElementById('user-email').textContent = user.role === 'admin' ? 'Administrateur' : 'Agent';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            return true;
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            const user = USERS.find(function(u) { return u.username === username && u.password === password; });

            if (user) {
                // Connexion locale
                useSupabase = false;
                const userSession = {
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role
                };
                localStorage.setItem('currentUser', JSON.stringify(userSession));
                document.getElementById('user-name').textContent = user.fullName;
                document.getElementById('user-email').textContent = user.role === 'admin' ? 'Administrateur' : 'Agent';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                renderDash();
            } else if (username.includes('@') && supabaseClient) {
                // Connexion Supabase
                try {
                    console.log('üîµ Connexion Supabase...');
                    const result = await supabaseClient.auth.signInWithPassword({
                        email: username,
                        password: password
                    });
                    
                    if (result.error) throw result.error;
                    
                    currentSupabaseUser = result.data.user;
                    useSupabase = true;
                    
                    // Charger les donn√©es depuis Supabase
                    await loadFromSupabase();
                    
                    document.getElementById('user-name').textContent = result.data.user.user_metadata.full_name || 'Utilisateur';
                    document.getElementById('user-email').textContent = result.data.user.email;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Rendre toutes les sections
                    renderProds();
                    renderPdv();
                    renderMovForm();
                    renderHist();
                    renderDash();
                    
                    console.log('‚úÖ Connexion Supabase r√©ussie');
                } catch (error) {
                    console.error('‚ùå Erreur:', error);
                    alert('‚ùå Email ou mot de passe incorrect !');
                }
            } else {
                alert('‚ùå Nom d\'utilisateur ou mot de passe incorrect !');
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) {
                return;
            }
            renderDash();
        });

        function save() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('pdvs', JSON.stringify(pdvs));
            localStorage.setItem('movements', JSON.stringify(movements));
            localStorage.setItem('history', JSON.stringify(history));
            
            // Sauvegarder dans Supabase si connect√©
            if (useSupabase && currentSupabaseUser && supabaseClient) {
                saveToSupabase();
            }
        }
        
        async function saveToSupabase() {
            try {
                console.log('üíæ Sauvegarde Supabase COMPL√àTE...');
                
                const userId = currentSupabaseUser.id;
                
                // 1. Supprimer anciennes donn√©es
                await supabaseClient.from('products').delete().eq('user_id', userId);
                await supabaseClient.from('points_vente').delete().eq('user_id', userId);
                await supabaseClient.from('movements').delete().eq('user_id', userId);
                
                // 2. Sauvegarder produits avec pdvStock dans warehouse
                if (products.length > 0) {
                    const productsToInsert = products
                        .filter(function(p) { return p.reference && p.reference.trim(); })
                        .map(function(p) {
                            let qty = parseInt(p.quantity) || 0;
                            
                            // Sauvegarder pdvStock en JSON dans le champ warehouse
                            const pdvStockJson = JSON.stringify(p.pdvStock || {});
                            
                            return {
                                user_id: userId,
                                real_name: (p.realName || p.name || 'Produit').substring(0, 255),
                                conventional_name: (p.conventionalName || '').substring(0, 255),
                                reference: p.reference.trim(),
                                barcode: (p.barcode || '').substring(0, 255),
                                quantity: qty,
                                min_stock: 10,
                                category: (p.category || '').substring(0, 255),
                                brand: (p.brand || '').substring(0, 255),
                                warehouse: pdvStockJson.substring(0, 1000),
                                image: (p.imageUrl || '').substring(0, 1000)
                            };
                        });
                    
                    if (productsToInsert.length > 0) {
                        await supabaseClient.from('products').insert(productsToInsert);
                        console.log('‚úÖ Produits:', productsToInsert.length);
                    }
                }
                
                // 3. Sauvegarder points de vente
                if (pdvs.length > 0) {
                    const pdvsToInsert = pdvs
                        .filter(function(p) { return p.name && p.name.trim(); })
                        .map(function(p) {
                            return {
                                user_id: userId,
                                name: p.name.trim().substring(0, 255),
                                address: (p.location || '').substring(0, 500),
                                phone: p.id || '',
                                email: '',
                                manager: ''
                            };
                        });
                    
                    if (pdvsToInsert.length > 0) {
                        await supabaseClient.from('points_vente').insert(pdvsToInsert);
                        console.log('‚úÖ PDV:', pdvsToInsert.length);
                    }
                }
                
                // 4. Sauvegarder mouvements et historique
                const allMovements = movements.concat(history || []);
                if (allMovements.length > 0) {
                    const movsToInsert = allMovements.map(function(m) {
                        return {
                            user_id: userId,
                            product_id: 1,
                            type: m.type === 'Entr√©e' || m.type === 'entry' ? 'entry' : 
                                  m.type === 'Sortie' || m.type === 'exit' ? 'exit' : 'transfer',
                            quantity: parseInt(m.quantity) || 0,
                            reason: (m.reason || '').substring(0, 500),
                            customer: (m.customer || m.productName || '').substring(0, 255),
                            from_location: (m.from || '').substring(0, 255),
                            to_location: (m.to || '').substring(0, 255),
                            date: m.date || new Date().toISOString().split('T')[0],
                            user_name: m.user || 'Utilisateur'
                        };
                    }).filter(function(m) { return m.quantity > 0; });
                    
                    if (movsToInsert.length > 0) {
                        await supabaseClient.from('movements').insert(movsToInsert);
                        console.log('‚úÖ Mouvements:', movsToInsert.length);
                    }
                }
                
                console.log('‚úÖ Sauvegarde compl√®te termin√©e !');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde:', error.message);
            }
        }
        
        // Fonction pour charger depuis Supabase
        async function loadFromSupabase() {
            if (!currentSupabaseUser) return;
            
            try {
                console.log('üì• Chargement depuis Supabase...');
                
                // Charger produits
                const { data: prodsData } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('user_id', currentSupabaseUser.id);
                
                // Charger PDV
                const { data: pdvData } = await supabaseClient
                    .from('points_vente')
                    .select('*')
                    .eq('user_id', currentSupabaseUser.id);
                
                // Charger mouvements
                const { data: movData } = await supabaseClient
                    .from('movements')
                    .select('*')
                    .eq('user_id', currentSupabaseUser.id);
                
                // Convertir produits avec pdvStock
                if (prodsData && prodsData.length > 0) {
                    products = prodsData.map(function(p) {
                        // R√©cup√©rer pdvStock depuis warehouse (stock√© en JSON)
                        let pdvStock = {};
                        try {
                            if (p.warehouse && p.warehouse !== 'Entrep√¥t A') {
                                pdvStock = JSON.parse(p.warehouse);
                            }
                        } catch(e) {
                            pdvStock = {};
                        }
                        
                        return {
                            id: p.id.toString(),
                            name: p.real_name,
                            realName: p.real_name,
                            conventionalName: p.conventional_name || '',
                            reference: p.reference,
                            barcode: p.barcode || '',
                            repetition: p.quantity,
                            quantity: p.quantity,
                            category: p.category || '',
                            brand: p.brand || '',
                            imageUrl: p.image || '',
                            pdvStock: pdvStock
                        };
                    });
                }
                
                // Convertir PDV (r√©cup√©rer l'ID original depuis phone)
                if (pdvData && pdvData.length > 0) {
                    pdvs = pdvData.map(function(p) {
                        return {
                            id: p.phone || p.id.toString(),
                            name: p.name,
                            location: p.address || ''
                        };
                    });
                }
                
                // Convertir mouvements en movements ET history
                movements = [];
                history = [];
                
                if (movData && movData.length > 0) {
                    movData.forEach(function(m) {
                        const movObj = {
                            id: m.id.toString(),
                            type: m.type === 'entry' ? 'Entr√©e' : m.type === 'exit' ? 'Sortie' : 'Transfert',
                            productName: m.customer || 'Produit',
                            quantity: m.quantity,
                            reason: m.reason || '',
                            customer: m.customer || '',
                            from: m.from_location || '',
                            to: m.to_location || '',
                            date: m.date,
                            user: m.user_name || 'Utilisateur'
                        };
                        
                        // Si c'est un transfert, l'ajouter √† l'historique
                        if (m.type === 'transfer') {
                            history.push(movObj);
                        } else {
                            movements.push(movObj);
                        }
                    });
                }
                
                console.log('‚úÖ Charg√©:', products.length, 'produits,', pdvs.length, 'PDV,', movements.length, 'mouvements,', history.length, 'historique');
                
                // Sauvegarder en local aussi
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('pdvs', JSON.stringify(pdvs));
                localStorage.setItem('movements', JSON.stringify(movements));
                localStorage.setItem('history', JSON.stringify(history));
            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
            }
        }

        function showSection(sec) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sec).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (sec === 'dashboard') renderDash();
            if (sec === 'products') renderProds();
            if (sec === 'movements') { renderMovForm(); populateMovProductList(); }
            if (sec === 'transfer') { renderTransForm(); populateTransProductList(); }
            if (sec === 'pdv') renderPdv();
            if (sec === 'history') renderHist();
        }

        function renderDash() {
            const total = products.length;
            const stock = products.reduce((sum, p) => sum + (p.quantity || 0), 0);
            const low = products.filter(p => (p.quantity || 0) < 10).length;

            document.getElementById('dash-content').innerHTML = `
                <input type="text" id="dash-search" class="search-input" placeholder="üîç Rechercher..." style="width:100%;">
                <div class="stats-grid">
                    <div class="stat-card blue"><div class="stat-label">Total Produits</div><div class="stat-value">${total}</div></div>
                    <div class="stat-card green"><div class="stat-label">Stock Total</div><div class="stat-value">${stock}</div></div>
                    <div class="stat-card red"><div class="stat-label">Alertes Stock</div><div class="stat-value">${low}</div></div>
                    <div class="stat-card orange"><div class="stat-label">Points de Vente</div><div class="stat-value">${pdvs.length}</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üö® Alertes Stock (< 10 unit√©s)</h3></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Produit</th><th>R√©f√©rence</th><th>Stock</th></tr></thead>
                            <tbody id="dash-body">${renderAlerts(products.filter(p => (p.quantity || 0) < 10))}</tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('dash-search').oninput = function() {
                const s = this.value.toLowerCase();
                const f = products.filter(p => (p.quantity || 0) < 10 && (p.name.toLowerCase().includes(s) || p.reference.toLowerCase().includes(s)));
                document.getElementById('dash-body').innerHTML = renderAlerts(f);
            };
        }

        function renderAlerts(list) {
            if (list.length === 0) return '<tr><td colspan="3" style="text-align:center;">Aucune alerte</td></tr>';
            return list.map(p => `<tr><td><strong>${p.name}</strong></td><td>${p.reference}</td><td><span class="badge badge-danger">${p.quantity || 0}</span></td></tr>`).join('');
        }

        function renderProds() {
            const tbody = document.getElementById('prod-body');
            if (!tbody) return;
            
            tbody.innerHTML = products.map(p => {
                let imgHtml = '<div style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:30px;margin:auto;">üì¶</div>';
                
                if (p.imageUrl) {
                    const convertedUrl = convertGoogleDriveUrl(p.imageUrl);
                    
                    if (convertedUrl) {
                        imgHtml = `<img src="${convertedUrl}" 
                                        style="width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;display:block;margin:auto;" 
                                        onclick="zoomImg('${convertedUrl.replace(/'/g, "\\'")}')"
                                        onerror="this.onerror=null;this.outerHTML='<div style=\\'width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:30px;margin:auto;\\'>üì¶</div>';"
                                        alt="${p.name}">`;
                    }
                }
                
                return `<tr>
                    <td style="text-align:center;">${imgHtml}</td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.reference}</td>
                    <td>${p.barcode || '-'}</td>
                    <td><span class="badge badge-success">${p.quantity || 0}</span></td>
                    <td>${p.repetition || '-'}</td>
                    <td>
                        <button onclick="editProduct('${p.id}')" class="btn-edit">‚úèÔ∏è</button>
                        <button onclick="quickTransferToPdv('${p.id}')" class="btn-edit" style="background:#f59e0b;" title="Transf√©rer vers PDV">üöö</button>
                        <button onclick="deleteProduct('${p.id}')" class="btn-delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('prod-search').oninput = function() {
                const s = this.value.toLowerCase();
                const filtered = products.filter(p => 
                    p.name.toLowerCase().includes(s) || 
                    p.reference.toLowerCase().includes(s) || 
                    (p.barcode && p.barcode.toString().toLowerCase().includes(s))
                );
                
                tbody.innerHTML = filtered.map(p => {
                    let imgHtml = '<div style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:30px;margin:auto;">üì¶</div>';
                    
                    if (p.imageUrl) {
                        const convertedUrl = convertGoogleDriveUrl(p.imageUrl);
                        if (convertedUrl) {
                            imgHtml = `<img src="${convertedUrl}" 
                                            style="width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;display:block;margin:auto;" 
                                            onclick="zoomImg('${convertedUrl.replace(/'/g, "\\'")}')"
                                            onerror="this.onerror=null;this.outerHTML='<div style=\\'width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:30px;margin:auto;\\'>üì¶</div>';"
                                            alt="${p.name}">`;
                        }
                    }
                    
                    return `<tr><td style="text-align:center;">${imgHtml}</td><td><strong>${p.name}</strong></td><td>${p.reference}</td><td>${p.barcode || '-'}</td><td><span class="badge badge-success">${p.quantity || 0}</span></td><td>${p.repetition || '-'}</td><td><button onclick="editProduct('${p.id}')" class="btn-edit">‚úèÔ∏è</button><button onclick="quickTransferToPdv('${p.id}')" class="btn-edit" style="background:#f59e0b;" title="Transf√©rer vers PDV">üöö</button><button onclick="deleteProduct('${p.id}')" class="btn-delete">üóëÔ∏è</button></td></tr>`;
                }).join('');
            };
        }

        function zoomImg(url) {
            if (!url || url.trim().length === 0) {
                alert('‚ùå Aucune image disponible');
                return;
            }
            
            const cleanUrl = url.trim();
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer;';
            
            const img = document.createElement('img');
            img.src = cleanUrl;
            img.style.cssText = 'max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.5);';
            img.onerror = function() {
                overlay.remove();
                alert('‚ùå Impossible de charger l\'image.\n\nV√©rifiez que l\'image est publique sur Google Drive');
            };
            
            overlay.appendChild(img);
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'productModal') {
                document.getElementById('edit-id').value = '';
                document.getElementById('p-name').value = '';
                document.getElementById('p-ref').value = '';
                document.getElementById('p-qty').value = '0';
                document.getElementById('p-rep').value = '';
                document.getElementById('p-barcode').value = '';
                document.getElementById('p-category').value = '';
                document.getElementById('p-brand').value = '';
                document.getElementById('p-img').value = '';
            }
            if (id === 'pdvModal') {
                document.getElementById('pdv-edit-id').value = '';
                document.getElementById('pdv-name').value = '';
                document.getElementById('pdv-location').value = '';
            }
        }

        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value || Date.now().toString();
            const name = document.getElementById('p-name').value.trim();
            const reference = document.getElementById('p-ref').value.trim();
            const quantity = parseInt(document.getElementById('p-qty').value) || 0;
            const repetition = document.getElementById('p-rep').value.trim();
            const barcode = document.getElementById('p-barcode').value.trim();
            const category = document.getElementById('p-category').value.trim();
            const brand = document.getElementById('p-brand').value.trim();
            let imageUrl = document.getElementById('p-img').value.trim();
            
            // Convertir l'URL Google Drive
            if (imageUrl) {
                imageUrl = convertGoogleDriveUrl(imageUrl);
            }

            const existing = products.find(p => p.id === id);
            if (existing) {
                existing.name = name;
                existing.reference = reference;
                existing.quantity = quantity;
                existing.repetition = repetition;
                existing.barcode = barcode;
                existing.category = category;
                existing.brand = brand;
                existing.imageUrl = imageUrl;
            } else {
                products.push({
                    id,
                    name,
                    reference,
                    quantity,
                    repetition,
                    barcode,
                    category,
                    brand,
                    imageUrl,
                    pdvStock: {}
                });
            }

            save();
            closeModal('productModal');
            renderProds();
            alert('‚úÖ Produit enregistr√© avec succ√®s !');
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-ref').value = p.reference;
            document.getElementById('p-qty').value = p.quantity || 0;
            document.getElementById('p-rep').value = p.repetition || '';
            document.getElementById('p-barcode').value = p.barcode || '';
            document.getElementById('p-category').value = p.category || '';
            document.getElementById('p-brand').value = p.brand || '';
            document.getElementById('p-img').value = p.imageUrl || '';
            openModal('productModal');
        }

        function deleteProduct(id) {
            if (!confirm('Supprimer ce produit ?')) return;
            products = products.filter(p => p.id !== id);
            save();
            renderProds();
        }

        function quickTransferToPdv(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('‚ùå Produit introuvable !');
                return;
            }

            if (pdvs.length === 0) {
                alert('‚ùå Aucun point de vente disponible !\n\nVeuillez d\'abord cr√©er un PDV dans l\'onglet "Points de Vente".');
                return;
            }

            const currentStock = product.quantity || 0;
            if (currentStock === 0) {
                alert('‚ùå Stock total est √† 0 !\n\nIl n\'y a rien √† transf√©rer.');
                return;
            }

            // Cr√©er la liste des PDV
            let pdvOptions = pdvs.map((pdv, index) => `${index + 1}. ${pdv.name}`).join('\n');
            
            let choice = prompt(`üöö TRANSFERT RAPIDE - ${product.name}\n\nStock total disponible: ${currentStock}\n\nChoisissez le PDV de destination:\n\n${pdvOptions}\n\nEntrez le num√©ro du PDV:`);
            
            if (!choice) return;
            
            const pdvIndex = parseInt(choice) - 1;
            if (isNaN(pdvIndex) || pdvIndex < 0 || pdvIndex >= pdvs.length) {
                alert('‚ùå Num√©ro de PDV invalide !');
                return;
            }

            const selectedPdv = pdvs[pdvIndex];
            
            const qty = prompt(`üì¶ Quantit√© √† transf√©rer vers "${selectedPdv.name}":\n\nStock total disponible: ${currentStock}\n\nEntrez la quantit√© (ou laissez vide pour tout transf√©rer):`);
            
            if (qty === null) return;
            
            const transferQty = qty === '' ? currentStock : parseInt(qty);
            
            if (isNaN(transferQty) || transferQty <= 0) {
                alert('‚ùå Quantit√© invalide !');
                return;
            }

            if (transferQty > currentStock) {
                alert(`‚ùå Quantit√© insuffisante !\n\nStock disponible: ${currentStock}\nQuantit√© demand√©e: ${transferQty}`);
                return;
            }

            // Effectuer le transfert
            product.quantity -= transferQty;
            if (!product.pdvStock) product.pdvStock = {};
            product.pdvStock[selectedPdv.id] = (product.pdvStock[selectedPdv.id] || 0) + transferQty;

            // Enregistrer dans l'historique
            const now = new Date();
            history.push({
                date: now.toISOString(),
                productId: product.id,
                productName: product.name,
                type: 'transfer',
                quantity: transferQty,
                from: 'Stock Total',
                to: selectedPdv.name,
                user: document.getElementById('user-name').textContent
            });

            save();
            renderProds();
            
            alert(`‚úÖ Transfert r√©ussi !\n\n${transferQty} unit√©(s) transf√©r√©(es) vers "${selectedPdv.name}"\n\nNouveau stock total: ${product.quantity}\nStock ${selectedPdv.name}: ${product.pdvStock[selectedPdv.id]}`);
        }

        // Custom Select Dropdown pour Mouvements
        function toggleMovDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('mov-dropdown');
            const btn = document.getElementById('mov-select-btn');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                btn.classList.remove('open');
            } else {
                dropdown.classList.add('show');
                btn.classList.add('open');
                populateMovProductList();
                document.getElementById('mov-search-input').focus();
            }
        }

        function populateMovProductList() {
            const list = document.getElementById('mov-product-list');
            list.innerHTML = products.map(p => `
                <div class="custom-select-item" onclick="selectMovProduct('${p.id}', '${p.name.replace(/'/g, "\\'")} (${p.reference})')">
                    ${p.name} (${p.reference})
                </div>
            `).join('');
        }

        function filterMovList() {
            const search = document.getElementById('mov-search-input').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.reference.toLowerCase().includes(search) ||
                (p.barcode && p.barcode.toLowerCase().includes(search))
            );
            
            const list = document.getElementById('mov-product-list');
            list.innerHTML = filtered.map(p => `
                <div class="custom-select-item" onclick="selectMovProduct('${p.id}', '${p.name.replace(/'/g, "\\'")} (${p.reference})')">
                    ${p.name} (${p.reference})
                </div>
            `).join('');
        }

        function selectMovProduct(id, label) {
            document.getElementById('mov-product').value = id;
            document.getElementById('mov-select-btn').textContent = label;
            document.getElementById('mov-dropdown').classList.remove('show');
            document.getElementById('mov-select-btn').classList.remove('open');
        }

        // Custom Select Dropdown pour Transferts
        function toggleTransDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('trans-dropdown');
            const btn = document.getElementById('trans-select-btn');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                btn.classList.remove('open');
            } else {
                dropdown.classList.add('show');
                btn.classList.add('open');
                populateTransProductList();
                document.getElementById('trans-search-input').focus();
            }
        }

        function populateTransProductList() {
            const list = document.getElementById('trans-product-list');
            list.innerHTML = products.map(p => `
                <div class="custom-select-item" onclick="selectTransProduct('${p.id}', '${p.name.replace(/'/g, "\\'")} (${p.reference})')">
                    ${p.name} (${p.reference})
                </div>
            `).join('');
        }

        function filterTransList() {
            const search = document.getElementById('trans-search-input').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.reference.toLowerCase().includes(search) ||
                (p.barcode && p.barcode.toLowerCase().includes(search))
            );
            
            const list = document.getElementById('trans-product-list');
            list.innerHTML = filtered.map(p => `
                <div class="custom-select-item" onclick="selectTransProduct('${p.id}', '${p.name.replace(/'/g, "\\'")} (${p.reference})')">
                    ${p.name} (${p.reference})
                </div>
            `).join('');
        }

        function selectTransProduct(id, label) {
            document.getElementById('trans-product').value = id;
            document.getElementById('trans-select-btn').textContent = label;
            document.getElementById('trans-dropdown').classList.remove('show');
            document.getElementById('trans-select-btn').classList.remove('open');
        }

        // Fermer les dropdowns en cliquant ailleurs
        document.addEventListener('click', function() {
            document.querySelectorAll('.custom-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.custom-select-button').forEach(b => b.classList.remove('open'));
        });

        function renderMovForm() {
            const pdvSelect = document.getElementById('mov-pdv');
            pdvSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                pdvs.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        }

        function togglePdvSelect() {
            const type = document.getElementById('mov-type').value;
            const pdvGroup = document.getElementById('mov-pdv').closest('.form-group');
            pdvGroup.style.display = type ? 'flex' : 'none';
        }

        function addMovement(e) {
            e.preventDefault();
            const type = document.getElementById('mov-type').value;
            const productId = document.getElementById('mov-product').value;
            const pdvId = document.getElementById('mov-pdv').value;
            const quantity = parseInt(document.getElementById('mov-quantity').value);
            const payment = document.getElementById('mov-payment').value;
            const reason = document.getElementById('mov-reason').value.trim();
            const note = document.getElementById('mov-note').value.trim();

            const product = products.find(p => p.id === productId);
            const pdv = pdvs.find(v => v.id === pdvId);
            
            if (!product || !pdv) {
                alert('‚ùå Produit ou PDV invalide');
                return;
            }

            if (!product.pdvStock) product.pdvStock = {};
            if (!product.pdvStock[pdvId]) product.pdvStock[pdvId] = 0;

            if (type === 'in') {
                product.pdvStock[pdvId] += quantity;
                product.quantity = (product.quantity || 0) + quantity;
            } else if (type === 'out') {
                if (product.pdvStock[pdvId] < quantity) {
                    alert('‚ùå Stock insuffisant dans ce PDV');
                    return;
                }
                product.pdvStock[pdvId] -= quantity;
                product.quantity = (product.quantity || 0) - quantity;
            }

            movements.push({
                id: Date.now().toString(),
                type,
                product: product.name,
                productId,
                pdv: pdv.name,
                pdvId,
                quantity,
                payment,
                reason,
                note,
                date: new Date().toISOString()
            });

            save();
            e.target.reset();
            document.getElementById('mov-select-btn').textContent = 'S√©lectionner un produit...';
            document.getElementById('mov-product').value = '';
            alert(`‚úÖ Mouvement enregistr√© ! Stock ${pdv.name}: ${product.pdvStock[pdvId]}`);
        }

        function renderTransForm() {
            const fromSelect = document.getElementById('trans-from');
            const toSelect = document.getElementById('trans-to');
            
            fromSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                pdvs.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            toSelect.innerHTML = '<option value="">S√©lectionner...</option>' + 
                pdvs.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        }

        function addTransfer(e) {
            e.preventDefault();
            const productId = document.getElementById('trans-product').value;
            const fromId = document.getElementById('trans-from').value;
            const toId = document.getElementById('trans-to').value;
            const quantity = parseInt(document.getElementById('trans-quantity').value);
            const note = document.getElementById('trans-note').value.trim();

            if (fromId === toId) {
                alert('‚ùå Source et destination doivent √™tre diff√©rentes');
                return;
            }

            const product = products.find(p => p.id === productId);
            const fromPdv = pdvs.find(v => v.id === fromId);
            const toPdv = pdvs.find(v => v.id === toId);

            if (!product || !fromPdv || !toPdv) {
                alert('‚ùå S√©lection invalide');
                return;
            }

            if (!product.pdvStock) product.pdvStock = {};
            if (!product.pdvStock[fromId]) product.pdvStock[fromId] = 0;
            if (!product.pdvStock[toId]) product.pdvStock[toId] = 0;

            if (product.pdvStock[fromId] < quantity) {
                alert('‚ùå Stock insuffisant dans le PDV source');
                return;
            }

            product.pdvStock[fromId] -= quantity;
            product.pdvStock[toId] += quantity;

            movements.push({
                id: Date.now().toString(),
                type: 'transfer',
                product: product.name,
                productId,
                from: fromPdv.name,
                to: toPdv.name,
                fromId,
                toId,
                quantity,
                note,
                date: new Date().toISOString()
            });

            save();
            e.target.reset();
            document.getElementById('trans-select-btn').textContent = 'S√©lectionner un produit...';
            document.getElementById('trans-product').value = '';
            alert(`‚úÖ Transfert r√©ussi ! ${fromPdv.name} ‚Üí ${toPdv.name}`);
        }

        function renderPdv() {
            const searchTerm = document.getElementById('pdv-search')?.value.toLowerCase() || '';
            const thead = document.getElementById('pdv-table-header');
            const tbody = document.getElementById('pdv-products-table');
            
            if (!thead || !tbody) return;
            
            // Cr√©er l'en-t√™te avec une colonne par PDV
            thead.innerHTML = `
                <tr>
                    <th>Produit</th>
                    <th>R√©f√©rence</th>
                    <th>QTY Total</th>
                    ${pdvs.map(pdv => `<th style="color:#667eea;">üè™ ${pdv.name}</th>`).join('')}
                </tr>
            `;
            
            // Filtrer les produits
            const filtered = products.filter(p => {
                if (!searchTerm) return true;
                return p.name.toLowerCase().includes(searchTerm) || 
                       p.reference.toLowerCase().includes(searchTerm);
            });
            
            // Afficher les r√©sultats
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${3 + pdvs.length}" style="text-align:center;padding:30px;color:#6b7280;">Aucun produit trouv√©</td></tr>`;
                return;
            }
            
            tbody.innerHTML = filtered.map(product => {
                const pdvColumns = pdvs.map(pdv => {
                    const qty = product.pdvStock?.[pdv.id] || 0;
                    return `<td style="text-align:center;">
                        ${qty > 0 ? 
                            `<span style="background:#3b82f6;color:white;padding:6px 14px;border-radius:8px;font-weight:bold;">${qty}</span>` : 
                            '<span style="color:#9ca3af;">-</span>'}
                    </td>`;
                }).join('');
                
                return `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.reference}</td>
                        <td><span class="badge badge-success">${product.quantity || 0}</span></td>
                        ${pdvColumns}
                    </tr>
                `;
            }).join('');
        }

        function savePdv(e) {
            e.preventDefault();
            const id = document.getElementById('pdv-edit-id').value || Date.now().toString();
            const name = document.getElementById('pdv-name').value.trim();
            const location = document.getElementById('pdv-location').value.trim();

            const existing = pdvs.find(p => p.id === id);
            if (existing) {
                existing.name = name;
                existing.location = location;
            } else {
                pdvs.push({ id, name, location });
            }

            save();
            closeModal('pdvModal');
            renderPdv();
            alert('‚úÖ PDV enregistr√© !');
        }

        function editPdv(id) {
            const p = pdvs.find(x => x.id === id);
            if (!p) return;
            document.getElementById('pdv-edit-id').value = p.id;
            document.getElementById('pdv-name').value = p.name;
            document.getElementById('pdv-location').value = p.location || '';
            openModal('pdvModal');
        }

        function delPdv(id) {
            if (!confirm('Supprimer ce PDV ?')) return;
            pdvs = pdvs.filter(p => p.id !== id);
            save();
            renderPdv();
        }

        function renderHist() {
            const years = getYrs();
            document.getElementById('hy').innerHTML = '<option value="">Toutes les ann√©es</option>' + 
                years.map(y => `<option value="${y}">${y}</option>`).join('');
            filtHist();
            
            ['hs', 'hd', 'hm', 'hy'].forEach(id => {
                document.getElementById(id).addEventListener('input', filtHist);
            });
        }

        function filtHist() {
            const s = document.getElementById('hs').value.toLowerCase();
            const d = document.getElementById('hd').value;
            const m = document.getElementById('hm').value;
            const y = document.getElementById('hy').value;
            
            const sorted = [...movements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const filtered = sorted.filter(mov => {
                const date = new Date(mov.date);
                const matchSearch = !s || mov.product.toLowerCase().includes(s) || 
                    (mov.reason && mov.reason.toLowerCase().includes(s)) ||
                    (mov.note && mov.note.toLowerCase().includes(s));
                const matchDate = !d || date.toISOString().split('T')[0] === d;
                const matchMonth = !m || date.getMonth() === parseInt(m);
                const matchYear = !y || date.getFullYear() === parseInt(y);
                return matchSearch && matchDate && matchMonth && matchYear;
            });

            document.getElementById('hist-body').innerHTML = renderHistTable(filtered);
        }

        function renderHistTable(list) {
            if (!list || list.length === 0) return '<tr><td colspan="7" style="text-align:center;">Aucun mouvement</td></tr>';
            return list.map(m => {
                const ic = m.type === 'in' ? '‚ûï' : m.type === 'transfer' ? 'üîÑ' : '‚ûñ';
                const cl = m.type === 'in' ? '#10b981' : m.type === 'transfer' ? '#f59e0b' : '#ef4444';
                const tp = m.type === 'in' ? 'Entr√©e' : m.type === 'transfer' ? 'Transfert' : 'Sortie';
                const detail = m.type === 'transfer' ? `${m.from} ‚Üí ${m.to}` : (m.pdv || '-') + ' / ' + (m.payment || '-');
                return `<tr>
                    <td>${new Date(m.date).toLocaleString('fr-FR')}</td>
                    <td><span style="color:${cl};font-weight:bold;">${ic} ${tp}</span></td>
                    <td>${m.reason || '-'}</td>
                    <td><strong>${m.product}</strong></td>
                    <td><strong style="color:${cl};">${m.quantity}</strong></td>
                    <td>${detail}</td>
                    <td>${m.note || '-'}</td>
                </tr>`;
            }).join('');
        }

        function getYrs() {
            const y = new Set();
            movements.forEach(m => y.add(new Date(m.date).getFullYear()));
            return Array.from(y).sort((a, b) => b - a);
        }

        function rstHist() {
            document.getElementById('hs').value = '';
            document.getElementById('hd').value = '';
            document.getElementById('hm').value = '';
            document.getElementById('hy').value = '';
            filtHist();
        }

        function exportToExcel() {
            const data = products.map(p => {
                const row = {
                    'IMAGE': p.imageUrl || '',
                    'Real Name': p.realName || p.name,
                    'Conventional Name': p.conventionalName || '',
                    'R√©f√©rence': p.reference,
                    'Barcode': p.barcode || '',
                    'Repetition': p.repetition || '',
                    'Category': p.category || '',
                    'Brand': p.brand || ''
                };

                pdvs.forEach(pdv => {
                    row[`QTY ${pdv.name}`] = p.pdvStock?.[pdv.id] || 0;
                });

                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produits');
            XLSX.writeFile(wb, `stock_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);

                    console.log('üìä Import Excel - Nombre de lignes:', rows.length);
                    if (rows.length > 0) {
                        console.log('üìã Colonnes d√©tect√©es:', Object.keys(rows[0]));
                    }

                    let imported = 0;
                    let updated = 0;

                    rows.forEach((r, index) => {
                        let imageUrl = (r['IMAGE'] || r['Image'] || '').toString().trim();
                        const realName = (r['Real Name'] || r['RealName'] || '').toString().trim();
                        const conventionalName = (r['Conventional Name'] || r['ConventionalName'] || '').toString().trim();
                        const reference = (r['R√©f√©rence'] || r['Reference'] || '').toString().trim();
                        const barcode = (r['Barcode'] || '').toString().trim();
                        const repetition = (r['Repetition'] || r['R√©p√©tition'] || '').toString().trim();
                        const category = (r['Category'] || r['Cat√©gorie'] || '').toString().trim();
                        const brand = (r['Brand'] || r['Marque'] || '').toString().trim();

                        const name = realName || conventionalName;
                        
                        if (!name || !reference) {
                            console.log(`‚ö†Ô∏è Ligne ${index + 2} ignor√©e: nom ou r√©f√©rence manquant`);
                            return;
                        }

                        // Convertir l'URL Google Drive
                        if (imageUrl) {
                            imageUrl = convertGoogleDriveUrl(imageUrl);
                            console.log(`üñºÔ∏è Ligne ${index + 2} - Image convertie pour ${name}`);
                        }

                        const pdvStock = {};
                        let totalQty = 0;

                        // Rechercher toutes les colonnes qui contiennent "QTY" ou "qty"
                        Object.keys(r).forEach(key => {
                            const keyLower = key.toLowerCase();
                            
                            // D√©tecter les colonnes QTY (plusieurs formats possibles)
                            if (keyLower.includes('qty') || keyLower.startsWith('q ')) {
                                const qty = parseInt(r[key]) || 0;
                                
                                if (qty > 0) {
                                    // Extraire le nom du PDV de la colonne
                                    let pdvName = key.replace(/^QTY\s*/i, '').replace(/^qty\s*/i, '').trim();
                                    
                                    if (pdvName) {
                                        // Chercher le PDV existant
                                        let pdv = pdvs.find(p => 
                                            p.name.toLowerCase() === pdvName.toLowerCase() ||
                                            p.name.toLowerCase().includes(pdvName.toLowerCase()) ||
                                            pdvName.toLowerCase().includes(p.name.toLowerCase())
                                        );

                                        // Si le PDV n'existe pas, le cr√©er
                                        if (!pdv) {
                                            const newPdvId = pdvName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                                            pdv = { id: newPdvId, name: pdvName, location: '' };
                                            pdvs.push(pdv);
                                            console.log(`‚úÖ Nouveau PDV cr√©√©: ${pdvName} (ID: ${newPdvId})`);
                                        }

                                        if (pdv) {
                                            pdvStock[pdv.id] = qty;
                                            totalQty += qty;
                                            console.log(`üì¶ ${name} - ${pdv.name}: ${qty} unit√©s`);
                                        }
                                    }
                                }
                            }
                        });

                        const existing = products.find(p => p.reference === reference);
                        
                        if (existing) {
                            existing.name = name;
                            existing.realName = realName;
                            existing.conventionalName = conventionalName;
                            existing.imageUrl = imageUrl;
                            existing.barcode = barcode;
                            existing.repetition = repetition;
                            existing.category = category;
                            existing.brand = brand;
                            existing.pdvStock = pdvStock;
                            existing.quantity = totalQty;
                            updated++;
                            console.log(`üîÑ Produit mis √† jour: ${name} (${reference})`);
                        } else {
                            products.push({
                                id: Date.now().toString() + Math.random(),
                                name,
                                realName,
                                conventionalName,
                                reference,
                                barcode,
                                repetition,
                                category,
                                brand,
                                imageUrl,
                                quantity: totalQty,
                                pdvStock
                            });
                            imported++;
                            console.log(`‚ûï Nouveau produit: ${name} (${reference})`);
                        }
                    });

                    save();
                    renderProds();
                    renderPdv();
                    
                    let message = '‚úÖ Import termin√© !\n\n';
                    if (imported > 0) message += `‚ûï ${imported} nouveau(x) produit(s)\n`;
                    if (updated > 0) message += `üîÑ ${updated} produit(s) mis √† jour\n`;
                    message += `\nüìç ${pdvs.length} point(s) de vente d√©tect√©(s)`;
                    
                    console.log('üìä R√©sum√©:', { imported, updated, totalPdvs: pdvs.length });
                    alert(message);
                } catch (err) {
                    console.error('‚ùå Erreur import:', err);
                    alert('‚ùå Erreur lors de l\'import : ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function logout() {
            if (confirm('Se d√©connecter ?')) {
                localStorage.removeItem('currentUser');
                showLoginPage();
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }
    </script>
</body>
</html>
